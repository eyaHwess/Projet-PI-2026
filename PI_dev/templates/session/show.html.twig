{% extends 'base.html.twig' %}

{% block title %}Session #{{ session.id }}{% endblock %}

{% block stylesheets %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
    <style>
        :root {
            --pastel-blue: #A8D8EA;
            --pastel-blue-light: #E8F6F9;
            --pastel-pink: #FFE4E9;
            --pastel-pink-dark: #FFB3C1;
            --pastel-yellow: #FFF4B8;
            --pastel-yellow-light: #FFFBEA;
            --pastel-green: #B5EAD7;
            --pastel-green-light: #E8F8F3;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #F8FCFE 0%, #F0F8FF 100%);
            min-height: 100vh;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .animate-fade-in {
            animation: fadeInUp 0.6s ease-out;
        }
        
        /* Header */
        .page-header {
            background: linear-gradient(135deg, var(--pastel-blue-light) 0%, #F0F8FF 50%, var(--pastel-pink) 100%);
            padding: 2rem 0;
            margin-bottom: 2rem;
            border-radius: 0 0 2rem 2rem;
            box-shadow: 0 4px 20px rgba(168, 216, 234, 0.15);
        }
        
        /* Session Card */
        .session-card {
            background: white;
            border: 2px solid var(--pastel-blue-light);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 8px 28px rgba(168, 216, 234, 0.15);
            margin-bottom: 2rem;
            animation: slideIn 0.5s ease-out;
        }
        
        .session-title {
            font-size: 1.75rem;
            font-weight: 800;
            color: #2C5F7F;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .session-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pastel-blue), #B8E6F0);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .info-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        
        .info-row:hover {
            background: var(--pastel-blue-light);
            transform: translateX(5px);
        }
        
        .info-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        
        .info-label {
            font-weight: 700;
            color: #2C5F7F;
            min-width: 120px;
        }
        
        .info-value {
            color: #5A7C8F;
            flex: 1;
        }
        
        /* Status Badge */
        .status-badge {
            padding: 0.625rem 1.5rem;
            border-radius: 50px;
            font-weight: 700;
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .status-scheduling {
            background: linear-gradient(135deg, var(--pastel-yellow), var(--pastel-yellow-light));
            color: #8B7355;
        }
        
        .status-proposed {
            background: linear-gradient(135deg, var(--pastel-blue), #B8E6F0);
            color: #2C5F7F;
        }
        
        .status-confirmed {
            background: linear-gradient(135deg, var(--pastel-green), #C8F2E3);
            color: #2D6A5C;
        }
        
        .status-completed {
            background: linear-gradient(135deg, var(--pastel-pink-dark), #FFD1DC);
            color: #8B5F7A;
        }
        
        .status-cancelled {
            background: linear-gradient(135deg, #FFB3B3, #FFD1D1);
            color: #8B5F5F;
        }
        
        /* Timeline */
        .timeline-card {
            background: white;
            border: 2px solid var(--pastel-blue-light);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 8px 28px rgba(168, 216, 234, 0.15);
            animation: slideIn 0.6s ease-out;
        }
        
        .timeline-header {
            font-size: 1.5rem;
            font-weight: 800;
            color: #2C5F7F;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .timeline {
            position: relative;
            padding-left: 3rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 20px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, var(--pastel-blue), var(--pastel-pink-dark));
            border-radius: 10px;
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 2.5rem;
            animation: fadeInUp 0.5s ease-out;
        }
        
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -2.35rem;
            top: 0;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: white;
            border: 4px solid;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.8);
            z-index: 2;
        }
        
        .timeline-item.completed::before {
            border-color: var(--pastel-green);
            background: var(--pastel-green);
        }
        
        .timeline-item.pending::before {
            border-color: var(--pastel-blue-light);
            background: white;
        }
        
        .timeline-content {
            background: linear-gradient(135deg, #FAFCFE, #F8FCFE);
            border: 2px solid;
            border-radius: 1.25rem;
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
        }
        
        .timeline-content:hover {
            transform: translateX(8px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        
        .timeline-content.blue {
            border-color: var(--pastel-blue);
            background: linear-gradient(135deg, var(--pastel-blue-light), #F8FCFE);
        }
        
        .timeline-content.pink {
            border-color: var(--pastel-pink-dark);
            background: linear-gradient(135deg, var(--pastel-pink), #FFF9FB);
        }
        
        .timeline-content.yellow {
            border-color: #F4D03F;
            background: linear-gradient(135deg, var(--pastel-yellow-light), #FFFEF5);
        }
        
        .timeline-content.green {
            border-color: var(--pastel-green);
            background: linear-gradient(135deg, var(--pastel-green-light), #F0FAF7);
        }
        
        .timeline-icon {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
            margin-bottom: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .timeline-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #2C5F7F;
            margin-bottom: 0.5rem;
        }
        
        .timeline-date {
            color: #5A7C8F;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .timeline-description {
            color: #8B9DAF;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--pastel-blue-light);
        }
        
        .btn-action {
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 700;
            font-size: 0.95rem;
            transition: all 0.3s;
            border: 2px solid;
            display: inline-flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .btn-primary-action {
            background: linear-gradient(135deg, var(--pastel-blue), #B8E6F0);
            border-color: var(--pastel-blue);
            color: #2C5F7F;
        }
        
        .btn-primary-action:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 24px rgba(168, 216, 234, 0.4);
            color: #2C5F7F;
        }
        
        .btn-danger-action {
            background: white;
            border-color: #FFB3B3;
            color: #8B5F5F;
        }
        
        .btn-danger-action:hover {
            background: linear-gradient(135deg, #FFB3B3, #FFD1D1);
            color: #8B5F5F;
            transform: translateY(-3px);
        }
        
        .btn-back {
            background: white;
            border: 2px solid var(--pastel-blue-light);
            color: #5A7C8F;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-back:hover {
            border-color: var(--pastel-blue);
            color: #2C5F7F;
            background: var(--pastel-blue-light);
            transform: translateX(-5px);
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .session-card, .timeline-card {
                padding: 1.5rem;
            }
            
            .timeline {
                padding-left: 2.5rem;
            }
            
            .timeline::before {
                left: 15px;
            }
            
            .timeline-item::before {
                left: -2.1rem;
            }
        }
    </style>
{% endblock %}

{% block body %}
    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <a href="{{ path('app_session_index') }}" class="btn-back mb-3">
                <i class="bi bi-arrow-left"></i>
                Retour aux sessions
            </a>
        </div>
    </div>

    <section class="pb-5">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 mx-auto">
                    <!-- Session Info Card -->
                    <div class="session-card animate-fade-in">
                        <div class="session-title">
                            <div class="session-icon">
                                <i class="bi bi-calendar-check-fill"></i>
                            </div>
                            Session #{{ session.id }}
                        </div>

                        <div class="info-row">
                            <div class="info-icon" style="background: linear-gradient(135deg, var(--pastel-blue), #B8E6F0); color: white;">
                                <i class="bi bi-person-badge"></i>
                            </div>
                            <span class="info-label">{% if isCoach %}Client :{% else %}Coach :{% endif %}</span>
                            <span class="info-value">
                                {% if isCoach %}
                                    {{ session.coachingRequest.user.firstName }} {{ session.coachingRequest.user.lastName }}
                                {% else %}
                                    {{ session.coachingRequest.coach.firstName }} {{ session.coachingRequest.coach.lastName }}
                                {% endif %}
                            </span>
                        </div>

                        <div class="info-row">
                            <div class="info-icon" style="background: linear-gradient(135deg, var(--pastel-pink-dark), #FFD1DC); color: white;">
                                <i class="bi bi-flag-fill"></i>
                            </div>
                            <span class="info-label">Statut :</span>
                            <span class="info-value">
                                <span class="status-badge 
                                    {% if session.status == 'scheduling' %}status-scheduling
                                    {% elseif session.status == 'proposed_by_coach' or session.status == 'proposed_by_user' %}status-proposed
                                    {% elseif session.status == 'confirmed' %}status-confirmed
                                    {% elseif session.status == 'completed' %}status-completed
                                    {% elseif session.status == 'cancelled' %}status-cancelled
                                    {% else %}status-scheduling{% endif %}">
                                    <i class="bi bi-circle-fill" style="font-size: 0.6rem;"></i>
                                    {% if session.status == 'scheduling' %}
                                        {% if isCoach %}En attente de votre proposition{% else %}En attente du coach{% endif %}
                                    {% elseif session.status == 'proposed_by_user' %}Créneau proposé par vous
                                    {% elseif session.status == 'proposed_by_coach' %}Créneau proposé par le coach
                                    {% elseif session.status == 'confirmed' %}Confirmée
                                    {% elseif session.status == 'completed' %}Terminée
                                    {% elseif session.status == 'cancelled' %}Annulée
                                    {% else %}{{ session.status }}{% endif %}
                                </span>
                            </span>
                        </div>

                        {% if session.displayTime %}
                            <div class="info-row">
                                <div class="info-icon" style="background: linear-gradient(135deg, var(--pastel-yellow), var(--pastel-yellow-light)); color: #8B7355;">
                                    <i class="bi bi-calendar3"></i>
                                </div>
                                <span class="info-label">Date / heure :</span>
                                <span class="info-value">{{ session.displayTime|date('d/m/Y à H:i') }}</span>
                            </div>
                        {% endif %}

                        {% if session.duration %}
                            <div class="info-row">
                                <div class="info-icon" style="background: linear-gradient(135deg, var(--pastel-green), #C8F2E3); color: white;">
                                    <i class="bi bi-clock"></i>
                                </div>
                                <span class="info-label">Durée :</span>
                                <span class="info-value">{{ session.duration }} minutes</span>
                            </div>
                        {% endif %}

                        {% set sessionPrice = session.price ?? session.coachingRequest.budget ?? 50 %}
                        <div class="info-row">
                            <div class="info-icon" style="background: linear-gradient(135deg, #9AE6B0, #C8F2E3); color: white;">
                                <i class="bi bi-currency-euro"></i>
                            </div>
                            <span class="info-label">Prix :</span>
                            <span class="info-value">
                                {% if session.isPaid %}
                                    <span class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Payé</span> ({{ sessionPrice|number_format(2, ',', ' ') }} €)
                                {% else %}
                                    {{ sessionPrice|number_format(2, ',', ' ') }} €
                                {% endif %}
                            </span>
                        </div>

                        {% set showPayBtn = not isCoach and not session.isPaid and session.status not in ['cancelled'] %}
                        {% set showScheduleBtns = session.status not in ['confirmed', 'completed', 'cancelled'] %}
                        {% if showPayBtn or showScheduleBtns %}
                            <div class="action-buttons">
                                {% if showPayBtn %}
                                    <a href="{{ path('app_payment_checkout', { id: session.id }) }}" class="btn-action btn-primary-action" style="background: linear-gradient(135deg, #22c55e, #16a34a); border-color: #22c55e;">
                                        <i class="bi bi-credit-card"></i>
                                        Payer la session ({{ sessionPrice|number_format(2, ',', ' ') }} €)
                                    </a>
                                {% endif %}
                                {% if showScheduleBtns %}
                                    <a href="{{ path('app_session_schedule', { id: session.id }) }}" class="btn-action btn-primary-action">
                                        <i class="bi bi-calendar-event"></i>
                                        {% if session.status == 'scheduling' %}Proposer un créneau{% else %}Modifier le créneau{% endif %}
                                    </a>
                                    {% if (session.status == 'proposed_by_coach' and isCoach) or (session.status == 'proposed_by_user' and not isCoach) %}
                                        <form method="post" action="{{ path('app_session_clear_slot', { id: session.id }) }}" class="d-inline" onsubmit="return confirm('Supprimer le créneau proposé ?');">
                                            <input type="hidden" name="_token" value="{{ csrf_token('clear-slot' ~ session.id) }}">
                                            <button type="submit" class="btn-action btn-danger-action">
                                                <i class="bi bi-trash"></i>
                                                Supprimer le créneau
                                            </button>
                                        </form>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- Timeline Card -->
                    <div class="timeline-card">
                        <div class="timeline-header">
                            <i class="bi bi-clock-history" style="color: var(--pastel-blue);"></i>
                            Historique des actions
                        </div>

                        <div class="timeline">
                            <!-- Date de demande -->
                            <div class="timeline-item completed" style="animation-delay: 0.1s;">
                                <div class="timeline-content blue">
                                    <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-blue), #B8E6F0);">
                                        <i class="bi bi-send-fill"></i>
                                    </div>
                                    <div class="timeline-title">Demande envoyée</div>
                                    <div class="timeline-date">
                                        <i class="bi bi-calendar-event"></i>
                                        {{ session.coachingRequest.createdAt|date('d/m/Y à H:i') }}
                                    </div>
                                    <div class="timeline-description">
                                        La demande de coaching a été envoyée au coach
                                    </div>
                                </div>
                            </div>

                            <!-- Date de planification -->
                            {% if session.status in ['proposed_by_coach', 'proposed_by_user', 'confirmed', 'completed'] %}
                                <div class="timeline-item completed" style="animation-delay: 0.2s;">
                                    <div class="timeline-content yellow">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-yellow), #F4D03F);">
                                            <i class="bi bi-calendar-plus"></i>
                                        </div>
                                        <div class="timeline-title">Créneau proposé</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-calendar-event"></i>
                                            {% if session.proposedTimeByCoach %}
                                                {{ session.proposedTimeByCoach|date('d/m/Y à H:i') }}
                                            {% elseif session.proposedTimeByUser %}
                                                {{ session.proposedTimeByUser|date('d/m/Y à H:i') }}
                                            {% else %}
                                                {{ session.createdAt|date('d/m/Y à H:i') }}
                                            {% endif %}
                                        </div>
                                        <div class="timeline-description">
                                            {% if session.status == 'proposed_by_coach' %}
                                                Le coach a proposé un créneau horaire pour la session
                                            {% elseif session.status == 'proposed_by_user' %}
                                                Vous avez proposé un créneau horaire pour la session
                                            {% else %}
                                                Un créneau horaire a été proposé pour la session
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="timeline-item pending" style="animation-delay: 0.2s;">
                                    <div class="timeline-content yellow">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-yellow-light), #FFF9C4); color: #8B7355;">
                                            <i class="bi bi-hourglass-split"></i>
                                        </div>
                                        <div class="timeline-title">{% if isCoach %}En attente de votre proposition{% else %}En attente du coach{% endif %}</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-clock"></i>
                                            En attente
                                        </div>
                                        <div class="timeline-description">
                                            {% if isCoach %}
                                                Vous devez proposer un créneau horaire pour cette session
                                            {% else %}
                                                Le coach doit proposer un créneau horaire pour cette session
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Date de confirmation -->
                            {% if session.status in ['confirmed', 'completed'] %}
                                <div class="timeline-item completed" style="animation-delay: 0.3s;">
                                    <div class="timeline-content green">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-green), #C8F2E3);">
                                            <i class="bi bi-check-circle-fill"></i>
                                        </div>
                                        <div class="timeline-title">Session confirmée</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-calendar-event"></i>
                                            {% if session.confirmedAt %}
                                                {{ session.confirmedAt|date('d/m/Y à H:i') }}
                                            {% else %}
                                                {{ session.updatedAt|date('d/m/Y à H:i') }}
                                            {% endif %}
                                        </div>
                                        <div class="timeline-description">
                                            La session a été confirmée par les deux parties
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="timeline-item pending" style="animation-delay: 0.3s;">
                                    <div class="timeline-content green">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-green-light), #E8F8F3); color: #2D6A5C;">
                                            <i class="bi bi-hourglass-split"></i>
                                        </div>
                                        <div class="timeline-title">En attente de confirmation</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-clock"></i>
                                            En attente
                                        </div>
                                        <div class="timeline-description">
                                            La session doit être confirmée
                                        </div>
                                    </div>
                                </div>
                            {% endif %}

                            <!-- Date de fin -->
                            {% if session.status == 'completed' %}
                                <div class="timeline-item completed" style="animation-delay: 0.4s;">
                                    <div class="timeline-content pink">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-pink-dark), #FFD1DC);">
                                            <i class="bi bi-trophy-fill"></i>
                                        </div>
                                        <div class="timeline-title">Session terminée</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-calendar-event"></i>
                                            {% if session.completedAt %}
                                                {{ session.completedAt|date('d/m/Y à H:i') }}
                                            {% else %}
                                                {{ session.updatedAt|date('d/m/Y à H:i') }}
                                            {% endif %}
                                        </div>
                                        <div class="timeline-description">
                                            La session de coaching a été complétée avec succès
                                        </div>
                                    </div>
                                </div>
                            {% else %}
                                <div class="timeline-item pending" style="animation-delay: 0.4s;">
                                    <div class="timeline-content pink">
                                        <div class="timeline-icon" style="background: linear-gradient(135deg, var(--pastel-pink), #FFF0F3); color: #8B5F7A;">
                                            <i class="bi bi-hourglass-split"></i>
                                        </div>
                                        <div class="timeline-title">À venir</div>
                                        <div class="timeline-date">
                                            <i class="bi bi-clock"></i>
                                            En attente
                                        </div>
                                        <div class="timeline-description">
                                            La session sera marquée comme terminée une fois complétée
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
