{% extends 'base.html.twig' %}

{% block title %}Chatroom - {{ goal.title }}{% endblock %}

{% block stylesheets %}
<style>
    body {
        background: linear-gradient(135deg, #8b9dc3 0%, #dfe3ee 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        overflow: hidden;
    }

    .chat-container {
        background: #f5f7fa;
        border-radius: 24px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        max-width: 1600px;
        width: 95%;
        height: 90vh;
        display: flex;
        overflow: hidden;
        position: relative;
    }

    /* Sidebar - Liste des participants */
    .chat-sidebar {
        width: 280px;
        background: #ffffff;
        border-right: 1px solid #e8ecf1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        position: relative;
    }

    .search-box {
        position: relative;
        margin-bottom: 25px;
    }

    .search-box input {
        width: 100%;
        padding: 12px 45px 12px 18px;
        border: none;
        background: #f5f7fa;
        border-radius: 12px;
        font-size: 14px;
        transition: all 0.3s;
        color: #6b7280;
    }

    .search-box input:focus {
        outline: none;
        background: #eef1f6;
        transform: translateY(-1px);
    }

    .search-box input::placeholder {
        color: #9ca3af;
    }

    .search-box i {
        position: absolute;
        right: 18px;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        transition: all 0.3s;
        font-size: 14px;
    }

    .search-box input:focus + i {
        color: #8b9dc3;
    }

    .participants-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 5px;
    }

    .participants-list::-webkit-scrollbar {
        width: 4px;
    }

    .participants-list::-webkit-scrollbar-track {
        background: transparent;
    }

    .participants-list::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
    }

    .no-participants-found {
        text-align: center;
        padding: 40px 20px;
        color: #9ca3af;
        display: none;
    }

    .no-participants-found i {
        font-size: 48px;
        margin-bottom: 16px;
        display: block;
        color: #d1d5db;
    }

    .no-participants-found .message {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
    }

    .no-participants-found .search-term {
        font-size: 13px;
        color: #6b7280;
        font-style: italic;
    }

    .participant-item {
        display: flex;
        align-items: center;
        padding: 12px;
        margin-bottom: 4px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: transparent;
        position: relative;
    }

    .participant-item::before {
        display: none;
    }

    .participant-item:hover {
        background: #f5f7fa;
        transform: translateX(4px);
    }

    .participant-item.active {
        background: #eef2f8;
    }

    .participant-item.active::before {
        display: none;
    }

    .participant-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 600;
        margin-right: 12px;
        position: relative;
        flex-shrink: 0;
        transition: all 0.2s;
    }

    .participant-item:hover .participant-avatar {
        transform: scale(1.05);
    }

    .participant-avatar.online::after {
        content: '';
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background: #10b981;
        border: 2px solid white;
        border-radius: 50%;
    }

    @keyframes pulse-online {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.1);
        }
    }

    .participant-info {
        flex: 1;
        min-width: 0;
    }

    .participant-name {
        font-weight: 600;
        color: #1f2937;
        font-size: 15px;
        margin-bottom: 2px;
    }

    .participant-message {
        color: #9ca3af;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 400;
    }

    .participant-meta {
        text-align: right;
        flex-shrink: 0;
        margin-left: 12px;
    }

    .participant-time {
        color: #9ca3af;
        font-size: 11px;
        margin-bottom: 4px;
        font-weight: 500;
    }

    .unread-badge {
        background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
        color: white;
        border-radius: 12px;
        min-width: 24px;
        height: 24px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
        padding: 0 8px;
        box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
    }

    .role-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-left: 8px;
    }

    .role-badge.owner {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
        box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
    }

    .role-badge.admin {
        background: linear-gradient(135deg, #8b9dc3 0%, #6b7fa8 100%);
        color: white;
        box-shadow: 0 2px 8px rgba(139, 157, 195, 0.3);
    }

    .role-badge.member {
        background: #e5e7eb;
        color: #6b7280;
    }

    /* Chat Area */
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #f5f7fa;
        position: relative;
    }

    /* Group Info Sidebar */
    .group-info-sidebar {
        width: 320px;
        background: #ffffff;
        border-left: 1px solid #e8ecf1;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .group-info-header {
        padding: 20px;
        border-bottom: 1px solid #e8ecf1;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .group-info-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
    }

    .group-info-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 18px;
        padding: 5px;
        transition: all 0.2s;
    }

    .group-info-close:hover {
        color: #6b7280;
        transform: rotate(90deg);
    }

    .group-info-section {
        padding: 20px;
        border-bottom: 1px solid #e8ecf1;
    }

    .group-info-section-title {
        font-size: 14px;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        cursor: pointer;
    }

    .group-info-section-title i {
        font-size: 12px;
        transition: transform 0.3s;
    }

    .group-info-section-title.collapsed i {
        transform: rotate(-90deg);
    }

    .group-info-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .group-info-item:hover {
        background: #f5f7fa;
    }

    .group-info-item i {
        font-size: 16px;
        color: #8b9dc3;
        margin-right: 12px;
        width: 20px;
        text-align: center;
    }

    .group-info-item-text {
        flex: 1;
        font-size: 14px;
        color: #1f2937;
    }

    .group-info-item-count {
        font-size: 13px;
        color: #9ca3af;
        font-weight: 600;
    }

    .group-member-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        transition: all 0.2s;
    }

    .group-member-item:hover {
        background: #f5f7fa;
    }

    .group-member-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: 600;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .group-member-info {
        flex: 1;
    }

    .group-member-name {
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 2px;
    }

    .group-member-role {
        font-size: 12px;
        color: #9ca3af;
    }

    .group-member-role.admin {
        color: #8b9dc3;
        font-weight: 600;
    }

    .group-member-actions {
        margin-left: auto;
    }

    .member-action-btn {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .member-action-btn:hover {
        background: #e5e7eb;
        color: #6b7280;
    }

    /* Member Actions Modal */
    .member-actions-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
    }

    .member-actions-modal.active {
        display: flex;
    }

    .member-actions-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: modalSlideIn 0.3s ease-out;
    }

    .member-actions-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .member-actions-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
    }

    .member-actions-close {
        background: none;
        border: none;
        font-size: 24px;
        color: #9ca3af;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        transition: all 0.2s;
    }

    .member-actions-close:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    .member-actions-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .member-action-item {
        padding: 12px 16px;
        border-radius: 8px;
        border: none;
        background: #f9fafb;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 500;
        width: 100%;
        text-align: left;
    }

    .member-action-item:hover {
        background: #f3f4f6;
        transform: translateX(4px);
    }

    .member-action-item.danger {
        color: #dc2626;
    }

    .member-action-item.danger:hover {
        background: #fee2e2;
    }

    .member-action-item i {
        width: 20px;
        text-align: center;
    }

    .shared-file-item {
        display: flex;
        align-items: center;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .shared-file-item:hover {
        background: #f5f7fa;
    }

    /* Recent Images Grid */
    #recentImagesSection {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        padding: 12px;
    }

    .recent-image-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.2s;
    }

    .recent-image-thumb {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: all 0.2s;
    }

    .recent-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s;
    }

    .recent-image-overlay i {
        color: white;
        font-size: 20px;
    }

    .recent-image-item:hover .recent-image-overlay {
        opacity: 1;
    }

    .recent-image-item:hover .recent-image-thumb {
        transform: scale(1.1);
    }

    .shared-file-icon {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        background: #eef2f8;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .shared-file-icon i {
        font-size: 18px;
        color: #8b9dc3;
    }

    .shared-file-info {
        flex: 1;
        min-width: 0;
    }

    .shared-file-name {
        font-size: 13px;
        color: #1f2937;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .shared-file-size {
        font-size: 11px;
        color: #9ca3af;
    }

    .shared-file-date {
        font-size: 11px;
        color: #9ca3af;
    }

    .chat-header {
        padding: 20px 28px;
        border-bottom: 1px solid #e8ecf1;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: white;
        position: relative;
        z-index: 5;
    }

    .chat-header::after {
        display: none;
    }

    .chat-header-info {
        display: flex;
        align-items: center;
    }

    .chat-header-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 22px;
        margin-right: 14px;
        transition: all 0.2s;
        cursor: pointer;
    }

    .chat-header-avatar:hover {
        transform: scale(1.05);
    }

    .chat-header-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .realtime-indicator {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        font-size: 11px;
        font-weight: 600;
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
        padding: 3px 8px;
        border-radius: 12px;
        animation: pulse-live 2s ease-in-out infinite;
    }

    .realtime-indicator i {
        font-size: 6px;
        animation: blink-live 1.5s ease-in-out infinite;
    }

    @keyframes pulse-live {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.7;
        }
    }

    .user-role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .user-role-badge.owner {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #78350f;
    }

    .user-role-badge.admin {
        background: linear-gradient(135deg, #8b9dc3 0%, #6b7fa8 100%);
        color: white;
    }

    .user-role-badge.member {
        background: #e5e7eb;
        color: #6b7280;
    }

    @keyframes blink-live {
        0%, 100% {
            opacity: 1;
        }
        50% {
            opacity: 0.3;
        }
    }

    .chat-header-subtitle {
        font-size: 13px;
        color: #9ca3af;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chat-header-subtitle::before {
        content: '';
        width: 6px;
        height: 6px;
        background: #10b981;
        border-radius: 50%;
        display: inline-block;
    }

    .chat-header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .search-toggle-btn {
        background: #f9fafb;
        border: 1px solid #e8ecf1;
        border-radius: 10px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        color: #8b9dc3;
        font-size: 18px;
    }

    .search-toggle-btn:hover {
        background: #eef2f8;
        border-color: #8b9dc3;
        color: #667eea;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(139, 157, 195, 0.2);
    }

    .search-toggle-btn:active {
        transform: scale(0.95);
    }

    /* Search Bar */
    .search-bar {
        background: white;
        border-bottom: 1px solid #e8ecf1;
        padding: 16px 28px;
        display: none;
        animation: slideDown 0.3s ease-out;
    }

    .search-bar.active {
        display: block;
    }

    .search-bar-content {
        display: flex;
        align-items: center;
        gap: 12px;
        background: #f9fafb;
        border: 1px solid #e8ecf1;
        border-radius: 12px;
        padding: 10px 16px;
        transition: all 0.2s;
    }

    .search-bar-content:focus-within {
        background: white;
        border-color: #8b9dc3;
        box-shadow: 0 0 0 3px rgba(139, 157, 195, 0.1);
    }

    .search-bar-icon {
        color: #8b9dc3;
        font-size: 18px;
        flex-shrink: 0;
    }

    .search-bar-input {
        flex: 1;
        border: none;
        background: transparent;
        outline: none;
        font-size: 14px;
        color: #1f2937;
    }

    .search-bar-input::placeholder {
        color: #9ca3af;
    }

    .search-bar-close {
        background: none;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 16px;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        border-radius: 6px;
    }

    .search-bar-close:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    /* Search Results */
    .search-results {
        margin-top: 12px;
        font-size: 13px;
        color: #6b7280;
        display: none;
    }

    .search-results.active {
        display: block;
    }

    .search-results-count {
        font-weight: 600;
        color: #8b9dc3;
    }

    /* Highlight */
    .highlight {
        background: #fef08a;
        color: #854d0e;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
    }

    .message-bubble.search-match {
        border: 2px solid #fbbf24;
        box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 28px;
        background: #f5f7fa;
        position: relative;
    }

    .chat-messages::before {
        display: none;
    }

    .message-group {
        margin-bottom: 25px;
    }

    .message-sent {
        display: flex;
        justify-content: flex-end;
        align-items: flex-start;
        margin-bottom: 16px;
        animation: slideInRight 0.3s ease-out;
        position: relative;
    }

    .message-received {
        display: flex;
        justify-content: flex-start;
        align-items: flex-start;
        margin-bottom: 16px;
        animation: slideInLeft 0.3s ease-out;
        position: relative;
    }

    @keyframes messagePulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.01);
        }
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
            transform: translateX(100%) translateY(100%) rotate(45deg);
        }
    }

    .message-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 16px;
        font-weight: 700;
        flex-shrink: 0;
        transition: all 0.2s;
        cursor: pointer;
        position: relative;
    }

    .message-avatar::before {
        display: none;
    }

    .message-avatar:hover {
        transform: scale(1.05);
    }

    .message-avatar:hover::before {
        display: none;
    }

    @keyframes pulse-ring {
        0% {
            transform: scale(1);
            opacity: 0.2;
        }
        100% {
            transform: scale(1.3);
            opacity: 0;
        }
    }

    .message-content {
        max-width: 65%;
        display: flex;
        flex-direction: column;
        position: relative;
    }

    .message-bubble {
        padding: 14px 18px;
        border-radius: 18px;
        margin-bottom: 6px;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.2s ease;
        position: relative;
        line-height: 1.5;
        font-size: 15px;
        font-weight: 400;
        z-index: 3;
    }

    .message-bubble:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        transform: translateY(-1px);
    }

    /* Glow effect on hover for sent messages */
    .message-sent .message-bubble:hover {
        box-shadow: 0 4px 12px rgba(139, 157, 195, 0.25);
    }

    /* Glow effect on hover for received messages */
    .message-received .message-bubble:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .message-sent .message-bubble {
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        color: white;
        border-bottom-right-radius: 4px;
        margin-left: 12px;
        position: relative;
        overflow: hidden;
    }

    .message-sent .message-bubble::before {
        display: none;
    }

    /* Shimmer effect on sent messages */
    .message-sent .message-bubble::after {
        display: none;
    }

    @keyframes shimmer {
        0% {
            transform: translateX(-100%) translateY(-100%) rotate(45deg);
        }
        100% {
            transform: translateX(100%) translateY(100%) rotate(45deg);
        }
    }

    /* Tail pointer for sent messages */
    .message-sent .message-content::after {
        display: none;
    }

    .message-sent .message-bubble:hover {
        background: linear-gradient(135deg, #9dadc9 0%, #b5c2db 100%);
    }

    .message-received .message-bubble {
        background: white;
        color: #1f2937;
        border-bottom-left-radius: 4px;
        margin-right: 12px;
        border: 1px solid #e8ecf1;
        position: relative;
        overflow: hidden;
    }

    .message-received .message-bubble::before {
        display: none;
    }

    /* Tail pointer for received messages */
    .message-received .message-content::after {
        display: none;
    }

    .message-received .message-bubble:hover {
        background: #fafbfc;
        border-color: #d1d5db;
    }

    .message-time {
        font-size: 11px;
        color: #9ca3af;
        padding: 0 12px;
        display: flex;
        align-items: center;
        gap: 5px;
        font-weight: 500;
    }

    .message-sent .message-time {
        justify-content: flex-end;
    }

    .read-status {
        display: inline-flex;
        align-items: center;
        margin-left: 4px;
    }

    .read-status i {
        font-size: 13px;
        transition: all 0.2s;
    }

    .read-status i.fa-check-double {
        animation: checkBounce 0.4s ease-out;
    }

    @keyframes checkBounce {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.2);
        }
    }

    /* Message Reactions */
    .message-reactions {
        display: flex;
        gap: 5px;
        margin-top: 8px;
        flex-wrap: wrap;
        padding: 0 12px;
        animation: fadeInUp 0.3s ease-out 0.1s both;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .reaction-btn {
        background: white;
        border: 1px solid #e8ecf1;
        border-radius: 16px;
        padding: 5px 12px;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: #6b7280;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        font-family: inherit;
    }

    .reaction-btn::before {
        display: none;
    }

    .reaction-btn:hover::before {
        display: none;
    }

    .reaction-btn:hover {
        background: #f9fafb;
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        border-color: #d1d5db;
    }

    .reaction-btn.active {
        background: #eef2f8;
        border-color: #8b9dc3;
        color: #8b9dc3;
        font-weight: 600;
        transform: scale(1.02);
    }

    .reaction-btn.active::after {
        display: none;
    }

    @keyframes pulse-reaction {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }

    .reaction-btn .count {
        font-size: 12px;
        font-weight: 700;
        min-width: 16px;
        text-align: center;
        color: #6b7280;
    }

    .reaction-btn.active .count {
        color: #8b9dc3;
    }

    .pin-btn {
        background: white;
        border: 1px solid #e8ecf1;
        border-radius: 16px;
        padding: 5px 12px;
        font-size: 13px;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #6b7280;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        position: relative;
        font-family: inherit;
    }

    .pin-btn::before {
        display: none;
    }

    .pin-btn:hover::before {
        display: none;
    }

    .pin-btn:hover {
        background: #fffbeb;
        border-color: #fbbf24;
        color: #92400e;
        transform: translateY(-2px);
        box-shadow: 0 2px 6px rgba(251, 191, 36, 0.2);
    }

    /* Pinned Message Box */
    .pinned-message-box {
        background: #fffbeb;
        border-left: 3px solid #fbbf24;
        border-radius: 10px;
        padding: 14px 18px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(251, 191, 36, 0.1);
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .pinned-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-weight: 700;
        color: #92400e;
        margin-bottom: 8px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .pinned-header i {
        margin-right: 6px;
        animation: none;
    }

    @keyframes pinRotate {
        0%, 100% {
            transform: rotate(0deg);
        }
        50% {
            transform: rotate(-10deg);
        }
    }

    .unpin-btn {
        background: rgba(146, 64, 14, 0.1);
        border: none;
        border-radius: 50%;
        width: 26px;
        height: 26px;
        cursor: pointer;
        color: #92400e;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 13px;
    }

    .unpin-btn:hover {
        background: rgba(146, 64, 14, 0.2);
        transform: scale(1.1);
    }

    .pinned-content {
        color: #92400e;
        font-size: 14px;
        line-height: 1.5;
        padding: 6px 10px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 6px;
    }

    .pinned-content strong {
        color: #78350f;
    }

    .chat-input-area {
        padding: 18px 28px;
        border-top: 1px solid #e8ecf1;
        background: white;
    }

    /* Non-member notice */
    .non-member-notice {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 24px;
        background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
        border-radius: 16px;
        border: 2px dashed #d1d5db;
    }

    .non-member-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #6b7fa8 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        flex-shrink: 0;
    }

    .non-member-content {
        flex: 1;
    }

    .non-member-title {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin: 0 0 8px 0;
    }

    .non-member-text {
        font-size: 14px;
        color: #6b7280;
        margin: 0 0 16px 0;
    }

    .btn-join-goal {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 20px;
        background: linear-gradient(135deg, #8b9dc3 0%, #6b7fa8 100%);
        color: white;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s;
        box-shadow: 0 4px 12px rgba(139, 157, 195, 0.3);
    }

    .btn-join-goal:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(139, 157, 195, 0.4);
        color: white;
        text-decoration: none;
    }

    .chat-input-wrapper {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .chat-input-container {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        border: 1px solid #e8ecf1;
        background: #f9fafb;
        border-radius: 22px;
        transition: all 0.2s;
    }

    .chat-input-container:focus-within {
        background: white;
        border-color: #8b9dc3;
        box-shadow: 0 0 0 3px rgba(139, 157, 195, 0.1);
    }

    .chat-input-avatar {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        flex-shrink: 0;
        transition: transform 0.2s;
    }

    .chat-input-avatar:hover {
        transform: scale(1.05);
    }

    .chat-input-form {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .chat-input {
        flex: 1;
        padding: 4px 8px;
        border: none;
        background: transparent;
        font-size: 14px;
        outline: none;
        transition: all 0.2s;
        color: #1f2937;
        min-width: 0;
    }

    .chat-input:focus {
        background: transparent;
        border: none;
        box-shadow: none;
    }

    .chat-input::placeholder {
        color: #9ca3af;
    }

    .chat-input-btn {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        border: none;
        background: #f9fafb;
        color: #6b7280;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        font-size: 16px;
    }

    .chat-input-btn:hover {
        background: #f3f4f6;
        transform: scale(1.05);
    }

    .chat-input-btn.send {
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        color: white;
    }

    .chat-input-btn.send:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(139, 157, 195, 0.3);
    }

    .chat-input-btn.send:active {
        transform: scale(0.95);
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
        width: 4px;
    }

    ::-webkit-scrollbar-track {
        background: transparent;
    }

    ::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #9ca3af;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .chat-sidebar {
            display: none;
        }
        
        .chat-container {
            height: 100vh;
            border-radius: 0;
        }
    }

    /* Delete Button Styling */
    .delete-message-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: rgba(239, 68, 68, 0.9);
        border: none;
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s ease;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
    }

    .message-bubble:hover .delete-message-btn {
        opacity: 1;
    }

    .delete-message-btn:hover {
        background: rgba(220, 38, 38, 1);
        transform: scale(1.1);
        box-shadow: 0 3px 10px rgba(239, 68, 68, 0.4);
    }

    .delete-message-btn:active {
        transform: scale(0.95);
    }

    /* Delete Modal */
    .delete-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .delete-modal.active {
        display: flex;
    }

    .delete-modal-content {
        background: white;
        border-radius: 16px;
        padding: 0;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
    }

    .delete-modal-header {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        padding: 24px 24px 16px;
        border-bottom: 1px solid #e8ecf1;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .delete-modal-close {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        font-size: 24px;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .delete-modal-close:hover {
        background: #f3f4f6;
        color: #6b7280;
    }

    .delete-modal-body {
        padding: 24px;
    }

    .delete-option {
        display: flex;
        align-items: flex-start;
        padding: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 12px;
        border: 2px solid transparent;
    }

    .delete-option:hover {
        background: #f9fafb;
    }

    .delete-option.selected {
        background: #eef2f8;
        border-color: #8b9dc3;
    }

    .delete-option-radio {
        width: 20px;
        height: 20px;
        border: 2px solid #d1d5db;
        border-radius: 50%;
        margin-right: 12px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .delete-option.selected .delete-option-radio {
        border-color: #8b9dc3;
        background: #8b9dc3;
    }

    .delete-option.selected .delete-option-radio::after {
        content: '';
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
    }

    .delete-option-content {
        flex: 1;
    }

    .delete-option-title {
        font-size: 15px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 4px;
    }

    .delete-option-description {
        font-size: 13px;
        color: #6b7280;
        line-height: 1.5;
    }

    .delete-modal-actions {
        padding: 16px 24px;
        border-top: 1px solid #e8ecf1;
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .delete-modal-btn {
        padding: 10px 24px;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        font-family: inherit;
    }

    .delete-modal-btn.cancel {
        background: #f3f4f6;
        color: #6b7280;
    }

    .delete-modal-btn.cancel:hover {
        background: #e5e7eb;
    }

    .delete-modal-btn.delete {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .delete-modal-btn.delete:hover {
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        transform: scale(1.05);
    }

    .delete-modal-btn.delete:active {
        transform: scale(0.95);
    }

    /* Edit Button Styling */
    .edit-message-btn {
        position: absolute;
        top: 8px;
        right: 40px;
        background: rgba(59, 130, 246, 0.9);
        border: none;
        color: white;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        cursor: pointer;
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.2s ease;
        z-index: 10;
        box-shadow: 0 2px 6px rgba(59, 130, 246, 0.3);
    }

    .message-bubble:hover .edit-message-btn {
        opacity: 1;
    }

    .edit-message-btn:hover {
        background: rgba(37, 99, 235, 1);
        transform: scale(1.1);
        box-shadow: 0 3px 10px rgba(59, 130, 246, 0.4);
    }

    .edit-message-btn:active {
        transform: scale(0.95);
    }

    /* Reply Button Styling */
    .reply-message-btn, .reply-btn {
        position: absolute;
        top: 8px;
        right: 100px;
        background: rgba(16, 185, 129, 0.9);
        border: none;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        opacity: 0;
        transition: all 0.2s ease;
        color: white;
        font-size: 12px;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
    }

    .message-bubble:hover .reply-message-btn,
    .message-bubble:hover .reply-btn {
        opacity: 1;
    }

    .reply-message-btn:hover, .reply-btn:hover {
        background: rgba(16, 185, 129, 1);
        transform: scale(1.1);
    }

    .reply-message-btn:active, .reply-btn:active {
        transform: scale(0.95);
    }

    /* Reply Reference in Message */
    .reply-reference {
        background: rgba(139, 157, 195, 0.1);
        border-left: 3px solid #8b9dc3;
        border-radius: 8px;
        padding: 8px 12px;
        margin-bottom: 8px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 13px;
    }

    .reply-reference i {
        color: #8b9dc3;
        font-size: 12px;
        margin-top: 2px;
    }

    .reply-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .reply-info strong {
        color: #8b9dc3;
        font-size: 12px;
        font-weight: 600;
    }

    .reply-preview {
        color: #6b7280;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    /* Reply Preview in Input Area */
    #replyPreview {
        background: #f3f4f6;
        border-left: 3px solid #10b981;
        border-radius: 8px;
        padding: 10px 12px;
        margin-bottom: 8px;
        animation: slideDown 0.2s ease-out;
    }

    .reply-preview-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .reply-preview-content i {
        color: #10b981;
        font-size: 14px;
    }

    .reply-preview-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .reply-preview-info strong {
        color: #10b981;
        font-size: 13px;
        font-weight: 600;
    }

    .reply-preview-info span {
        color: #6b7280;
        font-size: 12px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .reply-cancel-btn {
        background: transparent;
        border: none;
        color: #9ca3af;
        cursor: pointer;
        padding: 4px;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .reply-cancel-btn:hover {
        background: #e5e7eb;
        color: #6b7280;
    }

    /* Edited Badge */
    .edited-badge {
        display: inline-block;
        font-size: 10px;
        color: #9ca3af;
        font-style: italic;
        margin-left: 6px;
        font-weight: 500;
    }

    /* Edit Modal */
    .edit-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .edit-modal.active {
        display: flex;
    }

    .edit-modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .edit-modal-header {
        font-size: 18px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 16px;
    }

    .edit-modal-textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #e8ecf1;
        border-radius: 10px;
        font-size: 14px;
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
        margin-bottom: 16px;
    }

    .edit-modal-textarea:focus {
        outline: none;
        border-color: #8b9dc3;
        box-shadow: 0 0 0 3px rgba(139, 157, 195, 0.1);
    }

    .edit-modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
    }

    .edit-modal-btn {
        padding: 10px 20px;
        border-radius: 10px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .edit-modal-btn.cancel {
        background: #f3f4f6;
        color: #6b7280;
    }

    .edit-modal-btn.cancel:hover {
        background: #e5e7eb;
    }

    .edit-modal-btn.save {
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        color: white;
    }

    .edit-modal-btn.save:hover {
        box-shadow: 0 4px 12px rgba(139, 157, 195, 0.3);
    }

    /* Attachment Styles */
    .message-attachment {
        margin-bottom: 8px;
    }

    .attachment-image {
        max-width: 100%;
        max-height: 300px;
        border-radius: 12px;
        display: block;
        cursor: pointer;
        transition: all 0.2s;
    }

    .attachment-image:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .attachment-image-link {
        display: block;
        text-decoration: none;
    }

    .attachment-file {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        text-decoration: none;
        color: inherit;
        transition: all 0.2s;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .message-received .attachment-file {
        background: #f9fafb;
        border: 1px solid #e8ecf1;
        color: #1f2937;
    }

    .attachment-file:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateX(4px);
    }

    .message-received .attachment-file:hover {
        background: #f3f4f6;
    }

    .attachment-icon {
        font-size: 24px;
        color: #8b9dc3;
    }

    .attachment-name {
        flex: 1;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .attachment-download {
        font-size: 16px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }

    .attachment-file:hover .attachment-download {
        opacity: 1;
    }

    /* File Preview */
    .file-preview {
        padding: 0;
        margin: 0;
        display: inline-block;
    }

    .file-preview-content {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 12px;
        background: #eef2f8;
        border: 1px solid #8b9dc3;
        border-radius: 20px;
        font-size: 13px;
        max-width: 200px;
    }

    .file-preview-icon {
        font-size: 16px;
        color: #8b9dc3;
        flex-shrink: 0;
    }

    .file-preview-name {
        flex: 1;
        font-size: 12px;
        color: #1f2937;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 120px;
    }

    .file-preview-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        font-size: 14px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
        width: 18px;
        height: 18px;
    }

    .file-preview-remove:hover {
        transform: scale(1.2);
        color: #dc2626;
    }

    /* Emoji Picker */
    .emoji-picker {
        position: absolute;
        bottom: 70px;
        right: 28px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 16px;
        display: none;
        z-index: 100;
        width: 320px;
        max-height: 400px;
        overflow-y: auto;
    }

    .emoji-picker.active {
        display: block;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .emoji-picker-header {
        font-size: 14px;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 12px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e8ecf1;
    }

    .emoji-categories {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
    }

    .emoji-category-btn {
        background: #f9fafb;
        border: 1px solid #e8ecf1;
        border-radius: 8px;
        padding: 6px 12px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
        color: #6b7280;
        font-weight: 500;
    }

    .emoji-category-btn:hover {
        background: #f3f4f6;
        border-color: #8b9dc3;
    }

    .emoji-category-btn.active {
        background: #eef2f8;
        border-color: #8b9dc3;
        color: #8b9dc3;
        font-weight: 600;
    }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 4px;
    }

    .emoji-item {
        font-size: 24px;
        padding: 8px;
        cursor: pointer;
        border-radius: 8px;
        transition: all 0.2s;
        text-align: center;
        background: transparent;
        border: none;
    }

    .emoji-item:hover {
        background: #f3f4f6;
        transform: scale(1.2);
    }

    .emoji-item:active {
        transform: scale(1.1);
    }

    .emoji-picker::-webkit-scrollbar {
        width: 6px;
    }

    .emoji-picker::-webkit-scrollbar-track {
        background: transparent;
    }

    .emoji-picker::-webkit-scrollbar-thumb {
        background: #d1d5db;
        border-radius: 10px;
    }

    /* Voice Recording Interface */
    .voice-recording-interface {
        position: absolute;
        bottom: 70px;
        left: 28px;
        right: 28px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        padding: 20px;
        display: none;
        z-index: 100;
        animation: slideUp 0.3s ease-out;
    }

    .voice-recording-interface.active {
        display: block;
    }

    .voice-recording-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 16px;
    }

    .voice-recording-animation {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        height: 60px;
    }

    .voice-wave {
        width: 4px;
        background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        border-radius: 4px;
        animation: waveAnimation 1s ease-in-out infinite;
    }

    .voice-wave:nth-child(1) {
        animation-delay: 0s;
        height: 20px;
    }

    .voice-wave:nth-child(2) {
        animation-delay: 0.1s;
        height: 35px;
    }

    .voice-wave:nth-child(3) {
        animation-delay: 0.2s;
        height: 50px;
    }

    .voice-wave:nth-child(4) {
        animation-delay: 0.3s;
        height: 35px;
    }

    .voice-wave:nth-child(5) {
        animation-delay: 0.4s;
        height: 20px;
    }

    @keyframes waveAnimation {
        0%, 100% {
            transform: scaleY(1);
        }
        50% {
            transform: scaleY(1.5);
        }
    }

    .voice-recording-time {
        font-size: 24px;
        font-weight: 700;
        color: #ef4444;
        font-family: 'Courier New', monospace;
    }

    .voice-recording-actions {
        display: flex;
        gap: 12px;
    }

    .voice-btn {
        padding: 10px 24px;
        border-radius: 12px;
        border: none;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: inherit;
    }

    .voice-btn-cancel {
        background: #f3f4f6;
        color: #6b7280;
    }

    .voice-btn-cancel:hover {
        background: #e5e7eb;
        transform: scale(1.05);
    }

    .voice-btn-send {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .voice-btn-send:hover {
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        transform: scale(1.05);
    }

    #voiceRecordBtn.recording {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
        }
        50% {
            box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
        }
    }

    /* Voice Message Player */
    .voice-message-player {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        min-width: 250px;
    }

    .message-received .voice-message-player {
        background: #f9fafb;
    }

    .voice-play-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #8b9dc3 0%, #a8b5d1 100%);
        border: none;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
        flex-shrink: 0;
        font-size: 14px;
    }

    .voice-play-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(139, 157, 195, 0.3);
    }

    .voice-play-btn.playing {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .voice-waveform {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 2px;
        height: 30px;
    }

    .voice-waveform-bar {
        flex: 1;
        background: #d1d5db;
        border-radius: 2px;
        transition: all 0.2s;
    }

    .voice-waveform-bar.active {
        background: linear-gradient(180deg, #8b9dc3 0%, #a8b5d1 100%);
    }

    .voice-duration {
        font-size: 12px;
        color: #6b7280;
        font-weight: 600;
        font-family: 'Courier New', monospace;
    }

    /* Pending approval notice */
    .pending-approval-notice {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 24px;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
        border-radius: 16px;
        border: 2px solid #ffc107;
        margin: 20px;
    }

    .pending-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        flex-shrink: 0;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .pending-content {
        flex: 1;
    }

    .pending-title {
        font-size: 18px;
        font-weight: 700;
        color: #856404;
        margin: 0 0 8px 0;
    }

    .pending-text {
        font-size: 14px;
        color: #856404;
        margin: 0;
    }

    /* Pending requests section */
    .pending-request-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: #fff3cd;
        border: 1px solid #ffc107;
    }

    .pending-request-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        font-weight: 600;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .pending-request-info {
        flex: 1;
    }

    .pending-request-name {
        font-size: 14px;
        font-weight: 600;
        color: #856404;
    }

    .pending-request-time {
        font-size: 12px;
        color: #856404;
        opacity: 0.8;
    }

    .pending-request-actions {
        display: flex;
        gap: 8px;
    }

    .btn-approve, .btn-reject {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .btn-approve {
        background: #28a745;
        color: white;
    }

    .btn-approve:hover {
        background: #218838;
        transform: scale(1.1);
    }

    .btn-reject {
        background: #dc3545;
        color: white;
    }

    .btn-reject:hover {
        background: #c82333;
        transform: scale(1.1);
    }

    /* Pending requests badge in header */
    .pending-requests-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 3px 10px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        color: #856404;
        font-size: 11px;
        font-weight: 700;
        animation: pulse 2s infinite;
    }

</style>
{% endblock %}

{% block body %}
<div class="container-fluid p-3">
    <div class="chat-container">
        
        <!-- Sidebar - Participants List -->
        <div class="chat-sidebar">
            <div class="search-box">
                <input type="text" placeholder="Search" id="searchParticipants">
                <i class="fas fa-search"></i>
            </div>

            <div class="participants-list">
                <!-- No results message -->
                <div id="noParticipantsFound" class="no-participants-found">
                    <i class="fas fa-user-slash"></i>
                    <div class="message">Aucun participant trouv</div>
                    <div class="search-term">pour "<span id="searchTermDisplay"></span>"</div>
                </div>

                {% for participation in goal.goalParticipations %}
                    <div class="participant-item {% if app.user and participation.user.id == app.user.id %}active{% endif %}">
                        <div class="participant-avatar online">
                            {{ participation.user.firstName|first }}{{ participation.user.lastName|first }}
                        </div>
                        <div class="participant-info">
                            <div class="participant-name">
                                {{ participation.user.firstName }} {{ participation.user.lastName }}
                                <span class="role-badge {{ participation.role|lower }}">{{ participation.role }}</span>
                            </div>
                            <div class="participant-message">
                                {% if app.user and participation.user.id == app.user.id %}
                                    You
                                {% else %}
                                    Member since {{ participation.createdAt|date('M d') }}
                                {% endif %}
                            </div>
                        </div>
                        <div class="participant-meta">
                            <div class="participant-time">
                                {{ participation.createdAt|date('M d') }}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- Main Chat Area -->
        <div class="chat-main">
            
            <!-- Chat Header -->
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-avatar">
                        
                    </div>
                    <div>
                        <div class="chat-header-title">
                            {{ goal.title }}
                            <span class="realtime-indicator" id="realtimeIndicator" title="Messages en temps rel">
                                <i class="fas fa-circle"></i> Live
                            </span>
                        </div>
                        <div class="chat-header-subtitle">
                            {{ goal.goalParticipations|length }} participants  {{ goal.status }}
                            {% if currentUserParticipation %}
                                 <span class="user-role-badge {{ currentUserParticipation.role|lower }}">{{ currentUserParticipation.role }}</span>
                            {% endif %}
                            {% if currentUserParticipation and currentUserParticipation.canModerate() %}
                                {% set pendingCount = goal.getPendingRequestsCount() %}
                                {% if pendingCount > 0 %}
                                     <span class="pending-requests-badge">
                                        <i class="fas fa-user-clock"></i> {{ pendingCount }} demande(s)
                                      </span>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="chat-header-actions">
                    <button type="button" class="search-toggle-btn" onclick="toggleSearchBar()" title="Rechercher dans les messages">
                        <i class="fas fa-search"></i>
                    </button>
                    <button type="button" class="search-toggle-btn" onclick="toggleGroupInfo()" title="Group Info">
                        <i class="fas fa-info-circle"></i>
                    </button>
                    <a href="{{ path('goal_show', {id: goal.id}) }}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left"></i> Back
                    </a>
                </div>
            </div>

            <!-- Search Bar -->
            <div id="searchBar" class="search-bar">
                <div class="search-bar-content">
                    <i class="fas fa-search search-bar-icon"></i>
                    <input type="text" id="messageSearchInput" class="search-bar-input" placeholder="Rechercher dans les messages..." onkeyup="searchMessages(this.value)">
                    <button type="button" class="search-bar-close" onclick="closeSearchBar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <!-- Messages Area -->
            <div class="chat-messages" id="chatMessages">
                
                <!-- Flash Messages -->
                {% for message in app.flashes('success') %}
                    <div class="alert alert-success mb-3" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 10px;">
                        <i class="fas fa-check-circle"></i> {{ message }}
                    </div>
                {% endfor %}

                {% for message in app.flashes('error') %}
                    <div class="alert alert-danger mb-3" style="background: #f8d7da; color: #721c24; padding: 15px; border-radius: 10px;">
                        <i class="fas fa-exclamation-circle"></i> {{ message }}
                    </div>
                {% endfor %}

                <!-- Pinned Message -->
                {% for message in chatroom.messages %}
                    {% if message.isPinned %}
                        <div class="pinned-message-box">
                            <div class="pinned-header">
                                <i class="fas fa-thumbtack"></i> Message pingl
                                {% if app.user %}
                                    <form method="post" action="{{ path('message_unpin', {id: message.id}) }}" style="display: inline;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('unpin' ~ message.id) }}">
                                        <button type="submit" class="unpin-btn">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                            <div class="pinned-content">
                                <strong>{{ message.author.firstName }} {{ message.author.lastName }}:</strong>
                                {{ message.content }}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}

                {% for message in chatroom.messages %}
                    
                    {% if app.user and message.author.id == app.user.id %}
                        <!-- Sent Message -->
                        <div class="message-sent">
                            <div class="message-content">
                                <div class="message-bubble" style="position: relative;" data-message-id="{{ message.id }}">
                                    {% if message.isReply %}
                                        <div class="reply-reference">
                                            <i class="fas fa-reply"></i>
                                            <div class="reply-info">
                                                <strong>{{ message.replyTo.author.firstName }} {{ message.replyTo.author.lastName }}</strong>
                                                <span class="reply-preview">{{ message.replyTo.content|length > 50 ? message.replyTo.content|slice(0, 50) ~ '...' : message.replyTo.content }}</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if message.hasAttachment %}
                                        <div class="message-attachment">
                                            {% if message.attachmentType == 'audio' %}
                                                <div class="voice-message-player">
                                                    <button type="button" class="voice-play-btn" data-voice-id="{{ message.id }}" onclick="playVoiceMessage({{ message.id }}, '{{ message.attachmentPath }}')">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <div class="voice-waveform">
                                                        <div class="voice-waveform-bar" style="height: 40%"></div>
                                                        <div class="voice-waveform-bar" style="height: 70%"></div>
                                                        <div class="voice-waveform-bar" style="height: 50%"></div>
                                                        <div class="voice-waveform-bar" style="height: 90%"></div>
                                                        <div class="voice-waveform-bar" style="height: 60%"></div>
                                                        <div class="voice-waveform-bar" style="height: 80%"></div>
                                                        <div class="voice-waveform-bar" style="height: 45%"></div>
                                                        <div class="voice-waveform-bar" style="height: 75%"></div>
                                                        <div class="voice-waveform-bar" style="height: 55%"></div>
                                                        <div class="voice-waveform-bar" style="height: 65%"></div>
                                                    </div>
                                                    <div class="voice-duration">{{ message.formattedDuration }}</div>
                                                </div>
                                            {% elseif message.attachmentType == 'image' %}
                                                <a href="{{ message.attachmentPath }}" target="_blank" class="attachment-image-link">
                                                    <img src="{{ message.attachmentPath }}" alt="{{ message.attachmentOriginalName }}" class="attachment-image">
                                                </a>
                                            {% elseif message.imageName %}
                                                {# VichUploader image #}
                                                <a href="{{ vich_uploader_asset(message, 'imageFile') }}" target="_blank" class="attachment-image-link">
                                                    <img src="{{ vich_uploader_asset(message, 'imageFile') }}" alt="{{ message.imageName }}" class="attachment-image">
                                                </a>
                                            {% else %}
                                                <a href="{{ message.attachmentPath }}" target="_blank" class="attachment-file">
                                                    <i class="fas {{ message.attachmentIcon }} attachment-icon"></i>
                                                    <span class="attachment-name">{{ message.attachmentOriginalName }}</span>
                                                    <i class="fas fa-download attachment-download"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    {% if message.content %}
                                        <span class="message-text">{{ message.content }}</span>
                                    {% endif %}
                                    {% if message.isEdited %}
                                        <span class="edited-badge">Edited</span>
                                    {% endif %}
                                    <button type="button" class="reply-message-btn" title="Rpondre" onclick="setReplyTo({{ message.id }}, '{{ message.author.firstName|e('js') }}', '{{ message.content|e('js')|slice(0, 50) }}')">
                                        <i class="fas fa-reply"></i>
                                    </button>
                                    {% if app.user and message.author.id == app.user.id %}
                                        <button type="button" class="edit-message-btn" title="Modifier" onclick="openEditModal({{ message.id }}, '{{ message.content|e('js') }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    {% endif %}
                                    {% if app.user and (message.author.id == app.user.id or (currentUserParticipation and currentUserParticipation.canModerate())) %}
                                        <button type="button" class="delete-message-btn" title="Supprimer" onclick="openDeleteModal({{ message.id }})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                                
                                <!-- Reactions -->
                                <div class="message-reactions">
                                    <form method="post" action="{{ path('message_react', {id: message.id, type: 'like'}) }}" style="display: inline;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'like') }}">
                                        <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'like') %}active{% endif %}">
                                             <span class="count">{{ message.getReactionCount('like') }}</span>
                                        </button>
                                    </form>
                                    <form method="post" action="{{ path('message_react', {id: message.id, type: 'clap'}) }}" style="display: inline;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'clap') }}">
                                        <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'clap') %}active{% endif %}">
                                             <span class="count">{{ message.getReactionCount('clap') }}</span>
                                        </button>
                                    </form>
                                    <form method="post" action="{{ path('message_react', {id: message.id, type: 'fire'}) }}" style="display: inline;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'fire') }}">
                                        <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'fire') %}active{% endif %}">
                                             <span class="count">{{ message.getReactionCount('fire') }}</span>
                                        </button>
                                    </form>
                                    <form method="post" action="{{ path('message_react', {id: message.id, type: 'heart'}) }}" style="display: inline;">
                                        <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'heart') }}">
                                        <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'heart') %}active{% endif %}">
                                             <span class="count">{{ message.getReactionCount('heart') }}</span>
                                        </button>
                                    </form>
                                    {% if app.user and not message.isPinned and currentUserParticipation and currentUserParticipation.canModerate() %}
                                        <form method="post" action="{{ path('message_pin', {id: message.id}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('pin' ~ message.id) }}">
                                            <button type="submit" class="pin-btn" title="pingler ce message">
                                                <i class="fas fa-thumbtack"></i>
                                            </button>
                                        </form>
                                    {% endif %}
                                </div>
                                
                                <div class="message-time">
                                    {{ message.createdAt|date('g:i A') }} | {{ message.createdAt|date('M d') }}
                                    {% if app.user %}
                                        <span class="read-status">
                                            {% set readCount = readReceiptRepo.getReadCount(message) %}
                                            {% if readCount > 0 %}
                                                <i class="fas fa-check-double" style="color: #4fc3f7;" title="Lu par {{ readCount }} personne(s)"></i>
                                            {% else %}
                                                <i class="fas fa-check" style="color: #999;" title="Envoy"></i>
                                            {% endif %}
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="message-avatar">
                                {% if app.user %}
                                    {{ app.user.firstName|first }}{{ app.user.lastName|first }}
                                {% else %}
                                    ?
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <!-- Received Message -->
                        <div class="message-received">
                            <div class="message-avatar">
                                {{ message.author.firstName|first }}{{ message.author.lastName|first }}
                            </div>
                            <div class="message-content">
                                <div class="message-bubble">
                                    {% if message.isReply %}
                                        <div class="reply-reference">
                                            <i class="fas fa-reply"></i>
                                            <div class="reply-info">
                                                <strong>{{ message.replyTo.author.firstName }} {{ message.replyTo.author.lastName }}</strong>
                                                <span class="reply-preview">{{ message.replyTo.content|length > 50 ? message.replyTo.content|slice(0, 50) ~ '...' : message.replyTo.content }}</span>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% if message.hasAttachment %}
                                        <div class="message-attachment">
                                            {% if message.attachmentType == 'audio' %}
                                                <div class="voice-message-player">
                                                    <button type="button" class="voice-play-btn" data-voice-id="{{ message.id }}" onclick="playVoiceMessage({{ message.id }}, '{{ message.attachmentPath }}')">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <div class="voice-waveform">
                                                        <div class="voice-waveform-bar" style="height: 40%"></div>
                                                        <div class="voice-waveform-bar" style="height: 70%"></div>
                                                        <div class="voice-waveform-bar" style="height: 50%"></div>
                                                        <div class="voice-waveform-bar" style="height: 90%"></div>
                                                        <div class="voice-waveform-bar" style="height: 60%"></div>
                                                        <div class="voice-waveform-bar" style="height: 80%"></div>
                                                        <div class="voice-waveform-bar" style="height: 45%"></div>
                                                        <div class="voice-waveform-bar" style="height: 75%"></div>
                                                        <div class="voice-waveform-bar" style="height: 55%"></div>
                                                        <div class="voice-waveform-bar" style="height: 65%"></div>
                                                    </div>
                                                    <div class="voice-duration">{{ message.formattedDuration }}</div>
                                                </div>
                                            {% elseif message.attachmentType == 'image' %}
                                                <a href="{{ message.attachmentPath }}" target="_blank" class="attachment-image-link">
                                                    <img src="{{ message.attachmentPath }}" alt="{{ message.attachmentOriginalName }}" class="attachment-image">
                                                </a>
                                            {% elseif message.imageName %}
                                                {# VichUploader image #}
                                                <a href="{{ vich_uploader_asset(message, 'imageFile') }}" target="_blank" class="attachment-image-link">
                                                    <img src="{{ vich_uploader_asset(message, 'imageFile') }}" alt="{{ message.imageName }}" class="attachment-image">
                                                </a>
                                            {% else %}
                                                <a href="{{ message.attachmentPath }}" target="_blank" class="attachment-file">
                                                    <i class="fas {{ message.attachmentIcon }} attachment-icon"></i>
                                                    <span class="attachment-name">{{ message.attachmentOriginalName }}</span>
                                                    <i class="fas fa-download attachment-download"></i>
                                                </a>
                                            {% endif %}
                                        </div>
                                    {% endif %}
                                    {% if message.content %}
                                        {{ message.content }}
                                    {% endif %}
                                </div>
                                
                                <!-- Reactions -->
                                {% if app.user %}
                                    <div class="message-reactions">
                                        <form method="post" action="{{ path('message_react', {id: message.id, type: 'like'}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'like') }}">
                                            <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'like') %}active{% endif %}">
                                                 <span class="count">{{ message.getReactionCount('like') }}</span>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('message_react', {id: message.id, type: 'clap'}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'clap') }}">
                                            <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'clap') %}active{% endif %}">
                                                 <span class="count">{{ message.getReactionCount('clap') }}</span>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('message_react', {id: message.id, type: 'fire'}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'fire') }}">
                                            <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'fire') %}active{% endif %}">
                                                 <span class="count">{{ message.getReactionCount('fire') }}</span>
                                            </button>
                                        </form>
                                        <form method="post" action="{{ path('message_react', {id: message.id, type: 'heart'}) }}" style="display: inline;">
                                            <input type="hidden" name="_token" value="{{ csrf_token('react' ~ message.id ~ 'heart') }}">
                                            <button type="submit" class="reaction-btn {% if message.hasUserReacted(app.user, 'heart') %}active{% endif %}">
                                                 <span class="count">{{ message.getReactionCount('heart') }}</span>
                                            </button>
                                        </form>
                                        {% if not message.isPinned and currentUserParticipation and currentUserParticipation.canModerate() %}
                                            <form method="post" action="{{ path('message_pin', {id: message.id}) }}" style="display: inline;">
                                                <input type="hidden" name="_token" value="{{ csrf_token('pin' ~ message.id) }}">
                                                <button type="submit" class="pin-btn" title="pingler ce message">
                                                    <i class="fas fa-thumbtack"></i>
                                                </button>
                                            </form>
                                        {% endif %}
                                        <button type="button" class="reply-btn" title="Rpondre" onclick="setReplyTo({{ message.id }}, '{{ message.author.firstName|e('js') }}', '{{ message.content|e('js')|slice(0, 50) }}')">
                                            <i class="fas fa-reply"></i>
                                        </button>
                                        {% if currentUserParticipation and currentUserParticipation.canModerate() %}
                                            <button type="button" class="delete-btn" title="Supprimer" onclick="openDeleteModal({{ message.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% endif %}
                                    </div>
                                {% endif %}
                                
                                <div class="message-time">
                                    {{ message.createdAt|date('g:i A') }} | {{ message.createdAt|date('M d') }}
                                </div>
                            </div>
                        </div>
                    {% endif %}

                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                {% endfor %}
            </div>

            <!-- Input Area -->
            <div class="chat-input-area">
                {% if currentUserParticipation is defined and currentUserParticipation and currentUserParticipation.isPending() %}
                    <!-- Pending approval notice -->
                    <div class="pending-approval-notice">
                        <div class="pending-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="pending-content">
                            <h3 class="pending-title">Demande en attente d'approbation</h3>
                            <p class="pending-text">
                                Votre demande a t envoye aux administrateurs du goal.
                                Vous pourrez participer une fois votre demande approuve.
                            </p>
                        </div>
                    </div>
                {% elseif isMember is defined and not isMember %}
                    <!-- Non-member notice -->
                    <div class="non-member-notice">
                        <div class="non-member-icon">
                            <i class="fas fa-lock"></i>
                        </div>
                        <div class="non-member-content">
                            <h3 class="non-member-title">Vous n'tes pas membre de ce goal</h3>
                            <p class="non-member-text">Rejoignez ce goal pour participer  la conversation et envoyer des messages</p>
                            <a href="{{ path('goal_join', {id: goal.id}) }}" class="btn-join-goal">
                                <i class="fas fa-user-plus"></i> Rejoindre le goal
                            </a>
                        </div>
                    </div>
                {% elseif form is not null %}
                {{ form_start(form, {'attr': {'class': 'chat-input-wrapper', 'enctype': 'multipart/form-data', 'onsubmit': 'return handleFormSubmit(event)'}}) }}
                    
                    <div class="chat-input-avatar">
                        {% if app.user %}
                            {{ app.user.firstName|first }}{{ app.user.lastName|first }}
                        {% else %}
                            ?
                        {% endif %}
                    </div>

                    <div class="chat-input-form">
                        <!-- Reply Preview -->
                        <div id="replyPreview" style="display: none;">
                            <div class="reply-preview-content">
                                <i class="fas fa-reply"></i>
                                <div class="reply-preview-info">
                                    <strong id="replyAuthor"></strong>
                                    <span id="replyText"></span>
                                </div>
                                <button type="button" class="reply-cancel-btn" onclick="cancelReply()">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <input type="hidden" id="replyToInput" name="reply_to" value="">

                        <!-- Input container with file preview inside -->
                        <div class="chat-input-container">
                            <!-- File preview inside input -->
                            <div id="filePreview" class="file-preview" style="display: none;">
                                <div class="file-preview-content">
                                    <i class="fas fa-file file-preview-icon"></i>
                                    <span class="file-preview-name"></span>
                                    <button type="button" class="file-preview-remove" onclick="removeFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            {{ form_widget(form.content, {
                                'attr': {
                                    'class': 'chat-input',
                                    'placeholder': 'Type message',
                                    'autocomplete': 'off'
                                }
                            }) }}
                        </div>

                        <!-- Hidden file input -->
                        {{ form_widget(form.attachment, {
                            'attr': {
                                'id': 'fileInput',
                                'style': 'display: none;',
                                'onchange': 'handleFileSelect(this)'
                            }
                        }) }}

                        <button type="button" class="chat-input-btn" id="attachFileBtn" title="Joindre un fichier">
                            <i class="fas fa-paperclip"></i>
                        </button>

                        <button type="button" class="chat-input-btn" id="voiceRecordBtn" onclick="toggleVoiceRecording()" title="Enregistrer un message vocal">
                            <i class="fas fa-microphone"></i>
                        </button>

                        <button type="button" class="chat-input-btn" onclick="toggleEmojiPicker()" title="Ajouter un emoji">
                            <i class="fas fa-smile"></i>
                        </button>

                        <button type="submit" class="chat-input-btn send">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>

                    <!-- Voice Recording Interface -->
                    <div id="voiceRecordingInterface" class="voice-recording-interface">
                        <div class="voice-recording-content">
                            <div class="voice-recording-animation">
                                <div class="voice-wave"></div>
                                <div class="voice-wave"></div>
                                <div class="voice-wave"></div>
                                <div class="voice-wave"></div>
                                <div class="voice-wave"></div>
                            </div>
                            <div class="voice-recording-time" id="recordingTime">0:00</div>
                            <div class="voice-recording-actions">
                                <button type="button" class="voice-btn voice-btn-cancel" onclick="cancelVoiceRecording()">
                                    <i class="fas fa-times"></i> Annuler
                                </button>
                                <button type="button" class="voice-btn voice-btn-send" onclick="sendVoiceRecording()">
                                    <i class="fas fa-paper-plane"></i> Envoyer
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Emoji Picker -->
                    <div id="emojiPicker" class="emoji-picker">
                        <div class="emoji-picker-header">Choisir un emoji</div>
                        <div class="emoji-categories">
                            <button class="emoji-category-btn active" onclick="showEmojiCategory('smileys')"> Smileys</button>
                            <button class="emoji-category-btn" onclick="showEmojiCategory('gestures')"> Gestes</button>
                            <button class="emoji-category-btn" onclick="showEmojiCategory('objects')"> Objets</button>
                            <button class="emoji-category-btn" onclick="showEmojiCategory('symbols')"> Symboles</button>
                        </div>
                        <div id="emojiGrid" class="emoji-grid">
                            <!-- Emojis will be loaded here -->
                        </div>
                    </div>

                {{ form_end(form) }}
                {% endif %}
            </div>

        </div>

        <!-- Group Info Sidebar -->
        <div class="group-info-sidebar" id="groupInfoSidebar">
            <div class="group-info-header">
                <div class="group-info-title">Group Info</div>
                <button type="button" class="group-info-close" onclick="toggleGroupInfo()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Files Section -->
            <div class="group-info-section">
                <div class="group-info-section-title" onclick="toggleSection('files')">
                    <span><i class="fas fa-folder"></i> Files</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="filesSection" class="group-info-section-content">
                    <div class="group-info-item">
                        <i class="fas fa-image"></i>
                        <span class="group-info-item-text">Photos</span>
                        <span class="group-info-item-count">
                            {% set photoCount = 0 %}
                            {% for message in chatroom.messages %}
                                {% if message.attachmentType == 'image' %}
                                    {% set photoCount = photoCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ photoCount }}
                        </span>
                    </div>
                    <div class="group-info-item">
                        <i class="fas fa-video"></i>
                        <span class="group-info-item-text">Videos</span>
                        <span class="group-info-item-count">0</span>
                    </div>
                    <div class="group-info-item">
                        <i class="fas fa-file"></i>
                        <span class="group-info-item-text">Files</span>
                        <span class="group-info-item-count">
                            {% set fileCount = 0 %}
                            {% for message in chatroom.messages %}
                                {% if message.hasAttachment and message.attachmentType != 'image' and message.attachmentType != 'audio' %}
                                    {% set fileCount = fileCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ fileCount }}
                        </span>
                    </div>
                    <div class="group-info-item">
                        <i class="fas fa-microphone"></i>
                        <span class="group-info-item-text">Voice messages</span>
                        <span class="group-info-item-count">
                            {% set voiceCount = 0 %}
                            {% for message in chatroom.messages %}
                                {% if message.attachmentType == 'audio' %}
                                    {% set voiceCount = voiceCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {{ voiceCount }}
                        </span>
                    </div>
                    <div class="group-info-item">
                        <i class="fas fa-link"></i>
                        <span class="group-info-item-text">Shared links</span>
                        <span class="group-info-item-count">0</span>
                    </div>
                </div>
            </div>

            <!-- Pending Requests Section (only visible to ADMIN/OWNER) -->
            {% if currentUserParticipation is defined and currentUserParticipation and currentUserParticipation.canModerate() %}
                {% set pendingRequests = goal.getPendingRequests() %}
                {% if pendingRequests|length > 0 %}
                    <div class="group-info-section">
                        <div class="group-info-section-title" onclick="toggleSection('pendingRequests')">
                            <span>
                                <i class="fas fa-user-clock"></i> 
                                Demandes en attente ({{ pendingRequests|length }})
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div id="pendingRequestsSection" class="group-info-section-content">
                            {% for participation in pendingRequests %}
                                <div class="pending-request-item" id="pending-request-{{ participation.user.id }}">
                                    <div class="pending-request-avatar">
                                        {{ participation.user.firstName|first }}{{ participation.user.lastName|first }}
                                    </div>
                                    <div class="pending-request-info">
                                        <div class="pending-request-name">
                                            {{ participation.user.firstName }} {{ participation.user.lastName }}
                                        </div>
                                        <div class="pending-request-time">
                                            {{ participation.createdAt|date('d/m/Y H:i') }}
                                        </div>
                                    </div>
                                    <div class="pending-request-actions">
                                        <button class="btn-approve" onclick="approveRequest({{ participation.user.id }})" title="Accepter">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn-reject" onclick="rejectRequest({{ participation.user.id }})" title="Refuser">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            {% endif %}

            <!-- Members Section -->
            <div class="group-info-section">
                <div class="group-info-section-title" onclick="toggleSection('members')">
                    <span><i class="fas fa-users"></i> {{ goal.goalParticipations|length }} members</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="membersSection" class="group-info-section-content">
                    {% for participation in goal.goalParticipations %}
                        <div class="group-member-item">
                            <div class="group-member-avatar">
                                {{ participation.user.firstName|first }}{{ participation.user.lastName|first }}
                            </div>
                            <div class="group-member-info">
                                <div class="group-member-name">
                                    {{ participation.user.firstName }} {{ participation.user.lastName }}
                                </div>
                                <div class="group-member-role {{ participation.role|lower }}">
                                    {{ participation.role|lower }}
                                </div>
                            </div>
                            {% if app.user and currentUserParticipation and currentUserParticipation.canModerate() and participation.user.id != app.user.id %}
                                <div class="group-member-actions">
                                    <button class="member-action-btn" onclick="showMemberActions({{ participation.user.id }}, '{{ participation.user.firstName|e('js') }} {{ participation.user.lastName|e('js') }}', '{{ participation.role }}')">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Recent Images Section -->
            <div class="group-info-section">
                <div class="group-info-section-title" onclick="toggleSection('recentImages')">
                    <span><i class="fas fa-images"></i> Recent Images</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="recentImagesSection" class="group-info-section-content">
                    {% set hasImages = false %}
                    {% for message in chatroom.messages|reverse %}
                        {% if message.attachmentType == 'image' %}
                            {% set hasImages = true %}
                            {% if loop.index <= 6 %}
                                <a href="{{ message.attachmentPath }}" target="_blank" class="recent-image-item" style="text-decoration: none;">
                                    <img src="{{ message.attachmentPath }}" alt="{{ message.attachmentOriginalName }}" class="recent-image-thumb">
                                    <div class="recent-image-overlay">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                </a>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                    {% if not hasImages %}
                        <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                            <i class="fas fa-image" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            No images shared yet
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Shared Files Section -->
            <div class="group-info-section">
                <div class="group-info-section-title" onclick="toggleSection('sharedFiles')">
                    <span><i class="fas fa-paperclip"></i> Shared Files</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="sharedFilesSection" class="group-info-section-content">
                    {% set hasFiles = false %}
                    {% for message in chatroom.messages|reverse|slice(0, 10) %}
                        {% if message.hasAttachment %}
                            {% set hasFiles = true %}
                            <a href="{{ message.attachmentPath }}" target="_blank" class="shared-file-item" style="text-decoration: none;">
                                <div class="shared-file-icon">
                                    <i class="fas {{ message.attachmentIcon }}"></i>
                                </div>
                                <div class="shared-file-info">
                                    <div class="shared-file-name">{{ message.attachmentOriginalName }}</div>
                                    <div class="shared-file-date">{{ message.createdAt|date('M d, Y') }}</div>
                                </div>
                            </a>
                        {% endif %}
                    {% endfor %}
                    {% if not hasFiles %}
                        <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 13px;">
                            <i class="fas fa-inbox" style="font-size: 32px; margin-bottom: 10px; display: block;"></i>
                            No files shared yet
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Edit Message Modal -->
<div id="editModal" class="edit-modal">
    <div class="edit-modal-content">
        <div class="edit-modal-header">Modifier le message</div>
        <form id="editForm" method="post" action="">
            <input type="hidden" name="_token" id="editToken" value="">
            <textarea name="content" id="editTextarea" class="edit-modal-textarea" placeholder="Modifier votre message..."></textarea>
            <div class="edit-modal-actions">
                <button type="button" class="edit-modal-btn cancel" onclick="closeEditModal()">Annuler</button>
                <button type="submit" class="edit-modal-btn save">Enregistrer</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Message Modal -->
<div id="deleteModal" class="delete-modal">
    <div class="delete-modal-content">
        <div class="delete-modal-header">
            Pour qui voulez-vous retirer ce message ?
            <button type="button" class="delete-modal-close" onclick="closeDeleteModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="delete-modal-body">
            <div class="delete-option selected" data-type="everyone" onclick="selectDeleteOption('everyone')">
                <div class="delete-option-radio"></div>
                <div class="delete-option-content">
                    <div class="delete-option-title">Retirer pour tout le monde</div>
                    <div class="delete-option-description">
                        Ce message sera retir pour tous les participants  la discussion. Il est possible que certains l'aient dj vu ou transfr. Les messages retirs peuvent toujours tre inclus dans des rapports.
                    </div>
                </div>
            </div>
            <div class="delete-option" data-type="me" onclick="selectDeleteOption('me')">
                <div class="delete-option-radio"></div>
                <div class="delete-option-content">
                    <div class="delete-option-title">Retirer pour vous</div>
                    <div class="delete-option-description">
                        Cette action supprimera le message de vos appareils. Les autres membres de la discussion pourront toujours le voir.
                    </div>
                </div>
            </div>
        </div>
        <div class="delete-modal-actions">
            <button type="button" class="delete-modal-btn cancel" onclick="closeDeleteModal()">Annuler</button>
            <button type="button" class="delete-modal-btn delete" onclick="confirmDelete()">Supprimer</button>
        </div>
    </div>
</div>

<script>
// Auto-scroll to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    const chatMessages = document.getElementById('chatMessages');
    if (chatMessages) {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Handle file attachment button
    const attachFileBtn = document.getElementById('attachFileBtn');
    if (attachFileBtn) {
        attachFileBtn.addEventListener('click', function() {
            console.log('Attach file button clicked');
            // Find the file input - it might have a generated ID from Symfony
            let fileInput = document.getElementById('fileInput');
            
            // If not found by ID, try to find by name or type
            if (!fileInput) {
                fileInput = document.querySelector('input[type="file"][name*="attachment"]');
                console.log('Found file input by selector:', fileInput);
            }
            
            if (fileInput) {
                console.log('Triggering file input click');
                fileInput.click();
            } else {
                console.error('File input not found!');
                alert('Erreur: Impossible de trouver le champ de fichier');
            }
        });
    }
    
    // Auto-refresh messages every 3 seconds
    setInterval(function() {
        refreshMessages();
    }, 3000);
});

// Function to refresh messages without reloading the page
function refreshMessages() {
    const chatMessages = document.getElementById('chatMessages');
    const currentScrollHeight = chatMessages.scrollHeight;
    const currentScrollTop = chatMessages.scrollTop;
    const isScrolledToBottom = currentScrollTop + chatMessages.clientHeight >= currentScrollHeight - 50;
    
    // Fetch new messages via AJAX
    fetch(window.location.href, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.text())
    .then(html => {
        // Parse the HTML response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const newMessages = doc.getElementById('chatMessages');
        
        if (newMessages) {
            // Update only the messages content
            const currentMessages = chatMessages.innerHTML;
            const newContent = newMessages.innerHTML;
            
            if (currentMessages !== newContent) {
                chatMessages.innerHTML = newContent;
                
                // Auto-scroll if user was at bottom
                if (isScrolledToBottom) {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        }
    })
    .catch(error => console.log('Error refreshing messages:', error));
}

// Search participants
document.getElementById('searchParticipants')?.addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const participants = document.querySelectorAll('.participant-item');
    const noResultsMessage = document.getElementById('noParticipantsFound');
    const searchTermDisplay = document.getElementById('searchTermDisplay');
    
    let visibleCount = 0;
    
    participants.forEach(participant => {
        const name = participant.querySelector('.participant-name').textContent.toLowerCase();
        if (name.includes(searchTerm)) {
            participant.style.display = 'flex';
            visibleCount++;
        } else {
            participant.style.display = 'none';
        }
    });
    
    // Show/hide no results message
    if (searchTerm.trim() !== '' && visibleCount === 0) {
        noResultsMessage.style.display = 'block';
        searchTermDisplay.textContent = e.target.value;
    } else {
        noResultsMessage.style.display = 'none';
    }
});

// Edit message functions
function openEditModal(messageId, currentContent) {
    const modal = document.getElementById('editModal');
    const form = document.getElementById('editForm');
    const textarea = document.getElementById('editTextarea');
    
    // Set form action
    form.action = '/message/' + messageId + '/edit';
    
    // Set textarea content
    textarea.value = currentContent;
    
    // Show modal
    modal.classList.add('active');
    
    // Focus textarea
    textarea.focus();
}

function closeEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.remove('active');
}

// Delete message functions
let currentDeleteMessageId = null;
let currentDeleteType = 'everyone';

function openDeleteModal(messageId) {
    currentDeleteMessageId = messageId;
    currentDeleteType = 'everyone';
    
    const modal = document.getElementById('deleteModal');
    modal.classList.add('active');
    
    // Reset selection
    document.querySelectorAll('.delete-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector('.delete-option[data-type="everyone"]').classList.add('selected');
}

function closeDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('active');
    currentDeleteMessageId = null;
    currentDeleteType = 'everyone';
}

function selectDeleteOption(type) {
    currentDeleteType = type;
    
    // Update UI
    document.querySelectorAll('.delete-option').forEach(opt => {
        opt.classList.remove('selected');
    });
    document.querySelector(`.delete-option[data-type="${type}"]`).classList.add('selected');
}

async function confirmDelete() {
    if (!currentDeleteMessageId) return;
    
    const route = currentDeleteType === 'everyone' 
        ? `/message/${currentDeleteMessageId}/delete`
        : `/message/${currentDeleteMessageId}/delete-for-me`;
    
    try {
        const response = await fetch(route, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                // Remove message from DOM or hide it
                const messageElement = document.querySelector(`[data-message-id="${currentDeleteMessageId}"]`);
                if (messageElement) {
                    const messageContainer = messageElement.closest('.message-sent, .message-received');
                    if (messageContainer) {
                        messageContainer.style.opacity = '0';
                        messageContainer.style.transform = 'translateX(-20px)';
                        setTimeout(() => {
                            messageContainer.remove();
                        }, 300);
                    }
                }
                closeDeleteModal();
            } else {
                alert(result.error || 'Erreur lors de la suppression');
            }
        } else {
            alert('Erreur lors de la suppression du message');
        }
    } catch (error) {
        console.error('Error deleting message:', error);
        alert('Erreur lors de la suppression du message');
    }
}

// Close modal on outside click
document.getElementById('editModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});

document.getElementById('deleteModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
        closeDeleteModal();
    }
});

// File upload functions
function handleFileSelect(input) {
    console.log('handleFileSelect called');
    console.log('Input:', input);
    console.log('Files:', input.files);
    
    const file = input.files[0];
    if (file) {
        console.log('File selected:', file.name, 'Size:', file.size, 'Type:', file.type);
        
        const preview = document.getElementById('filePreview');
        const fileName = document.querySelector('.file-preview-name');
        const icon = document.querySelector('.file-preview-icon');
        
        if (!preview || !fileName || !icon) {
            console.error('Preview elements not found!');
            return;
        }
        
        // Update file name
        fileName.textContent = file.name;
        
        // Update icon based on file type
        if (file.type.startsWith('image/')) {
            icon.className = 'fas fa-image file-preview-icon';
        } else if (file.type.startsWith('video/')) {
            icon.className = 'fas fa-video file-preview-icon';
        } else if (file.type === 'application/pdf') {
            icon.className = 'fas fa-file-pdf file-preview-icon';
        } else if (file.type.includes('word')) {
            icon.className = 'fas fa-file-word file-preview-icon';
        } else if (file.type.includes('excel') || file.type.includes('spreadsheet')) {
            icon.className = 'fas fa-file-excel file-preview-icon';
        } else if (file.type.startsWith('text/')) {
            icon.className = 'fas fa-file-alt file-preview-icon';
        } else {
            icon.className = 'fas fa-file file-preview-icon';
        }
        
        // Show preview
        preview.style.display = 'block';
        console.log('File preview displayed');
    } else {
        console.log('No file selected');
    }
}

function removeFile() {
    const input = document.getElementById('fileInput');
    const preview = document.getElementById('filePreview');
    
    // Clear file input
    input.value = '';
    
    // Hide preview
    preview.style.display = 'none';
}

// Emoji Picker
const emojiCategories = {
    smileys: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    gestures: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    objects: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
    symbols: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
};

let currentCategory = 'smileys';

function toggleEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.classList.toggle('active');
    
    if (picker.classList.contains('active')) {
        loadEmojis(currentCategory);
    }
}

function showEmojiCategory(category) {
    currentCategory = category;
    
    // Update active button
    document.querySelectorAll('.emoji-category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load emojis
    loadEmojis(category);
}

function loadEmojis(category) {
    const grid = document.getElementById('emojiGrid');
    const emojis = emojiCategories[category] || emojiCategories.smileys;
    
    grid.innerHTML = '';
    emojis.forEach(emoji => {
        const button = document.createElement('button');
        button.className = 'emoji-item';
        button.textContent = emoji;
        button.type = 'button';
        button.onclick = () => insertEmoji(emoji);
        grid.appendChild(button);
    });
}

function insertEmoji(emoji) {
    const textarea = document.querySelector('.chat-input');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    
    // Insert emoji at cursor position
    textarea.value = text.substring(0, start) + emoji + text.substring(end);
    
    // Move cursor after emoji
    textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    
    // Focus textarea
    textarea.focus();
    
    // Close picker
    document.getElementById('emojiPicker').classList.remove('active');
}

// Close emoji picker when clicking outside
document.addEventListener('click', function(e) {
    const picker = document.getElementById('emojiPicker');
    const emojiBtn = e.target.closest('.chat-input-btn');
    
    if (picker && !picker.contains(e.target) && (!emojiBtn || !emojiBtn.querySelector('.fa-smile'))) {
        picker.classList.remove('active');
    }
});

// Search functionality
function toggleSearchBar() {
    const searchBar = document.getElementById('searchBar');
    const searchInput = document.getElementById('messageSearchInput');
    
    searchBar.classList.toggle('active');
    
    if (searchBar.classList.contains('active')) {
        searchInput.focus();
    } else {
        closeSearchBar();
    }
}

function closeSearchBar() {
    const searchBar = document.getElementById('searchBar');
    const searchInput = document.getElementById('messageSearchInput');
    const searchResults = document.getElementById('searchResults');
    
    searchBar.classList.remove('active');
    searchInput.value = '';
    searchResults.classList.remove('active');
    
    // Remove all highlights and search-match classes
    clearSearchHighlights();
}

function searchMessages(query) {
    const searchResults = document.getElementById('searchResults');
    
    if (!query || query.trim().length < 2) {
        searchResults.classList.remove('active');
        clearSearchHighlights();
        return;
    }
    
    // Clear previous highlights
    clearSearchHighlights();
    
    const messages = document.querySelectorAll('.message-bubble');
    let matchCount = 0;
    
    messages.forEach(message => {
        const messageText = message.querySelector('.message-text');
        if (!messageText) return;
        
        const originalText = messageText.textContent;
        const lowerText = originalText.toLowerCase();
        const lowerQuery = query.toLowerCase();
        
        if (lowerText.includes(lowerQuery)) {
            matchCount++;
            
            // Highlight the text
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            const highlightedText = originalText.replace(regex, '<span class="highlight">$1</span>');
            messageText.innerHTML = highlightedText;
            
            // Add search-match class to bubble
            message.classList.add('search-match');
        }
    });
    
    // Show results count
    if (matchCount > 0) {
        searchResults.innerHTML = `<i class="fas fa-check-circle" style="color: #10b981; margin-right: 5px;"></i><span class="search-results-count">${matchCount}</span> rsultat${matchCount > 1 ? 's' : ''} trouv${matchCount > 1 ? 's' : ''}`;
        searchResults.classList.add('active');
        searchResults.style.color = '#10b981';
        
        // Scroll to first match
        const firstMatch = document.querySelector('.message-bubble.search-match');
        if (firstMatch) {
            firstMatch.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        searchResults.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444; margin-right: 5px;"></i>Aucun rsultat trouv pour "' + escapeHtml(query) + '"';
        searchResults.classList.add('active');
        searchResults.style.color = '#ef4444';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function clearSearchHighlights() {
    // Remove highlights
    document.querySelectorAll('.highlight').forEach(highlight => {
        const parent = highlight.parentNode;
        parent.textContent = parent.textContent;
    });
    
    // Remove search-match classes
    document.querySelectorAll('.message-bubble.search-match').forEach(bubble => {
        bubble.classList.remove('search-match');
    });
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// Close search bar with Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const searchBar = document.getElementById('searchBar');
        if (searchBar && searchBar.classList.contains('active')) {
            closeSearchBar();
        }
    }
});

// Voice Recording Functionality
let mediaRecorder;
let audioChunks = [];
let recordingInterval;
let recordingStartTime;
let audioBlob;

function toggleVoiceRecording() {
    console.log('toggleVoiceRecording called');
    const recordInterface = document.getElementById('voiceRecordingInterface');
    const recordBtn = document.getElementById('voiceRecordBtn');
    
    console.log('recordInterface:', recordInterface);
    console.log('recordBtn:', recordBtn);
    
    if (recordInterface.classList.contains('active')) {
        // Already recording, stop it
        console.log('Stopping recording');
        stopVoiceRecording();
    } else {
        // Start recording
        console.log('Starting recording');
        startVoiceRecording();
    }
}

async function startVoiceRecording() {
    console.log('startVoiceRecording called');
    try {
        console.log('Requesting microphone access...');
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        console.log('Microphone access granted');
        
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        
        mediaRecorder.ondataavailable = (event) => {
            console.log('Data available:', event.data.size, 'bytes');
            audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
            console.log('Recording stopped, creating blob');
            audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
            console.log('Blob created:', audioBlob.size, 'bytes');
            stream.getTracks().forEach(track => track.stop());
        };
        
        mediaRecorder.start();
        console.log('MediaRecorder started');
        
        // Show recording interface
        const recordInterface = document.getElementById('voiceRecordingInterface');
        const recordBtn = document.getElementById('voiceRecordBtn');
        recordInterface.classList.add('active');
        recordBtn.classList.add('recording');
        
        // Start timer
        recordingStartTime = Date.now();
        updateRecordingTime();
        recordingInterval = setInterval(updateRecordingTime, 1000);
        
    } catch (error) {
        console.error('Error accessing microphone:', error);
        alert('Impossible d\'accder au microphone. Veuillez autoriser l\'accs au microphone dans les paramtres de votre navigateur.');
    }
}

function stopVoiceRecording() {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
    }
    clearInterval(recordingInterval);
}

function updateRecordingTime() {
    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    document.getElementById('recordingTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function cancelVoiceRecording() {
    stopVoiceRecording();
    
    const recordInterface = document.getElementById('voiceRecordingInterface');
    const recordBtn = document.getElementById('voiceRecordBtn');
    recordInterface.classList.remove('active');
    recordBtn.classList.remove('recording');
    
    audioChunks = [];
    audioBlob = null;
}

async function sendVoiceRecording() {
    console.log('sendVoiceRecording called');
    
    // Stop recording first and wait for blob
    if (mediaRecorder && mediaRecorder.state === 'recording') {
        console.log('Stopping mediaRecorder...');
        // Create a promise that resolves when recording stops
        const recordingStopped = new Promise(resolve => {
            const originalOnStop = mediaRecorder.onstop;
            mediaRecorder.onstop = () => {
                originalOnStop();
                resolve();
            };
        });
        
        mediaRecorder.stop();
        clearInterval(recordingInterval);
        
        // Wait for the recording to stop and blob to be created
        await recordingStopped;
        console.log('Recording stopped and blob created');
    }
    
    if (!audioBlob) {
        console.error('No audio blob available');
        alert('Aucun enregistrement disponible');
        cancelVoiceRecording();
        return;
    }
    
    console.log('Audio blob size:', audioBlob.size);
    
    // Calculate duration
    const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
    console.log('Duration:', duration, 'seconds');
    
    // Create form data
    const formData = new FormData();
    formData.append('voice', audioBlob, 'voice-message.webm');
    formData.append('duration', duration);
    
    try {
        // Get goal ID from URL - URL format is /goal/{id}/messages
        const pathParts = window.location.pathname.split('/');
        const goalId = pathParts[pathParts.indexOf('goal') + 1];
        console.log('Goal ID:', goalId);
        
        // Send to server
        console.log('Sending to server...');
        const response = await fetch(`/goal/${goalId}/send-voice`, {
            method: 'POST',
            body: formData
        });
        
        console.log('Response status:', response.status);
        const result = await response.json();
        console.log('Server response:', result);
        
        if (result.success) {
            console.log('Voice message sent successfully!');
            // Clear recording interface
            cancelVoiceRecording();
            
            // Fetch new messages instead of reload
            setTimeout(() => {
                fetchNewMessages();
            }, 500);
        } else {
            console.error('Server error:', result);
            alert(result.error || 'Erreur lors de l\'envoi du message vocal');
            cancelVoiceRecording();
        }
    } catch (error) {
        console.error('Error sending voice message:', error);
        alert('Erreur lors de l\'envoi du message vocal: ' + error.message);
        cancelVoiceRecording();
    }
}

// Voice Message Player
function playVoiceMessage(messageId, audioPath) {
    const playBtn = document.querySelector(`[data-voice-id="${messageId}"]`);
    const audio = new Audio(audioPath);
    
    if (playBtn.classList.contains('playing')) {
        audio.pause();
        playBtn.classList.remove('playing');
        playBtn.innerHTML = '<i class="fas fa-play"></i>';
    } else {
        // Stop all other playing audios
        document.querySelectorAll('.voice-play-btn.playing').forEach(btn => {
            btn.classList.remove('playing');
            btn.innerHTML = '<i class="fas fa-play"></i>';
        });
        
        audio.play();
        playBtn.classList.add('playing');
        playBtn.innerHTML = '<i class="fas fa-pause"></i>';
        
        audio.onended = () => {
            playBtn.classList.remove('playing');
            playBtn.innerHTML = '<i class="fas fa-play"></i>';
        };
    }
}

// Reply System
function setReplyTo(messageId, authorName, messagePreview) {
    document.getElementById('replyToInput').value = messageId;
    document.getElementById('replyAuthor').textContent = authorName;
    document.getElementById('replyText').textContent = messagePreview;
    document.getElementById('replyPreview').style.display = 'block';
    
    // Focus on input
    document.querySelector('.chat-input').focus();
}

function cancelReply() {
    document.getElementById('replyToInput').value = '';
    document.getElementById('replyPreview').style.display = 'none';
}

// Real-Time Messages with AJAX Polling
let lastMessageId = 0;
let pollingInterval = null;
let isPolling = false;

// Get initial last message ID
document.addEventListener('DOMContentLoaded', function() {
    const messages = document.querySelectorAll('[data-message-id]');
    if (messages.length > 0) {
        const lastMessage = messages[messages.length - 1];
        lastMessageId = parseInt(lastMessage.getAttribute('data-message-id'));
    }
    
    // Start polling for new messages
    startPolling();
});

// Handle form submission via AJAX
async function handleFormSubmit(event) {
    event.preventDefault();
    console.log('=== Form submit started ===');
    
    const form = event.target;
    const formData = new FormData(form);
    
    // Log all form data
    console.log('Form data entries:');
    for (let pair of formData.entries()) {
        if (pair[1] instanceof File) {
            console.log(`  ${pair[0]}: File(${pair[1].name}, ${pair[1].size} bytes, ${pair[1].type})`);
        } else {
            console.log(`  ${pair[0]}: ${pair[1]}`);
        }
    }
    
    // Check if there's content or attachment
    const content = formData.get('message[content]');
    const attachment = formData.get('message[attachment]');
    const imageFile = formData.get('message[imageFile]');
    
    console.log('Content value:', content);
    console.log('Attachment value:', attachment);
    console.log('ImageFile value:', imageFile);
    console.log('Attachment is File?', attachment instanceof File);
    console.log('Attachment name:', attachment ? attachment.name : 'none');
    console.log('Attachment size:', attachment ? attachment.size : 0);
    console.log('ImageFile is File?', imageFile instanceof File);
    console.log('ImageFile name:', imageFile ? imageFile.name : 'none');
    console.log('ImageFile size:', imageFile ? imageFile.size : 0);
    
    // Trim content and check if it's not empty
    const trimmedContent = content ? content.trim() : '';
    
    // Check if there's any attachment (regular or VichUploader image)
    const hasAttachment = (attachment && attachment.name && attachment.size > 0) || 
                         (imageFile && imageFile.name && imageFile.size > 0);
    
    if (!trimmedContent && !hasAttachment) {
        console.error('Validation failed: no content and no attachment');
        alert('Veuillez entrer un message ou joindre un fichier');
        return false;
    }
    
    console.log('Validation passed, sending request...');
    
    try {
        console.log('Sending request to:', form.action);
        const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', [...response.headers.entries()]);
        
        if (response.ok) {
            const contentType = response.headers.get('content-type');
            console.log('Content-Type:', contentType);
            
            const responseText = await response.text();
            console.log('Response text length:', responseText.length);
            console.log('Response text preview:', responseText.substring(0, 200));
            
            let result;
            try {
                result = JSON.parse(responseText);
                console.log('Parsed result:', result);
            } catch (e) {
                console.error('Failed to parse JSON:', e);
                console.error('Full response:', responseText);
                alert('Erreur: La rponse du serveur n\'est pas au format JSON');
                return false;
            }
            
            if (result.success) {
                console.log(' Message sent successfully!');
                // Clear form
                const inputField = form.querySelector('.chat-input');
                if (inputField) {
                    inputField.value = '';
                    console.log(' Input field cleared');
                }
                
                const fileInput = document.querySelector('input[type="file"][name*="attachment"]');
                if (fileInput) {
                    fileInput.value = '';
                    console.log(' File input cleared');
                }
                
                const filePreview = document.getElementById('filePreview');
                if (filePreview) {
                    filePreview.style.display = 'none';
                    console.log(' File preview hidden');
                }
                
                cancelReply();
                
                // Fetch new messages immediately
                console.log('Fetching new messages...');
                setTimeout(() => {
                    fetchNewMessages();
                }, 300);
            } else {
                console.error(' Server returned error:', result);
                alert(result.error || 'Erreur lors de l\'envoi du message');
            }
        } else {
            console.error(' Response not OK. Status:', response.status);
            const errorText = await response.text();
            console.error('Error response:', errorText);
            alert('Erreur lors de l\'envoi du message (Status: ' + response.status + ')');
        }
    } catch (error) {
        console.error(' Error submitting form:', error);
        console.error('Error stack:', error.stack);
        alert('Erreur lors de l\'envoi du message: ' + error.message);
    }
    
    console.log('=== Form submit ended ===');
    return false;
}

function startPolling() {
    if (pollingInterval) return;
    
    // Poll every 2 seconds
    pollingInterval = setInterval(fetchNewMessages, 2000);
}

function stopPolling() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
    }
}

async function fetchNewMessages() {
    if (isPolling) return;
    isPolling = true;
    
    try {
        // Extract goal ID correctly from URL like /goal/2/messages
        const pathParts = window.location.pathname.split('/');
        const goalIndex = pathParts.indexOf('goal');
        const goalId = pathParts[goalIndex + 1];
        
        console.log('Fetching messages for goal:', goalId);
        
        const response = await fetch(`/goal/${goalId}/messages/fetch?lastMessageId=${lastMessageId}`);
        const data = await response.json();
        
        if (data.messages && data.messages.length > 0) {
            data.messages.forEach(message => {
                appendMessage(message);
                lastMessageId = Math.max(lastMessageId, message.id);
            });
            
            // Scroll to bottom
            const messagesContainer = document.querySelector('.chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Play notification sound (optional)
            playNotificationSound();
        }
    } catch (error) {
        console.error('Error fetching messages:', error);
    } finally {
        isPolling = false;
    }
}

function appendMessage(message) {
    const messagesContainer = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = message.isOwn ? 'message-sent' : 'message-received';
    
    let messageHTML = '';
    
    if (message.isOwn) {
        // Sent message
        messageHTML = `
            <div class="message-content">
                <div class="message-bubble" style="position: relative;" data-message-id="${message.id}">
                    ${message.isReply ? `
                        <div class="reply-reference">
                            <i class="fas fa-reply"></i>
                            <div class="reply-info">
                                <strong>${message.replyTo.authorFirstName} ${message.replyTo.authorLastName}</strong>
                                <span class="reply-preview">${message.replyTo.content}</span>
                            </div>
                        </div>
                    ` : ''}
                    ${message.hasAttachment ? renderAttachment(message) : ''}
                    ${message.content ? `<span class="message-text">${escapeHtml(message.content)}</span>` : ''}
                    ${message.isEdited ? '<span class="edited-badge">Edited</span>' : ''}
                </div>
                <div class="message-time">
                    ${message.createdAt} | ${message.createdAtDate}
                    <span class="read-status">
                        ${message.readCount > 0 
                            ? '<i class="fas fa-check-double" style="color: #4fc3f7;"></i>' 
                            : '<i class="fas fa-check" style="color: #999;"></i>'}
                    </span>
                </div>
            </div>
            <div class="message-avatar">${message.authorInitials}</div>
        `;
    } else {
        // Received message
        messageHTML = `
            <div class="message-avatar">${message.authorInitials}</div>
            <div class="message-content">
                <div class="message-bubble">
                    ${message.isReply ? `
                        <div class="reply-reference">
                            <i class="fas fa-reply"></i>
                            <div class="reply-info">
                                <strong>${message.replyTo.authorFirstName} ${message.replyTo.authorLastName}</strong>
                                <span class="reply-preview">${message.replyTo.content}</span>
                            </div>
                        </div>
                    ` : ''}
                    ${message.hasAttachment ? renderAttachment(message) : ''}
                    ${message.content ? escapeHtml(message.content) : ''}
                </div>
                <div class="message-time">
                    ${message.createdAt} | ${message.createdAtDate}
                </div>
            </div>
        `;
    }
    
    messageDiv.innerHTML = messageHTML;
    messagesContainer.appendChild(messageDiv);
    
    // Add animation
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateY(20px)';
    setTimeout(() => {
        messageDiv.style.transition = 'all 0.3s ease';
        messageDiv.style.opacity = '1';
        messageDiv.style.transform = 'translateY(0)';
    }, 10);
}

function renderAttachment(message) {
    if (message.attachmentType === 'audio') {
        return `
            <div class="message-attachment">
                <div class="voice-message-player">
                    <button type="button" class="voice-play-btn" data-voice-id="${message.id}" onclick="playVoiceMessage(${message.id}, '${message.attachmentPath}')">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="voice-waveform">
                        ${Array(10).fill().map((_, i) => `<div class="voice-waveform-bar" style="height: ${40 + Math.random() * 50}%"></div>`).join('')}
                    </div>
                    <div class="voice-duration">${message.audioDuration}</div>
                </div>
            </div>
        `;
    } else if (message.attachmentType === 'image') {
        return `
            <div class="message-attachment">
                <a href="${message.attachmentPath}" target="_blank" class="attachment-image-link">
                    <img src="${message.attachmentPath}" alt="${message.attachmentOriginalName}" class="attachment-image">
                </a>
            </div>
        `;
    } else {
        return `
            <div class="message-attachment">
                <a href="${message.attachmentPath}" target="_blank" class="attachment-file">
                    <i class="fas ${message.attachmentIcon} attachment-icon"></i>
                    <span class="attachment-name">${message.attachmentOriginalName}</span>
                    <i class="fas fa-download attachment-download"></i>
                </a>
            </div>
        `;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function playNotificationSound() {
    // Optional: play a subtle notification sound
    // const audio = new Audio('/sounds/notification.mp3');
    // audio.volume = 0.3;
    // audio.play().catch(() => {});
}

// Stop polling when user leaves the page
window.addEventListener('beforeunload', stopPolling);

// Group Info Sidebar Toggle
function toggleGroupInfo() {
    const sidebar = document.getElementById('groupInfoSidebar');
    if (sidebar.style.display === 'none') {
        sidebar.style.display = 'flex';
    } else {
        sidebar.style.display = 'none';
    }
}

// Toggle sections in Group Info
function toggleSection(sectionId) {
    const section = document.getElementById(sectionId + 'Section');
    const title = event.currentTarget;
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        title.classList.remove('collapsed');
    } else {
        section.style.display = 'none';
        title.classList.add('collapsed');
    }
}

// Initialize Group Info sections as open
document.addEventListener('DOMContentLoaded', function() {
    // All sections open by default
    document.getElementById('filesSection').style.display = 'block';
    document.getElementById('membersSection').style.display = 'grid';
    document.getElementById('recentImagesSection').style.display = 'grid';
    document.getElementById('sharedFilesSection').style.display = 'block';
});

// Member Actions Modal
let currentMemberId = null;
let currentMemberName = '';
let currentMemberRole = '';

function showMemberActions(userId, userName, userRole) {
    currentMemberId = userId;
    currentMemberName = userName;
    currentMemberRole = userRole;
    
    document.getElementById('memberActionsModal').classList.add('active');
    document.getElementById('memberActionsName').textContent = userName;
    
    // Show/hide promote options based on current role
    const isOwner = {{ currentUserParticipation and currentUserParticipation.isOwner() ? 'true' : 'false' }};
    const promoteSection = document.getElementById('promoteSection');
    
    if (isOwner && userRole !== 'OWNER') {
        promoteSection.style.display = 'block';
    } else {
        promoteSection.style.display = 'none';
    }
}

function closeMemberActionsModal() {
    document.getElementById('memberActionsModal').classList.remove('active');
}

async function removeMember() {
    if (!confirm(`tes-vous sr de vouloir exclure ${currentMemberName} ?`)) {
        return;
    }
    
    const goalId = {{ goal.id }};
    const csrfToken = '{{ csrf_token("remove_member") }}';
    
    try {
        const response = await fetch(`/goal/${goalId}/remove-member/${currentMemberId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({ _token: csrfToken })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Une erreur est survenue');
    }
    
    closeMemberActionsModal();
}

async function promoteMember(newRole) {
    if (!confirm(`Promouvoir ${currentMemberName} en ${newRole} ?`)) {
        return;
    }
    
    const goalId = {{ goal.id }};
    
    try {
        const formData = new FormData();
        formData.append('role', newRole);
        
        const response = await fetch(`/goal/${goalId}/promote-member/${currentMemberId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Une erreur est survenue');
    }
    
    closeMemberActionsModal();
}

// Close modal on outside click
document.addEventListener('click', function(e) {
    const modal = document.getElementById('memberActionsModal');
    if (e.target === modal) {
        closeMemberActionsModal();
    }
});

// Approve request
async function approveRequest(userId) {
    if (!confirm('Accepter cette demande d\'accs ?')) {
        return;
    }
    
    const goalId = {{ goal.id }};
    
    try {
        const response = await fetch(`/goal/${goalId}/approve-request/${userId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Une erreur est survenue');
    }
}

// Reject request
async function rejectRequest(userId) {
    if (!confirm('Refuser cette demande d\'accs ?')) {
        return;
    }
    
    const goalId = {{ goal.id }};
    
    try {
        const response = await fetch(`/goal/${goalId}/reject-request/${userId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert(result.message);
            location.reload();
        } else {
            alert('Erreur: ' + result.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Une erreur est survenue');
    }
}

</script>

<!-- Member Actions Modal -->
<div id="memberActionsModal" class="member-actions-modal">
    <div class="member-actions-content">
        <div class="member-actions-header">
            <div class="member-actions-title">
                <i class="fas fa-user-cog"></i> <span id="memberActionsName"></span>
            </div>
            <button class="member-actions-close" onclick="closeMemberActionsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="member-actions-list">
            <div id="promoteSection">
                {% if currentUserParticipation and currentUserParticipation.isOwner() %}
                    <button class="member-action-item" onclick="promoteMember('ADMIN')">
                        <i class="fas fa-user-shield"></i>
                        Promouvoir en Admin
                    </button>
                    <button class="member-action-item" onclick="promoteMember('MEMBER')">
                        <i class="fas fa-user"></i>
                        Rtrograder en Member
                    </button>
                {% endif %}
            </div>
            
            <button class="member-action-item danger" onclick="removeMember()">
                <i class="fas fa-user-times"></i>
                Exclure du goal
            </button>
        </div>
    </div>
</div>

{% endblock %}
