{% extends 'base.html.twig' %}

{% block title %}Mon profil{% endblock %}

{% block stylesheets %}
{{ parent() }}
<style>
    .profile-page {
        --profile-soft: #f5f3ff;
        --profile-violet: #7c3aed;
        --profile-violet-light: #a78bfa;
        --profile-pink: #ec4899;
        --profile-cyan: #22d3ee;
    }
    .profile-page {
        background: linear-gradient(160deg, #faf5ff 0%, #f0f9ff 50%, #fdf2f8 100%);
        min-height: 100%;
    }
    .profile-cover {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 35%, #ec4899 70%, #67e8f9 100%);
        height: 200px;
        border-radius: 0 0 2rem 2rem;
        position: relative;
        box-shadow: 0 20px 40px -15px rgba(139, 92, 246, 0.25);
    }
    .profile-cover::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: 0 0 2rem 2rem;
        background: linear-gradient(180deg, transparent 50%, rgba(0,0,0,0.03) 100%);
        pointer-events: none;
    }
    .profile-avatar-wrap {
        width: 112px;
        height: 112px;
        border-radius: 1.5rem;
        border: 4px solid white;
        box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
        overflow: hidden;
        background: linear-gradient(135deg, #e9d5ff 0%, #fce7f3 100%);
    }
    .profile-card {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.8);
        border-radius: 1.25rem;
        box-shadow: 0 4px 24px -4px rgba(124, 58, 237, 0.08);
    }
    .profile-card-side {
        background: white;
        border-radius: 1.25rem;
        border: 1px solid rgba(226, 232, 240, 0.8);
        box-shadow: 0 4px 20px -4px rgba(0,0,0,0.06);
    }
    .profile-label {
        font-size: 0.7rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #94a3b8;
    }
    .profile-value {
        color: #1e293b;
        font-weight: 500;
    }
    .profile-post-item {
        border-radius: 1rem;
        border: 1px solid #e2e8f0;
        background: white;
        transition: box-shadow 0.2s, border-color 0.2s;
    }
    .profile-post-item:hover {
        border-color: #c4b5fd;
        box-shadow: 0 8px 24px -8px rgba(124, 58, 237, 0.2);
    }
    .profile-empty-posts {
        background: linear-gradient(145deg, #faf5ff 0%, #fdf4ff 100%);
        border: 2px dashed #c4b5fd;
        border-radius: 1.25rem;
    }
    .profile-btn-back {
        color: #7c3aed;
        font-weight: 600;
        transition: color 0.2s;
    }
    .profile-btn-back:hover {
        color: #6d28d9;
    }
    .profile-link-posts {
        color: #7c3aed;
        font-weight: 600;
        font-size: 0.875rem;
    }
    .profile-link-posts:hover {
        color: #6d28d9;
    }
    /* Sidebar nav link with hover indicator */
    .profile-nav-link {
        display: flex;
        align-items: center;
        gap: 0.65rem;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: #475569;
        text-decoration: none;
        transition: all 0.2s;
        position: relative;
        border-left: 3px solid transparent;
    }
    .profile-nav-link:hover {
        background: #f5f3ff;
        color: #7c3aed;
        border-left-color: #a78bfa;
        padding-left: 1rem;
    }
    .profile-nav-link .nav-icon {
        width: 28px; height: 28px;
        border-radius: 7px;
        background: linear-gradient(135deg, #ede9fe, #fce7f3);
        color: #7c3aed;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.82rem;
        flex-shrink: 0;
        transition: all 0.2s;
    }
    .profile-nav-link:hover .nav-icon {
        background: linear-gradient(135deg, #7c3aed, #6366f1);
        color: white;
    }
    /* Upgraded post card */
    .profile-post-card {
        border-radius: 0.875rem;
        border: 1.5px solid #e8e4f5;
        background: white;
        padding: 1rem 1.125rem;
        transition: border-color 0.2s, box-shadow 0.2s, transform 0.2s;
        display: block;
        text-decoration: none;
        color: inherit;
    }
    .profile-post-card:hover {
        border-color: #a78bfa;
        box-shadow: 0 6px 24px rgba(124,58,237,0.12);
        transform: translateY(-2px);
        color: inherit;
    }
    .profile-post-title {
        font-size: 0.9375rem;
        font-weight: 700;
        color: #1e293b;
        margin-bottom: 0.3rem;
        transition: color 0.2s;
    }
    .profile-post-card:hover .profile-post-title { color: #7c3aed; }
    .profile-post-excerpt { font-size: 0.82rem; color: #64748b; line-height: 1.5; margin-bottom: 0.5rem; }
    .profile-post-meta { font-size: 0.75rem; color: #94a3b8; display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; }
    .profile-cta {
        background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        color: white;
        border: none;
        border-radius: 9999px;
        padding: 0.5rem 1.25rem;
        font-weight: 600;
        font-size: 0.875rem;
        box-shadow: 0 4px 14px -2px rgba(139, 92, 246, 0.4);
        transition: transform 0.15s, box-shadow 0.15s;
    }
    .profile-cta:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 20px -4px rgba(139, 92, 246, 0.45);
        color: white;
    }
    .profile-icon-box {
        width: 2.25rem;
        height: 2.25rem;
        border-radius: 0.75rem;
        background: linear-gradient(135deg, #ede9fe 0%, #fce7f3 100%);
        color: #7c3aed;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .profile-ai-teaser {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e1b4b 100%);
        border: 1px solid rgba(167, 139, 250, 0.3);
        border-radius: 1.25rem;
        padding: 1.25rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1.5rem;
        text-decoration: none;
        transition: border-color .2s, box-shadow .2s;
    }
    .profile-ai-teaser:hover {
        border-color: rgba(167, 139, 250, 0.7);
        box-shadow: 0 4px 24px rgba(124, 58, 237, 0.25);
    }
    .profile-ai-teaser-icon {
        width: 3rem;
        height: 3rem;
        border-radius: 0.875rem;
        background: linear-gradient(135deg, #7c3aed, #6366f1);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
        flex-shrink: 0;
        box-shadow: 0 4px 16px rgba(124, 58, 237, 0.4);
    }
    .profile-ai-teaser-body { flex: 1; min-width: 0; }
    .profile-ai-teaser-title { font-size: .9375rem; font-weight: 700; color: white; margin-bottom: .2rem; }
    .profile-ai-teaser-sub { font-size: .8125rem; color: rgba(196, 181, 253, 0.8); }
    .profile-ai-teaser-arrow { color: rgba(167, 139, 250, 0.6); font-size: 1.1rem; }
</style>
{% endblock %}

{% block body %}
<div class="profile-page">
    <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 pt-2 pb-12">
        {# Bannière + avatar #}
        <div class="profile-cover mb-10"></div>
        <div class="px-4 sm:px-0 -mt-24 relative z-10 flex flex-col sm:flex-row sm:items-end gap-4 sm:gap-6">
            <div class="profile-avatar-wrap flex-shrink-0 flex items-center justify-center text-4xl font-bold text-violet-600">
                {% if user.photoUrl %}
                    <img src="{{ user.photoUrl }}" alt="{{ user.firstName }}" class="w-full h-full object-cover">
                {% else %}
                    {{ user.firstName|first|upper }}{{ user.lastName|first|upper }}
                {% endif %}
            </div>
            <div class="profile-card flex-1 p-5 sm:p-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 tracking-tight">
                    {{ user.firstName }} {{ user.lastName }}
                </h1>
                <p class="text-slate-500 mt-0.5">{{ user.email }}</p>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 mt-8">
            {# Colonne infos #}
            <div class="lg:col-span-1 order-2 lg:order-1">
                <div class="profile-card-side p-6 sticky top-20">
                    <h2 class="text-base font-semibold text-slate-800 mb-5 flex items-center gap-2">
                        <span class="profile-icon-box"><i class="bi bi-person"></i></span>
                        Informations personnelles
                    </h2>
                    <dl class="space-y-4">
                        <div>
                            <dt class="profile-label">Email</dt>
                            <dd class="profile-value mt-0.5">{{ user.email }}</dd>
                        </div>
                        {% if user.phoneNumber %}
                        <div>
                            <dt class="profile-label">Téléphone</dt>
                            <dd class="profile-value mt-0.5">{{ user.phoneNumber }}</dd>
                        </div>
                        {% endif %}
                        {% if user.age %}
                        <div>
                            <dt class="profile-label">Âge</dt>
                            <dd class="profile-value mt-0.5">{{ user.age }} ans</dd>
                        </div>
                        {% endif %}
                        {% if user.bio %}
                        <div>
                            <dt class="profile-label">Bio</dt>
                            <dd class="mt-0.5 text-slate-600 text-sm leading-relaxed">{{ user.bio }}</dd>
                        </div>
                        {% endif %}
                        <div>
                            <dt class="profile-label">Membre depuis</dt>
                            <dd class="profile-value mt-0.5">{{ user.createdAt|date('d/m/Y') }}</dd>
                        </div>
                    </dl>
                    <div class="mt-6 pt-4 border-t border-slate-100" style="display:flex;flex-direction:column;gap:0.35rem;">
                        <a href="{{ path('app_login_history') }}" class="profile-nav-link">
                            <span class="nav-icon"><i class="bi bi-shield-lock"></i></span>
                            <span style="flex:1;">Historique de connexion</span>
                            {% if suspiciousLoginsCount > 0 %}
                                <span style="background:#fef3c7;color:#b45309;font-size:.7rem;font-weight:700;padding:.15rem .5rem;border-radius:50px;">{{ suspiciousLoginsCount }}</span>
                            {% endif %}
                            <i class="bi bi-chevron-right" style="font-size:.75rem;color:#cbd5e1;"></i>
                        </a>
                        <a href="{{ path('app_change_password') }}" class="profile-nav-link">
                            <span class="nav-icon"><i class="bi bi-key"></i></span>
                            <span style="flex:1;">Changer le mot de passe</span>
                            <i class="bi bi-chevron-right" style="font-size:.75rem;color:#cbd5e1;"></i>
                        </a>
                        <a href="{{ path('user_dashboard') }}" class="profile-nav-link" style="color:#7c3aed;">
                            <span class="nav-icon"><i class="bi bi-arrow-left"></i></span>
                            Tableau de bord
                        </a>
                    </div>
                </div>
            </div>

            {# Colonne publications + historique connexion #}
            <div class="lg:col-span-2 order-1 lg:order-2">
                {# Teaser Profil IA → page dédiée #}
                {% if hasOnboarded %}
                <a href="{{ path('app_user_ai_profile') }}" class="profile-ai-teaser">
                    <span class="profile-ai-teaser-icon"><i class="bi bi-magic"></i></span>
                    <div class="profile-ai-teaser-body">
                        <div class="profile-ai-teaser-title">
                            {% if user.archetypeName %}
                                {{ user.archetypeName }}
                            {% else %}
                                Profil de croissance IA
                            {% endif %}
                        </div>
                        <div class="profile-ai-teaser-sub">
                            {% if user.archetypeDescription %}
                                {{ user.archetypeDescription|slice(0, 80) }}…
                            {% else %}
                                Découvrez votre archétype, vos forces et vos suggestions d'habitudes →
                            {% endif %}
                        </div>
                    </div>
                    <span class="profile-ai-teaser-arrow"><i class="bi bi-chevron-right"></i></span>
                </a>
                {% else %}
                <a href="{{ path('app_onboarding') }}" class="profile-ai-teaser" style="background: linear-gradient(135deg, #1c1917 0%, #292524 100%); border-color: rgba(120,113,108,.3);">
                    <span class="profile-ai-teaser-icon" style="background: linear-gradient(135deg, #78716c, #57534e);"><i class="bi bi-robot"></i></span>
                    <div class="profile-ai-teaser-body">
                        <div class="profile-ai-teaser-title" style="color: rgba(255,255,255,.8);">Profil IA non créé</div>
                        <div class="profile-ai-teaser-sub" style="color: rgba(255,255,255,.45);">Complétez l'onboarding pour générer votre archétype personnalisé →</div>
                    </div>
                    <span class="profile-ai-teaser-arrow" style="color:rgba(255,255,255,.3);"><i class="bi bi-chevron-right"></i></span>
                </a>
                {% endif %}

                <div class="profile-card-side p-6">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-6">
                        <h2 class="text-base font-semibold text-slate-800 flex items-center gap-2">
                            <span class="profile-icon-box"><i class="bi bi-file-post"></i></span>
                            Mes publications
                        </h2>
                        <a href="{{ path('post_list_view', { filter: 'my_posts' }) }}" class="profile-link-posts inline-flex items-center gap-1">
                            Voir tout <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>

                    {% if posts|length > 0 %}
                        <div style="display:flex;flex-direction:column;gap:0.65rem;">
                            {% for post in posts %}
                                <a href="{{ path('post_list_view', { filter: 'my_posts' }) }}" class="profile-post-card">
                                    <div class="profile-post-title">{{ post.title }}</div>
                                    <div class="profile-post-excerpt">{{ post.content|striptags|slice(0, 110) }}{% if post.content|striptags|length > 110 %}…{% endif %}</div>
                                    <div class="profile-post-meta">
                                        <span><i class="bi bi-calendar3 me-1"></i>{{ post.createdAt|date('d/m/Y') }}</span>
                                        {% if post.postLikes|length > 0 %}
                                            <span><i class="bi bi-heart-fill me-1" style="color:#f43f5e;"></i>{{ post.postLikes|length }}</span>
                                        {% endif %}
                                        {% if post.comments|length > 0 %}
                                            <span><i class="bi bi-chat-dots me-1"></i>{{ post.comments|length }}</span>
                                        {% endif %}
                                    </div>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="profile-empty-posts text-center py-12 px-6">
                            <div class="w-14 h-14 rounded-2xl bg-white/80 flex items-center justify-center mx-auto mb-4 shadow-sm">
                                <i class="bi bi-file-post text-2xl text-violet-400"></i>
                            </div>
                            <p class="text-slate-600 font-medium">Aucune publication pour le moment</p>
                            <p class="text-sm text-slate-500 mt-1">Vos posts publiés apparaîtront ici.</p>
                            <a href="{{ path('post_list_view') }}" class="profile-cta inline-flex items-center gap-2 mt-5">
                                <i class="bi bi-plus-lg"></i> Voir les posts
                            </a>
                        </div>
                    {% endif %}
                </div>

                {# Historique de connexion #}
                <div class="profile-card-side p-6 mt-6">
                    <div class="flex items-center justify-between flex-wrap gap-3 mb-4">
                        <h2 class="text-base font-semibold text-slate-800 flex items-center gap-2">
                            <span class="profile-icon-box"><i class="bi bi-shield-lock"></i></span>
                            Historique de connexion
                            {% if suspiciousLoginsCount > 0 %}
                                <span class="text-amber-600 text-sm font-semibold">({{ suspiciousLoginsCount }} suspecte(s))</span>
                            {% endif %}
                        </h2>
                        <a href="{{ path('app_login_history') }}" class="profile-link-posts text-sm inline-flex items-center gap-1">
                            Voir tout <i class="bi bi-arrow-right"></i>
                        </a>
                    </div>
                    {% if recentLogins is empty %}
                        <p class="text-slate-500 text-sm">Aucune connexion enregistrée</p>
                    {% else %}
                        <ul class="space-y-3">
                            {% for login in recentLogins %}
                                <li class="flex items-start gap-3 p-3 rounded-xl {% if login.isSuspicious %}bg-amber-50 border border-amber-200{% else %}bg-slate-50 border border-slate-100{% endif %}">
                                    <span class="text-lg mt-0.5">{% if login.isSuspicious %}⚠️{% else %}✅{% endif %}</span>
                                    <div class="flex-1 min-w-0">
                                        <div class="text-sm font-medium text-slate-800">{{ login.loggedAt|date('d/m/Y à H:i') }}</div>
                                        <div class="text-xs text-slate-500 mt-0.5">{{ login.browserName }} · {{ login.deviceType }}</div>
                                        <div class="text-xs text-slate-400">IP : {{ login.ipAddress }}</div>
                                        {% if login.isSuspicious %}
                                            <span class="inline-block mt-1 text-xs font-semibold text-amber-700">Nouvelle connexion</span>
                                        {% endif %}
                                    </div>
                                </li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
