<!-- Create Post Glass Card (Hidden by default with animation) -->
<div class="create-post-glass-container mb-4" id="createPostCard" style="display: none; opacity: 0;">
    <!-- Create Post Form -->
    <div id="createPostFormContainer">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0" style="color: #2d3748; font-weight: 600;">Create New Post</h5>
            <button class="btn btn-drafts btn-sm" type="button" onclick="toggleDraftsView()">
                <i class="bi bi-file-earmark-text me-1"></i>
                View Drafts
            </button>
        </div>
        
        <form id="createPostForm" method="POST" action="{{ path('post_create_ajax') }}" enctype="multipart/form-data">
        <h5 class="mb-4" style="color: #2d3748; font-weight: 600;">Create New Post</h5>
        <!-- Title Input -->
        <div class="mb-4">
            <label for="postTitle" class="form-label" style="color: #4a5568; font-weight: 500;">Title</label>
            <input type="text" 
                   class="form-control input-glass" 
                   id="postTitle" 
                   name="title"
                   placeholder="Enter your post title" 
                   required>
        </div>
        
        <!-- Content Input with CKEditor -->
        <div class="mb-4">
            <label for="postContent" class="form-label" style="color: #4a5568; font-weight: 500;">Content</label>
            <div id="editor" style="min-height: 250px;"></div>
            <textarea id="postContent" name="content" style="display: none;" required></textarea>
        </div>

        <!-- Status Selection -->
        <div class="mb-4">
            <label for="postStatus" class="form-label" style="color: #4a5568; font-weight: 500;">Status</label>
            <select class="form-select input-glass" id="postStatus" name="status">
                <option value="published" selected>Publish Now</option>
                <option value="draft">Save as Draft</option>
            </select>
        </div>
        
        <!-- Action Buttons -->
        <div class="d-flex gap-3 justify-content-end mt-4 pt-3 border-top" style="border-color: rgba(168, 85, 247, 0.1) !important;">
            <button type="button" 
                    class="btn btn-glass px-5 py-2" 
                    onclick="toggleCreatePost()"
                    style="font-size: 1rem;">
                <i class="bi bi-x-circle me-2"></i>
                Cancel
            </button>
            <button type="submit" class="btn btn-primary-glass px-5 py-2" style="font-size: 1rem;">
                <i class="bi bi-send me-2"></i> 
                Publish
            </button>
        </div>
    </form>
    </div>
    
    <!-- Drafts List View (Hidden by default) -->
    <div id="draftsListContainer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h5 class="mb-0" style="color: #2d3748; font-weight: 600;">My Drafts</h5>
            <button class="btn btn-glass btn-sm" type="button" onclick="toggleDraftsView()">
                <i class="bi bi-arrow-left me-1"></i>
                Back to Create
            </button>
        </div>
        
        <div id="draftsList" class="vstack gap-3">
            <!-- Drafts will be loaded here via AJAX -->
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Edit Draft View (Hidden by default) -->
    <div id="editDraftContainer" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-glass btn-sm" type="button" onclick="backToDraftsList()">
                <i class="bi bi-arrow-left me-1"></i>
                Back to Drafts
            </button>
            <h5 class="mb-0" style="color: #2d3748; font-weight: 600;">Edit Draft</h5>
            <div style="width: 100px;"></div> <!-- Spacer for centering -->
        </div>
        
        <form id="editDraftForm" method="POST" action="{{ path('post_create_ajax') }}">
            <input type="hidden" id="editDraftId" name="id">
            
            <!-- Title Input -->
            <div class="mb-4">
                <label for="editDraftTitle" class="form-label" style="color: #4a5568; font-weight: 500;">Title</label>
                <input type="text" 
                       class="form-control input-glass" 
                       id="editDraftTitle" 
                       name="title"
                       placeholder="Enter your post title" 
                       required>
            </div>
            
            <!-- Content Input with CKEditor -->
            <div class="mb-4">
                <label for="editDraftContent" class="form-label" style="color: #4a5568; font-weight: 500;">Content</label>
                <div id="editDraftEditor" style="min-height: 250px;"></div>
                <textarea id="editDraftContent" name="content" style="display: none;" required></textarea>
            </div>

            <!-- Status Selection -->
            <div class="mb-4">
                <label for="editDraftStatus" class="form-label" style="color: #4a5568; font-weight: 500;">Status</label>
                <select class="form-select input-glass" id="editDraftStatus" name="status">
                    <option value="published">Publish Now</option>
                    <option value="draft">Keep as Draft</option>
                </select>
            </div>
            
            <!-- Action Buttons -->
            <div class="d-flex gap-3 justify-content-end mt-4 pt-3 border-top" style="border-color: rgba(168, 85, 247, 0.1) !important;">
                <button type="button" 
                        class="btn btn-glass px-5 py-2" 
                        onclick="cancelEditDraft()"
                        style="font-size: 1rem;">
                    <i class="bi bi-x-circle me-2"></i>
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary-glass px-5 py-2" style="font-size: 1rem;">
                    <i class="bi bi-save me-2"></i> 
                    Save
                </button>
            </div>
        </form>
    </div>
</div>

<style>
.draft-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 16px;
    border: 1px solid rgba(168, 85, 247, 0.1);
    transition: all 0.3s ease;
}

.draft-item:hover {
    background: rgba(255, 255, 255, 0.8);
    border-color: rgba(168, 85, 247, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(168, 85, 247, 0.15);
}

.draft-thumbnail {
    width: 120px;
    height: 80px;
    border-radius: 12px;
    object-fit: cover;
    flex-shrink: 0;
}

.draft-placeholder {
    width: 120px;
    height: 80px;
    border-radius: 12px;
    background: linear-gradient(135deg, #e9d5f5 0%, #f3e7f9 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.draft-content {
    flex-grow: 1;
    min-width: 0;
}

.draft-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.draft-preview {
    font-size: 0.9rem;
    color: #718096;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.draft-badge {
    background: rgba(168, 85, 247, 0.1);
    color: #7c3aed;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: 500;
    flex-shrink: 0;
}
</style>

<script>
let draftsLoaded = false;
let draftsData = []; // Store drafts globally

function toggleDraftsView() {
    const formContainer = document.getElementById('createPostFormContainer');
    const draftsContainer = document.getElementById('draftsListContainer');
    
    if (draftsContainer.style.display === 'none') {
        // Show drafts
        formContainer.style.display = 'none';
        draftsContainer.style.display = 'block';
        
        // Load drafts if not already loaded
        if (!draftsLoaded) {
            loadDrafts();
        }
    } else {
        // Show form
        draftsContainer.style.display = 'none';
        formContainer.style.display = 'block';
    }
}

async function loadDrafts() {
    const draftsList = document.getElementById('draftsList');
    
    try {
        const response = await fetch('{{ path('post_drafts_list') }}', {
            headers: {
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            throw new Error('Response is not JSON');
        }
        
        const data = await response.json();
        draftsData = data.drafts || []; // Store drafts globally
        
        if (draftsData.length > 0) {
            draftsList.innerHTML = data.drafts.map(draft => {
                // Extract first image from content if exists
                const imgMatch = draft.content.match(/<img[^>]+src="([^">]+)"/);
                const thumbnail = imgMatch ? imgMatch[1] : null;
                
                // Get text preview
                const textPreview = draft.content.replace(/<[^>]*>/g, '').substring(0, 100);
                
                return `
                    <div class="draft-item">
                        <div class="d-flex align-items-center gap-3 flex-grow-1" onclick="editDraft(${draft.id})" style="cursor: pointer;">
                            ${thumbnail ? 
                                `<img src="${thumbnail}" class="draft-thumbnail" alt="Draft thumbnail">` :
                                `<div class="draft-placeholder">
                                    <i class="bi bi-file-earmark-text" style="font-size: 2rem; color: #a855f7;"></i>
                                </div>`
                            }
                            <div class="draft-content">
                                <div class="draft-title">${draft.title || 'Untitled Draft'}</div>
                                <div class="draft-preview">${textPreview}...</div>
                            </div>
                            <span class="draft-badge">Draft</span>
                        </div>
                        
                        <div class="dropdown">
                            <button class="btn btn-link text-secondary p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation()">
                                <i class="bi bi-three-dots"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item" href="#" onclick="editDraft(${draft.id}); return false;">
                                        <i class="bi bi-pencil me-2"></i> Edit
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item text-danger" href="#" data-bs-toggle="modal" data-bs-target="#deleteDraftModal${draft.id}" onclick="event.stopPropagation()">
                                        <i class="bi bi-trash me-2"></i> Delete
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Delete Confirmation Modal for Draft ${draft.id} -->
                    <div class="modal fade" id="deleteDraftModal${draft.id}" tabindex="-1" aria-hidden="true" data-bs-backdrop="true">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content" style="background: white; border-radius: 20px; border: none; box-shadow: 0 8px 32px rgba(31, 38, 135, 0.3); z-index: 1060;">
                                <div class="modal-header border-0 pb-0">
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body text-center px-4 pb-4">
                                    <div class="mb-3">
                                        <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                                    </div>
                                    <h5 class="modal-title mb-2" style="color: #2d3748; font-weight: 600;">Delete Draft?</h5>
                                    <p class="text-muted mb-4">
                                        Are you sure you want to delete this draft? This action cannot be undone.
                                    </p>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal" style="border-radius: 20px;">Cancel</button>
                                        <button type="button" class="btn btn-danger px-4" onclick="confirmDeleteDraft(${draft.id})" data-bs-dismiss="modal" style="border-radius: 20px;">
                                            <i class="bi bi-trash me-1"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            draftsLoaded = true;
        } else {
            draftsList.innerHTML = `
                <div class="text-center py-5">
                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #cbd5e0;"></i>
                    <p class="text-muted mt-3 mb-0">No drafts yet</p>
                    <small class="text-muted">Your draft posts will appear here</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading drafts:', error);
        draftsList.innerHTML = `
            <div class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-circle me-2"></i>
                Failed to load drafts: ${error.message}
            </div>
        `;
    }
}

function editDraft(draftId) {
    console.log('Editing draft:', draftId);
    console.log('Available drafts:', draftsData);
    
    // Find draft from stored data
    const draft = draftsData.find(d => d.id === draftId);
    
    if (!draft) {
        console.error('Draft not found:', draftId);
        alert('Draft not found');
        return;
    }
    
    console.log('Found draft:', draft);
    
    // Show edit view
    document.getElementById('draftsListContainer').style.display = 'none';
    document.getElementById('editDraftContainer').style.display = 'block';
    
    // Populate form
    document.getElementById('editDraftId').value = draft.id;
    document.getElementById('editDraftTitle').value = draft.title || '';
    document.getElementById('editDraftStatus').value = 'draft';
    document.getElementById('editDraftContent').value = draft.content;
    
    // Initialize CKEditor if not already initialized
    if (!window.editDraftEditorInstance) {
        console.log('Initializing new editor with content');
        initializeEditDraftEditorAsync(draft.content);
    } else {
        console.log('Updating existing editor with content');
        window.editDraftEditorInstance.setData(draft.content);
        document.getElementById('editDraftContent').value = draft.content;
    }
}

function showEditDraftView(draft) {
    // Hide drafts list
    document.getElementById('draftsListContainer').style.display = 'none';
    // Show edit draft view
    document.getElementById('editDraftContainer').style.display = 'block';
    
    // Populate form
    document.getElementById('editDraftId').value = draft.id;
    document.getElementById('editDraftTitle').value = draft.title || '';
    document.getElementById('editDraftStatus').value = 'draft';
    
    // Initialize CKEditor for draft editing if not already initialized
    if (!window.editDraftEditorInstance) {
        initializeEditDraftEditor(draft.content);
    } else {
        window.editDraftEditorInstance.setData(draft.content);
    }
}

function backToDraftsList() {
    // Hide edit view
    document.getElementById('editDraftContainer').style.display = 'none';
    // Show drafts list
    document.getElementById('draftsListContainer').style.display = 'block';
    
    // Clear form
    document.getElementById('editDraftForm').reset();
    if (window.editDraftEditorInstance) {
        window.editDraftEditorInstance.setData('');
    }
}

function cancelEditDraft() {
    if (confirm('Are you sure you want to cancel? Any unsaved changes will be lost.')) {
        backToDraftsList();
    }
}

async function confirmDeleteDraft(draftId) {
    try {
        const response = await fetch(`/posts/${draftId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        if (response.ok) {
            // Reload drafts list
            draftsLoaded = false;
            loadDrafts();
        } else {
            alert('Failed to delete draft');
        }
    } catch (error) {
        console.error('Error deleting draft:', error);
        alert('Failed to delete draft');
    }
}
</script>

<script type="importmap">
{
    "imports": {
        "ckeditor5": "https://cdn.ckeditor.com/ckeditor5/43.3.1/ckeditor5.js",
        "ckeditor5/": "https://cdn.ckeditor.com/ckeditor5/43.3.1/"
    }
}
</script>

<script type="module">
import {
    ClassicEditor,
    Essentials,
    Bold,
    Italic,
    Paragraph,
    Heading,
    Link,
    List,
    BlockQuote,
    Image,
    ImageCaption,
    ImageToolbar,
    ImageUpload,
    SimpleUploadAdapter,
    Undo
} from 'ckeditor5';

// CKEditor instance
let editorInstance;
let editEditorInstances = {}; // Store edit editor instances by post ID
let uploadedImageCount = 0;
const MAX_IMAGES = 3;

// Initialize edit draft editor function (exposed globally)
window.initializeEditDraftEditorAsync = async function(initialContent = '') {
    const editorElement = document.querySelector('#editDraftEditor');
    
    if (!editorElement) {
        console.error('Editor element #editDraftEditor not found');
        return;
    }
    
    try {
        const editor = await ClassicEditor.create(editorElement, {
            plugins: [
                Essentials, Bold, Italic, Paragraph, Heading,
                Link, List, BlockQuote, ImageToolbar,
                Image, ImageCaption, ImageUpload, SimpleUploadAdapter,
                Undo
            ],
            toolbar: [
                'heading', '|',
                'bold', 'italic', '|',
                'link', 'uploadImage', 'blockQuote', '|',
                'bulletedList', 'numberedList', '|',
                'undo', 'redo'
            ],
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                ]
            },
            image: {
                toolbar: [
                    'toggleImageCaption',
                    'imageTextAlternative'
                ]
            },
            placeholder: "Write your post content here…",
            simpleUpload: {
                uploadUrl: '{{ path('post_upload_image') }}',
                withCredentials: true,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }
        });
        
        // Set initial content
        editor.setData(initialContent);
        
        // Store editor instance globally
        window.editDraftEditorInstance = editor;
        
        // Sync CKEditor content with hidden textarea
        editor.model.document.on('change:data', () => {
            document.getElementById('editDraftContent').value = editor.getData();
        });
        
        console.log('Edit Draft CKEditor initialized successfully');
    } catch (error) {
        console.error('Edit Draft CKEditor initialization error:', error);
        alert('Failed to initialize editor: ' + error.message);
    }
}

window.toggleCreatePost = function() {
    const createPostCard = document.getElementById('createPostCard');
    
    if (createPostCard.style.display === 'none') {
        // Show with animation
        createPostCard.style.display = 'block';
        setTimeout(() => {
            createPostCard.style.opacity = '1';
            createPostCard.style.transform = 'translateY(0)';
        }, 10);
        
        // Initialize CKEditor if not already initialized
        if (!editorInstance) {
            initializeCKEditor();
        }
    } else {
        // Hide with animation
        createPostCard.style.opacity = '0';
        createPostCard.style.transform = 'translateY(-20px)';
        setTimeout(() => {
            createPostCard.style.display = 'none';
            // Clear form when closing
            document.getElementById('createPostForm').reset();
            uploadedImageCount = 0;
            
            // Clear CKEditor content
            if (editorInstance) {
                editorInstance.setData('');
            }
        }, 300);
    }
}

// Edit post function
window.editPost = async function(postId) {
    // Hide view mode
    document.getElementById('postView' + postId).style.display = 'none';
    // Show edit mode
    document.getElementById('postEdit' + postId).style.display = 'block';
    
    // Get the textarea
    const textarea = document.getElementById('editContent' + postId);
    const existingContent = textarea.value;
    
    // Create a div to replace the textarea
    const editorDiv = document.createElement('div');
    editorDiv.id = 'editEditor' + postId;
    editorDiv.style.minHeight = '250px';
    
    // Replace textarea with div
    textarea.style.display = 'none';
    textarea.parentNode.insertBefore(editorDiv, textarea.nextSibling);
    
    // Initialize CKEditor on the div
    try {
        const editor = await ClassicEditor.create(editorDiv, {
            plugins: [
                Essentials, Bold, Italic, Paragraph, Heading,
                Link, List, BlockQuote,
                Image, ImageCaption, ImageUpload, SimpleUploadAdapter,
                Undo
            ],
            toolbar: [
                'heading', '|',
                'bold', 'italic', '|',
                'link', 'uploadImage', 'blockQuote', '|',
                'bulletedList', 'numberedList', '|',
                'undo', 'redo'
            ],
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                ]
            },
            image: {
                toolbar: [
                    'toggleImageCaption',
                    'imageTextAlternative'
                ]
            },
            placeholder: "Write your post content here…",
            simpleUpload: {
                uploadUrl: '/posts/upload-image',
                withCredentials: true,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }
        });
        
        // Set existing content
        editor.setData(existingContent);
        
        // Store editor instance
        editEditorInstances[postId] = editor;
        
        // Sync changes back to textarea
        editor.model.document.on('change:data', () => {
            textarea.value = editor.getData();
        });
        
        console.log('Edit editor initialized for post', postId);
    } catch (error) {
        console.error('Error initializing edit editor:', error);
        // Fallback: show textarea
        textarea.style.display = 'block';
        editorDiv.remove();
    }
}

// Cancel edit function
window.cancelEdit = function(postId) {
    // Destroy editor if exists
    if (editEditorInstances[postId]) {
        editEditorInstances[postId].destroy()
            .then(() => {
                delete editEditorInstances[postId];
                
                // Remove editor div
                const editorDiv = document.getElementById('editEditor' + postId);
                if (editorDiv) {
                    editorDiv.remove();
                }
                
                // Show textarea again
                const textarea = document.getElementById('editContent' + postId);
                if (textarea) {
                    textarea.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error destroying editor:', error);
            });
    }
    
    // Hide edit mode
    document.getElementById('postEdit' + postId).style.display = 'none';
    // Show view mode
    document.getElementById('postView' + postId).style.display = 'block';
}

function initializeCKEditor() {
    ClassicEditor
        .create(document.querySelector('#editor'), {
            plugins: [
                Essentials, Bold, Italic, Paragraph, Heading,
                Link, List, BlockQuote,ImageToolbar,
                Image, ImageCaption, ImageUpload, SimpleUploadAdapter,
                Undo
            ],
            toolbar: [
                'heading', '|',
                'bold', 'italic', '|',
                'link', 'uploadImage', 'blockQuote', '|',
                'bulletedList', 'numberedList', '|',
                'undo', 'redo'
            ],
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' }
                ]
            },
            image: {
                toolbar: [
                    'toggleImageCaption',
                    'imageTextAlternative'
                ]
            },
            placeholder: "Write your post content here…",
            simpleUpload: {
                uploadUrl: '{{ path('post_upload_image') }}',
                withCredentials: true,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            }
        })
        .then(editor => {
            editorInstance = editor;
            
            console.log('CKEditor initialized successfully');
            console.log('Available plugins:', Array.from(editor.plugins).map(p => p.constructor.pluginName));
            
            // Sync CKEditor content with hidden textarea
            editor.model.document.on('change:data', () => {
                document.getElementById('postContent').value = editor.getData();
            });
        })
        .catch(error => {
            console.error('CKEditor initialization error:', error);
            console.error('Error details:', error.message, error.stack);
            // Fallback: show a regular textarea if CKEditor fails
            document.getElementById('editor').innerHTML = '<textarea class="form-control textarea-glass" id="fallbackContent" name="content" rows="8" placeholder="Write your post content here…" required></textarea>';
        });
}


// Update file input before form submission
document.getElementById('createPostForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Sync CKEditor content one more time
    if (editorInstance) {
        const content = editorInstance.getData();
        document.getElementById('postContent').value = content;
        
        // Validate content is not empty
        if (!content.trim() || content.trim() === '<p>&nbsp;</p>' || content.trim() === '<p></p>') {
            alert('Please enter some content for your post');
            return false;
        }
    }
    
    // Submit the form
    this.submit();
});

// Edit draft form submission
document.getElementById('editDraftForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Sync CKEditor content
    if (window.editDraftEditorInstance) {
        const content = window.editDraftEditorInstance.getData();
        document.getElementById('editDraftContent').value = content;
        
        // Validate content is not empty
        if (!content.trim() || content.trim() === '<p>&nbsp;</p>' || content.trim() === '<p></p>') {
            alert('Please enter some content for your post');
            return false;
        }
    }
    
    const draftId = document.getElementById('editDraftId').value;
    const formData = new FormData(this);
    
    // Submit via AJAX
    fetch(`/posts/${draftId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            // Reload page to show updated post/draft
            window.location.reload();
        } else {
            alert('Failed to save draft');
        }
    })
    .catch(error => {
        console.error('Error saving draft:', error);
        alert('Failed to save draft');
    });
});
</script>
