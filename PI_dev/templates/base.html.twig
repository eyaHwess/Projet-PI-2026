<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>‚ö´Ô∏è</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">

        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        {% block stylesheets %}{% endblock %}
        <style>
            .notification-badge {
                position: relative;
                display: inline-block;
            }
            .notification-badge .badge-count {
                position: absolute;
                top: -8px;
                right: -8px;
                background: #ef4444;
                color: white;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 11px;
                font-weight: bold;
                border: 2px solid white;
                pointer-events: none;
            }
            .notification-badge .badge-count.hidden {
                display: none;
            }
            #notificationBtn {
                cursor: pointer;
                user-select: none;
            }
            #notificationBtn:active {
                transform: scale(0.95);
            }
            .notification-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 0.5rem;
                width: 320px;
                max-height: 400px;
                overflow-y: auto;
                background: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                display: none;
            }
            .notification-dropdown.show {
                display: block;
            }
            .notification-item {
                padding: 1rem;
                border-bottom: 1px solid #f3f4f6;
                transition: background 0.2s;
                cursor: pointer;
            }
            .notification-item:hover {
                background: #f9fafb;
            }
            .notification-item.unread {
                background: #eff6ff;
            }
            .notification-item.unread:hover {
                background: #dbeafe;
            }
            .notification-item:last-child {
                border-bottom: none;
            }
        </style>
    </head>
    <body class="min-h-screen bg-gray-50 antialiased">
        <nav class="bg-white border-b border-gray-200 shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between h-14 items-center">
                    <a href="{{ path('app_home') }}" class="flex items-center gap-2 text-gray-800 font-semibold hover:text-orange-500 transition">
                        <img src="{{ asset('images/logo.svg') }}" alt="Logo" class="h-8 w-auto" onerror="this.style.display='none'">
                        <span>Buildify</span>
                    </a>
                    <div class="flex items-center flex-wrap gap-3 sm:gap-5">
                        {% if app.user %}
                            {# Badge de notifications #}
                            <div class="notification-badge relative">
                                <div id="notificationBtn" onclick="window.toggleNotifications(event)" class="text-gray-600 hover:text-orange-500 text-lg relative cursor-pointer inline-block">
                                    <i class="bi bi-bell"></i>
                                    <span id="notificationCount" class="badge-count hidden">0</span>
                                </div>
                                <div id="notificationDropdown" class="notification-dropdown">
                                    <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                                        <h3 class="font-semibold text-gray-800">Notifications</h3>
                                        <button type="button" id="markAllRead" class="text-xs text-blue-600 hover:text-blue-700">Tout marquer lu</button>
                                    </div>
                                    <div id="notificationList">
                                        <div class="p-4 text-center text-gray-500 text-sm">
                                            Aucune notification
                                        </div>
                                    </div>
                                    <div class="p-2 border-t border-gray-200 text-center">
                                        <a href="{{ path('notification_list') }}" class="text-sm text-blue-600 hover:text-blue-700">Voir toutes les notifications</a>
                                    </div>
                                </div>
                            </div>
                            
                            {% if is_granted('ROLE_COACH') %}
                                {# Navbar coach : uniquement demandes + g√©rer sessions #}
                                <a href="{{ path('app_coaching_request_index') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Mes demandes</a>
                                <a href="{{ path('app_session_crud_index') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">G√©rer sessions</a>
                            {% else %}
                                {# Navbar utilisateur (demande de coaching) : uniquement demander + voir coaching #}
                                <a href="{{ path('app_coach_index') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Demander coaching</a>
                                <a href="{{ path('app_session_index') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Mes sessions</a>
                            {% endif %}
                            {% if is_granted('ROLE_ADMIN') %}
                                <a href="{{ path('admin_dashboard') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Admin</a>
                            {% endif %}
                            <span class="text-sm text-gray-500 border-l border-gray-200 pl-3">{{ app.user.firstName }} {{ app.user.lastName }}</span>
                            <a href="{{ path('app_logout') }}" class="text-sm text-red-600 hover:text-red-700 font-medium">D√©connexion</a>
                        {% else %}
                            <a href="{{ path('app_home') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Accueil</a>
                            <a href="{{ path('app_login') }}" class="text-gray-600 hover:text-orange-500 text-sm font-medium">Connexion</a>
                            <a href="{{ path('app_register') }}" class="text-sm font-medium px-3 py-1.5 rounded-md bg-orange-500 text-white hover:bg-orange-600">Inscription</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>

        <main class="pt-2 min-h-[calc(100vh-3.5rem)]">
            {% block body %}{% endblock %}
        </main>

        {% block javascripts %}
        {% if app.user %}
        {# Stocker l'ID utilisateur pour JavaScript #}
        <div data-user-id="{{ app.user.id }}" style="display: none;"></div>
        
        <script>
            console.log('üöÄ Script charg√©');
            
            // Variable globale pour l'√©tat du dropdown
            window.notificationDropdownOpen = false;
            
            // Fonction globale accessible depuis onclick
            window.toggleNotifications = function(e) {
                console.log('üñ±Ô∏è CLIC D√âTECT√â via onclick!');
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                const dropdown = document.getElementById('notificationDropdown');
                if (!dropdown) {
                    console.error('‚ùå Dropdown non trouv√©');
                    return;
                }
                
                window.notificationDropdownOpen = !window.notificationDropdownOpen;
                console.log('√âtat:', window.notificationDropdownOpen ? 'OUVERT' : 'FERM√â');
                
                if (window.notificationDropdownOpen) {
                    dropdown.classList.add('show');
                    dropdown.style.display = 'block';
                    console.log('‚úÖ Dropdown affich√©');
                    if (typeof loadNotifications === 'function') {
                        loadNotifications();
                    }
                } else {
                    dropdown.classList.remove('show');
                    dropdown.style.display = 'none';
                    console.log('‚úÖ Dropdown masqu√©');
                }
            };
            
            // Attendre que le DOM soit pr√™t
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNotifications);
            } else {
                initNotifications();
            }
            
            function initNotifications() {
                console.log('üîî Initialisation des notifications');
                
                const notificationBtn = document.getElementById('notificationBtn');
                const notificationDropdown = document.getElementById('notificationDropdown');
                const notificationCount = document.getElementById('notificationCount');
                const notificationList = document.getElementById('notificationList');
                const markAllReadBtn = document.getElementById('markAllRead');
                
                // V√©rification des √©l√©ments
                console.log('√âl√©ments trouv√©s:', {
                    btn: !!notificationBtn,
                    dropdown: !!notificationDropdown,
                    count: !!notificationCount,
                    list: !!notificationList
                });
                
                if (!notificationBtn) {
                    console.error('‚ùå Bouton de notification non trouv√©');
                    return;
                }
                
                if (!notificationDropdown) {
                    console.error('‚ùå Dropdown de notification non trouv√©');
                    return;
                }
                
                console.log('‚úÖ Tous les √©l√©ments sont pr√©sents');
                
                // Fermer en cliquant ailleurs
                document.addEventListener('click', function(e) {
                    if (window.notificationDropdownOpen && 
                        !notificationDropdown.contains(e.target) && 
                        !notificationBtn.contains(e.target)) {
                        console.log('üìÅ Fermeture (clic ext√©rieur)');
                        window.notificationDropdownOpen = false;
                        notificationDropdown.classList.remove('show');
                        notificationDropdown.style.display = 'none';
                    }
                });
                
                // Emp√™cher la fermeture en cliquant dans le dropdown
                notificationDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // Charger le compteur de notifications
                async function loadNotificationCount() {
                    try {
                        console.log('üìä Chargement du compteur...');
                        const res = await fetch('{{ path('notification_fetch') }}');
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        const data = await res.json();
                        console.log('‚úÖ Compteur re√ßu:', data.unreadCount);
                        
                        if (data.unreadCount > 0) {
                            notificationCount.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                            notificationCount.classList.remove('hidden');
                        } else {
                            notificationCount.classList.add('hidden');
                        }
                    } catch (err) {
                        console.error('‚ùå Erreur lors du chargement du compteur:', err);
                    }
                }
                
                // Charger les notifications
                async function loadNotifications() {
                    try {
                        console.log('üì• Chargement des notifications...');
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-hourglass-split"></i> Chargement...</div>';
                        
                        const res = await fetch('{{ path('notification_fetch') }}');
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        const data = await res.json();
                        console.log('‚úÖ Notifications re√ßues:', data);
                        
                        if (!data.notifications || data.notifications.length === 0) {
                            console.log('‚ÑπÔ∏è Aucune notification');
                            notificationList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-bell-slash"></i> Aucune notification</div>';
                            return;
                        }
                        
                        console.log(`‚úÖ ${data.notifications.length} notification(s) √† afficher`);
                        notificationList.innerHTML = data.notifications.map(notif => {
                            const icon = getNotificationIcon(notif.type);
                            const color = getNotificationColor(notif.type);
                            let timeAgo = 'Date inconnue';
                            
                            try {
                                if (notif.createdAt) {
                                    const date = new Date(notif.createdAt);
                                    timeAgo = getTimeAgo(date);
                                }
                            } catch (e) {
                                console.error('‚ùå Erreur parsing date:', e, notif.createdAt);
                            }
                            
                            return `
                                <div class="notification-item ${notif.isRead ? '' : 'unread'} cursor-pointer" 
                                     data-id="${notif.id}">
                                    <div class="flex gap-3">
                                        <div class="flex-shrink-0">
                                            <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center">
                                                <i class="bi ${icon} text-white"></i>
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-gray-800">${notif.message}</p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <i class="bi bi-clock"></i> ${timeAgo}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        // Ajouter les √©v√©nements de clic pour marquer comme lu
                        document.querySelectorAll('.notification-item').forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                const id = this.dataset.id;
                                console.log('üñ±Ô∏è Clic sur notification:', id);
                                markAsReadAndRedirect(id);
                            });
                        });
                    } catch (err) {
                        console.error('‚ùå Erreur lors du chargement des notifications:', err);
                        notificationList.innerHTML = '<div class="p-4 text-center text-red-500 text-sm"><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</div>';
                    }
                }
                
                // Marquer une notification comme lue
                async function markAsReadAndRedirect(id) {
                    try {
                        console.log('‚úîÔ∏è Marquage notification comme lue:', id);
                        const res = await fetch(`/notification/${id}/mark-read`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        
                        const result = await res.json();
                        console.log('‚úÖ Notification marqu√©e:', result);
                        
                        // Recharger les notifications
                        loadNotificationCount();
                        loadNotifications();
                    } catch (err) {
                        console.error('‚ùå Erreur lors du marquage:', err);
                    }
                }
                
                // Marquer toutes les notifications comme lues
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('‚úîÔ∏è Marquage de toutes les notifications');
                        try {
                            const res = await fetch('{{ path('notification_mark_all_read') }}', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (!res.ok) {
                                console.error('‚ùå Erreur HTTP:', res.status);
                                throw new Error('Erreur r√©seau');
                            }
                            
                            const result = await res.json();
                            console.log('‚úÖ Toutes les notifications marqu√©es:', result);
                            
                            loadNotificationCount();
                            loadNotifications();
                        } catch (err) {
                            console.error('‚ùå Erreur lors du marquage:', err);
                        }
                    });
                }
                
                // Obtenir l'ic√¥ne selon le type
                function getNotificationIcon(type) {
                    switch(type) {
                        case 'coaching_request': return 'bi-person-plus-fill';
                        case 'coaching_accepted': return 'bi-check-circle-fill';
                        case 'coaching_rejected': return 'bi-x-circle-fill';
                        case 'new_message': return 'bi-chat-fill';
                        case 'goal_invitation': return 'bi-bullseye';
                        default: return 'bi-bell-fill';
                    }
                }
                
                // Obtenir la couleur selon le type
                function getNotificationColor(type) {
                    switch(type) {
                        case 'coaching_request': return 'bg-blue-500';
                        case 'coaching_accepted': return 'bg-green-500';
                        case 'coaching_rejected': return 'bg-red-500';
                        case 'new_message': return 'bg-purple-500';
                        case 'goal_invitation': return 'bg-yellow-500';
                        default: return 'bg-blue-500';
                    }
                }
                
                // Calculer le temps √©coul√©
                function getTimeAgo(date) {
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000); // en secondes
                    
                    if (diff < 60) return '√Ä l\'instant';
                    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
                    if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
                    if (diff < 604800) return `Il y a ${Math.floor(diff / 86400)}j`;
                    return date.toLocaleDateString('fr-FR');
                }
                
                // Charger le compteur au d√©marrage
                console.log('üöÄ Chargement initial du compteur');
                loadNotificationCount();
                
                // Rafra√Æchir le compteur toutes les 30 secondes
                setInterval(loadNotificationCount, 30000);
                
                console.log('‚úÖ Initialisation termin√©e');
            } // Fin de initNotifications
        </script>
        {% endif %}
        {% endblock %}
    </body>
</html>
