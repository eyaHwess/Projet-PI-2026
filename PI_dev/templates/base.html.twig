<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 128 128%22><text y=%221.2em%22 font-size=%2296%22>‚ö´Ô∏è</text><text y=%221.3em%22 x=%220.2em%22 font-size=%2276%22 fill=%22%23fff%22>sf</text></svg>">

        <title>{% block title %}Welcome!{% endblock %}</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
        <link rel="stylesheet" href="{{ asset('navbar/navbar.css') }}">
        {% block stylesheets %}{% endblock %}
        <style>
            .notification-badge {
                position: relative;
                display: inline-block;
            }
            .notification-badge .badge-count {
                position: absolute;
                top: -8px;
                right: -8px;
                pointer-events: none;
            }
            .notification-badge .badge-count.hidden {
                display: none;
            }
            #notificationBtn:active {
                transform: scale(0.95);
            }
            .notification-dropdown {
                position: absolute;
                top: 100%;
                right: 0;
                margin-top: 0.5rem;
                width: 320px;
                max-height: 400px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            }
            .notification-dropdown.show {
                display: block;
            }
            .notification-item {
                padding: 1rem;
                border-bottom: 1px solid rgba(200, 182, 255, 0.2);
                transition: background 0.2s;
                cursor: pointer;
            }
            .notification-item:last-child {
                border-bottom: none;
            }
        </style>
    </head>
    <body class="min-h-screen bg-gray-50 antialiased">
        <nav class="soft-navbar sticky top-0 z-50">
            <div class="nav-container">
                <a href="{{ path('app_home') }}" class="flex items-center gap-2">
                    <img src="{{ asset('images/dayflow_logo.png') }}" alt="DayFlow Logo" onerror="this.style.display='none'">
                    <span class="logo-text">DayFlow</span>
                </a>
                <div class="flex items-center flex-wrap gap-2">
                    {% if app.user %}
                        <a href="{{ path('app_home') }}" class="nav-link">Accueil</a>
                        <a href="{{ path('post_list_view') }}" class="nav-link">Posts</a>
                        
                        {% if is_granted('ROLE_COACH') %}
                            <a href="{{ path('app_coaching_request_index') }}" class="nav-link">Mes demandes</a>
                            <a href="{{ path('app_session_crud_index') }}" class="nav-link">G√©rer sessions</a>
                        {% else %}
                            <a href="{{ path('app_coach_index') }}" class="nav-link">Demander coaching</a>
                            <a href="{{ path('app_session_index') }}" class="nav-link">Mes sessions</a>
                        {% endif %}
                        
                        {# Realtime Post/Comment Notifications (separate from coaching notifications) #}
                        <div class="notification-badge relative">
                            <div id="rtNotificationBtn" onclick="window.toggleRtNotifications(event)" title="Post notifications">
                                <i class="bi bi-bell-fill"></i>
                                <span id="rtNotificationCount" class="badge-count hidden">0</span>
                            </div>
                            <div id="rtNotificationDropdown" class="notification-dropdown">
                                <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                                    <h3 class="font-semibold text-gray-800">Post notifications</h3>
                                    <button type="button" id="rtMarkAllRead">Tout marquer lu</button>
                                </div>
                                <div id="rtNotificationList">
                                    <div class="p-4 text-center text-gray-500 text-sm">
                                        Aucune notification
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="notification-badge relative">
                            <div id="notificationBtn" onclick="window.toggleNotifications(event)">
                                <i class="bi bi-bell"></i>
                                <span id="notificationCount" class="badge-count hidden">0</span>
                            </div>
                            <div id="notificationDropdown" class="notification-dropdown">
                                <div class="p-3 border-b border-gray-200 flex justify-between items-center">
                                    <h3 class="font-semibold text-gray-800">Notifications</h3>
                                    <button type="button" id="markAllRead">Tout marquer lu</button>
                                </div>
                                <div id="notificationList">
                                    <div class="p-4 text-center text-gray-500 text-sm">
                                        Aucune notification
                                    </div>
                                </div>
                                <div class="p-2 border-t border-gray-200 text-center">
                                    <a href="{{ path('app_notifications_index') }}">Voir toutes les notifications</a>
                                </div>
                            </div>
                        </div>
                        
                        {% if is_granted('ROLE_ADMIN') %}
                            <a href="{{ path('admin_dashboard') }}" class="nav-link">Admin</a>
                        {% endif %}
                        <div class="divider"></div>
                        <span class="user-badge">{{ app.user.firstName }} {{ app.user.lastName }}</span>
                        <a href="{{ path('app_logout') }}" class="btn-logout">D√©connexion</a>
                    {% else %}
                        <a href="{{ path('app_home') }}" class="nav-link">Accueil</a>
                        <a href="{{ path('app_login') }}" class="nav-link">Connexion</a>
                        <a href="{{ path('app_register') }}" class="btn-primary-soft">Inscription</a>
                    {% endif %}
                </div>
            </div>
        </nav>

        <main class="pt-2 min-h-[calc(100vh-3.5rem)]">
            {% block body %}{% endblock %}
        </main>

        {% block javascripts %}
        {% if app.user %}
        <script>
            console.log('üöÄ Script charg√©');
            
            // Variable globale pour l'√©tat du dropdown
            window.notificationDropdownOpen = false;
            
            // Fonction globale accessible depuis onclick
            window.toggleNotifications = function(e) {
                console.log('üñ±Ô∏è CLIC D√âTECT√â via onclick!');
                if (e) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                
                const dropdown = document.getElementById('notificationDropdown');
                if (!dropdown) {
                    console.error('‚ùå Dropdown non trouv√©');
                    return;
                }
                
                window.notificationDropdownOpen = !window.notificationDropdownOpen;
                console.log('√âtat:', window.notificationDropdownOpen ? 'OUVERT' : 'FERM√â');
                
                if (window.notificationDropdownOpen) {
                    dropdown.classList.add('show');
                    dropdown.style.display = 'block';
                    console.log('‚úÖ Dropdown affich√©');
                    if (typeof loadNotifications === 'function') {
                        loadNotifications();
                    }
                } else {
                    dropdown.classList.remove('show');
                    dropdown.style.display = 'none';
                    console.log('‚úÖ Dropdown masqu√©');
                }
            };
            
            // Attendre que le DOM soit pr√™t
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initNotifications);
            } else {
                initNotifications();
            }
            
            function initNotifications() {
                console.log('üîî Initialisation des notifications');
                
                const notificationBtn = document.getElementById('notificationBtn');
                const notificationDropdown = document.getElementById('notificationDropdown');
                const notificationCount = document.getElementById('notificationCount');
                const notificationList = document.getElementById('notificationList');
                const markAllReadBtn = document.getElementById('markAllRead');
                
                // V√©rification des √©l√©ments
                console.log('√âl√©ments trouv√©s:', {
                    btn: !!notificationBtn,
                    dropdown: !!notificationDropdown,
                    count: !!notificationCount,
                    list: !!notificationList
                });
                
                if (!notificationBtn) {
                    console.error('‚ùå Bouton de notification non trouv√©');
                    return;
                }
                
                if (!notificationDropdown) {
                    console.error('‚ùå Dropdown de notification non trouv√©');
                    return;
                }
                
                console.log('‚úÖ Tous les √©l√©ments sont pr√©sents');
                
                // Fermer en cliquant ailleurs
                document.addEventListener('click', function(e) {
                    if (window.notificationDropdownOpen && 
                        !notificationDropdown.contains(e.target) && 
                        !notificationBtn.contains(e.target)) {
                        console.log('üìÅ Fermeture (clic ext√©rieur)');
                        window.notificationDropdownOpen = false;
                        notificationDropdown.classList.remove('show');
                        notificationDropdown.style.display = 'none';
                    }
                });
                
                // Emp√™cher la fermeture en cliquant dans le dropdown
                notificationDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                // Charger le compteur de notifications
                async function loadNotificationCount() {
                    try {
                        console.log('üìä Chargement du compteur...');
                        const res = await fetch('{{ path('app_notifications_unread_count') }}');
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        const data = await res.json();
                        console.log('‚úÖ Compteur re√ßu:', data.count);
                        
                        if (data.count > 0) {
                            notificationCount.textContent = data.count > 99 ? '99+' : data.count;
                            notificationCount.classList.remove('hidden');
                        } else {
                            notificationCount.classList.add('hidden');
                        }
                    } catch (err) {
                        console.error('‚ùå Erreur lors du chargement du compteur:', err);
                    }
                }
                
                // Charger les notifications
                async function loadNotifications() {
                    try {
                        console.log('üì• Chargement des notifications...');
                        notificationList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-hourglass-split"></i> Chargement...</div>';
                        
                        const res = await fetch('{{ path('app_notifications_unread') }}');
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        const data = await res.json();
                        console.log('‚úÖ Notifications re√ßues:', data);
                        
                        if (!data.notifications || data.notifications.length === 0) {
                            console.log('‚ÑπÔ∏è Aucune notification');
                            notificationList.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-bell-slash"></i> Aucune notification</div>';
                            return;
                        }
                        
                        console.log(`‚úÖ ${data.notifications.length} notification(s) √† afficher`);
                        notificationList.innerHTML = data.notifications.map(notif => {
                            const icon = getNotificationIcon(notif.type);
                            const color = getNotificationColor(notif.type);
                            let timeAgo = 'Date inconnue';
                            
                            try {
                                if (notif.createdAt) {
                                    const date = new Date(notif.createdAt.replace(' ', 'T'));
                                    timeAgo = getTimeAgo(date);
                                }
                            } catch (e) {
                                console.error('‚ùå Erreur parsing date:', e, notif.createdAt);
                            }
                            
                            return `
                                <div class="notification-item ${notif.isRead ? '' : 'unread'} cursor-pointer" 
                                     data-id="${notif.id}" 
                                     data-session-id="${notif.sessionId || ''}">
                                    <div class="flex gap-3">
                                        <div class="flex-shrink-0">
                                            <div class="w-10 h-10 rounded-full ${color} flex items-center justify-center">
                                                <i class="bi ${icon} text-white"></i>
                                            </div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm text-gray-800">${notif.message}</p>
                                            <p class="text-xs text-gray-500 mt-1">
                                                <i class="bi bi-clock"></i> ${timeAgo}
                                                ${notif.sessionId ? '<i class="bi bi-arrow-right ml-2"></i> Voir la session' : ''}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        // Ajouter les √©v√©nements de clic pour marquer comme lu et rediriger
                        document.querySelectorAll('.notification-item').forEach(item => {
                            item.addEventListener('click', function(e) {
                                e.preventDefault();
                                const id = this.dataset.id;
                                const sessionId = this.dataset.sessionId;
                                console.log('üñ±Ô∏è Clic sur notification:', id, 'Session:', sessionId);
                                markAsReadAndRedirect(id, sessionId);
                            });
                        });
                    } catch (err) {
                        console.error('‚ùå Erreur lors du chargement des notifications:', err);
                        notificationList.innerHTML = '<div class="p-4 text-center text-red-500 text-sm"><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</div>';
                    }
                }
                
                // Marquer une notification comme lue et rediriger
                async function markAsReadAndRedirect(id, sessionId) {
                    try {
                        console.log('‚úîÔ∏è Marquage notification comme lue:', id);
                        const res = await fetch(`/notifications/${id}/mark-read`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        if (!res.ok) {
                            console.error('‚ùå Erreur HTTP:', res.status);
                            throw new Error('Erreur r√©seau');
                        }
                        
                        const result = await res.json();
                        console.log('‚úÖ Notification marqu√©e:', result);
                        
                        // Rediriger vers la session si elle existe
                        if (sessionId) {
                            console.log('üîó Redirection vers la session:', sessionId);
                            window.location.href = `/sessions/${sessionId}`;
                        } else {
                            // Sinon, juste recharger les notifications
                            loadNotificationCount();
                            loadNotifications();
                        }
                    } catch (err) {
                        console.error('‚ùå Erreur lors du marquage:', err);
                    }
                }
                
                // Marquer toutes les notifications comme lues
                if (markAllReadBtn) {
                    markAllReadBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('‚úîÔ∏è Marquage de toutes les notifications');
                        try {
                            const res = await fetch('{{ path('app_notifications_mark_all_read') }}', {
                                method: 'POST',
                                headers: {
                                    'X-Requested-With': 'XMLHttpRequest',
                                    'Content-Type': 'application/json'
                                }
                            });
                            
                            if (!res.ok) {
                                console.error('‚ùå Erreur HTTP:', res.status);
                                throw new Error('Erreur r√©seau');
                            }
                            
                            const result = await res.json();
                            console.log('‚úÖ Toutes les notifications marqu√©es:', result);
                            
                            loadNotificationCount();
                            loadNotifications();
                        } catch (err) {
                            console.error('‚ùå Erreur lors du marquage:', err);
                        }
                    });
                }
                
                // Obtenir l'ic√¥ne selon le type
                function getNotificationIcon(type) {
                    switch(type) {
                        case 'request_accepted': return 'bi-check-circle-fill';
                        case 'request_declined': return 'bi-x-circle-fill';
                        case 'request_pending': return 'bi-clock-history';
                        case 'session_scheduled': return 'bi-calendar-check';
                        case 'session_confirmed': return 'bi-check2-circle';
                        default: return 'bi-bell-fill';
                    }
                }
                
                // Obtenir la couleur selon le type
                function getNotificationColor(type) {
                    switch(type) {
                        case 'request_accepted': return 'bg-green-500';
                        case 'request_declined': return 'bg-red-500';
                        case 'request_pending': return 'bg-yellow-500';
                        case 'session_scheduled': return 'bg-blue-500';
                        case 'session_confirmed': return 'bg-purple-500';
                        default: return 'bg-blue-500';
                    }
                }
                
                // Calculer le temps √©coul√©
                function getTimeAgo(date) {
                    const now = new Date();
                    const diff = Math.floor((now - date) / 1000); // en secondes
                    
                    if (diff < 60) return '√Ä l\'instant';
                    if (diff < 3600) return `Il y a ${Math.floor(diff / 60)} min`;
                    if (diff < 86400) return `Il y a ${Math.floor(diff / 3600)}h`;
                    if (diff < 604800) return `Il y a ${Math.floor(diff / 86400)}j`;
                    return date.toLocaleDateString('fr-FR');
                }
                
                // Charger le compteur au d√©marrage
                console.log('üöÄ Chargement initial du compteur');
                loadNotificationCount();
                
                // Rafra√Æchir le compteur toutes les 30 secondes
                setInterval(loadNotificationCount, 30000);
                
                /* ==========================================================
                   Realtime Post/Comment notifications (Mercure)
                   - separate from coaching notifications
                   ========================================================== */

                window.rtNotificationDropdownOpen = false;

                window.toggleRtNotifications = function(e) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    const dropdown = document.getElementById('rtNotificationDropdown');
                    const btn = document.getElementById('rtNotificationBtn');
                    if (!dropdown || !btn) return;

                    window.rtNotificationDropdownOpen = !window.rtNotificationDropdownOpen;
                    if (window.rtNotificationDropdownOpen) {
                        dropdown.classList.add('show');
                        dropdown.style.display = 'block';
                        if (typeof window.loadRtNotifications === 'function') {
                            window.loadRtNotifications();
                        }
                    } else {
                        dropdown.classList.remove('show');
                        dropdown.style.display = 'none';
                    }
                };

                const rtBtn = document.getElementById('rtNotificationBtn');
                const rtDropdown = document.getElementById('rtNotificationDropdown');
                const rtCountEl = document.getElementById('rtNotificationCount');
                const rtListEl = document.getElementById('rtNotificationList');
                const rtMarkAllBtn = document.getElementById('rtMarkAllRead');

                // Close on outside click
                document.addEventListener('click', function(e) {
                    if (window.rtNotificationDropdownOpen &&
                        rtDropdown &&
                        rtBtn &&
                        !rtDropdown.contains(e.target) &&
                        !rtBtn.contains(e.target)) {
                        window.rtNotificationDropdownOpen = false;
                        rtDropdown.classList.remove('show');
                        rtDropdown.style.display = 'none';
                    }
                });

                if (rtDropdown) {
                    rtDropdown.addEventListener('click', function(e) {
                        e.stopPropagation();
                    });
                }

                async function loadRtCount() {
                    try {
                        if (!rtCountEl) return;
                        const res = await fetch('{{ path('app_rt_notifications_unread_count') }}');
                        if (!res.ok) return;
                        const data = await res.json();

                        if (data.count > 0) {
                            rtCountEl.textContent = data.count > 99 ? '99+' : data.count;
                            rtCountEl.classList.remove('hidden');
                        } else {
                            rtCountEl.classList.add('hidden');
                        }
                    } catch (e) {
                        // ignore
                    }
                }

                function buildRtTargetUrl(notif) {
                    const base = '{{ path('post_list_view') }}';
                    if (notif.postId && notif.commentId) return `${base}#comment${notif.commentId}`;
                    if (notif.postId) return `${base}#post${notif.postId}`;
                    return base;
                }

                async function rtMarkReadAndGo(notif) {
                    try {
                        await fetch(`/rt-notifications/${notif.id}/mark-read`, {
                            method: 'POST',
                            headers: { 'X-Requested-With': 'XMLHttpRequest' }
                        });
                    } catch (e) {
                        // ignore
                    }
                    window.location.href = buildRtTargetUrl(notif);
                }

                window.loadRtNotifications = async function() {
                    if (!rtListEl) return;

                    try {
                        rtListEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-hourglass-split"></i> Chargement...</div>';
                        const res = await fetch('{{ path('app_rt_notifications_recent') }}');
                        if (!res.ok) throw new Error('network');
                        const data = await res.json();
                        const items = data.notifications || [];

                        if (items.length === 0) {
                            rtListEl.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm"><i class="bi bi-bell-slash"></i> Aucune notification</div>';
                            return;
                        }

                        rtListEl.innerHTML = items.map(n => `
                            <div class="notification-item ${n.isRead ? '' : 'unread'} cursor-pointer" data-id="${n.id}">
                                <div class="text-sm text-gray-800">${n.message}</div>
                                <div class="text-xs text-gray-500 mt-1">
                                    <i class="bi bi-clock"></i> ${n.createdAt ? new Date(n.createdAt).toLocaleString() : ''}
                                </div>
                            </div>
                        `).join('');

                        rtListEl.querySelectorAll('.notification-item').forEach(el => {
                            el.addEventListener('click', () => {
                                const id = parseInt(el.dataset.id, 10);
                                const notif = items.find(x => x.id === id);
                                if (notif) rtMarkReadAndGo(notif);
                            });
                        });
                    } catch (e) {
                        rtListEl.innerHTML = '<div class="p-4 text-center text-red-500 text-sm"><i class="bi bi-exclamation-triangle"></i> Erreur de chargement</div>';
                    } finally {
                        loadRtCount();
                    }
                };

                if (rtMarkAllBtn) {
                    rtMarkAllBtn.addEventListener('click', async function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        try {
                            await fetch('{{ path('app_rt_notifications_mark_all_read') }}', {
                                method: 'POST',
                                headers: { 'X-Requested-With': 'XMLHttpRequest' }
                            });
                            loadRtCount();
                            if (window.rtNotificationDropdownOpen) {
                                window.loadRtNotifications();
                            }
                        } catch (e) {
                            // ignore
                        }
                    });
                }

                // Initial load
                loadRtCount();

                // Mercure subscription: sets mercureAuthorization cookie + returns hub URL with topic
                try {
                    const rtMercureUrl = "{{ mercure(['user/' ~ app.user.id ~ '/rt-notifications'], { subscribe: ['user/' ~ app.user.id ~ '/rt-notifications'] })|e('js') }}";
                    const es = new EventSource(rtMercureUrl);
                    es.onmessage = () => {
                        loadRtCount();
                        if (window.rtNotificationDropdownOpen) {
                            window.loadRtNotifications();
                        }
                    };
                } catch (e) {
                    // ignore
                }

                console.log('‚úÖ Initialisation termin√©e');
            } // Fin de initNotifications
        </script>
        {% endif %}
        {% endblock %}
    </body>
</html>