{% extends 'base_modern.html.twig' %}

{% block title %}Mes Objectifs{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
        }
        
        /* Glass morphism styles */
        .glass-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        }
        
        .glass-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .glass-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            color: white;
        }
        
        .glass-btn-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        
        .glass-search {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            color: white;
            width: 100%;
            outline: none;
        }
        
        .glass-search::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(31, 38, 135, 0.25);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: white;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }
        
        .goal-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .goal-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 15px 45px rgba(31, 38, 135, 0.3);
        }
        
        .goal-icon {
            width: 60px;
            height: 60px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 1rem;
        }
        
        .goal-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .goal-description {
            color: rgba(255, 255, 255, 0.85);
            font-size: 0.875rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }
        
        .progress-bar-glass {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            height: 8px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
            border-radius: 50px;
            transition: width 0.5s ease;
        }
        
        .badge-glass {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
            display: inline-block;
            margin-right: 0.5rem;
        }
        
        .icon-btn-glass {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            margin-right: 0.5rem;
        }
        
        .icon-btn-glass:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .page-header {
            color: white;
            margin-bottom: 2rem;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.125rem;
        }
        
        .filters-container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 1.5rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .filter-select {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50px;
            padding: 0.75rem 1.5rem;
            color: white;
            outline: none;
            cursor: pointer;
        }
        
        .filter-select option {
            background: #667eea;
            color: white;
        }
        
        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .goals-grid {
                grid-template-columns: 1fr;
            }
            
            .page-title {
                font-size: 2rem;
            }
        }
    </style>
{% endblock %}

{% block navbar_actions %}
    <button class="glass-btn glass-btn-gradient" onclick="openGoalModal('new')">
        <i class="bi bi-plus-circle"></i> Nouvel Objectif
    </button>
{% endblock %}

{% block body %}
    <div style="padding: 2rem;">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">
                <i class="bi bi-bullseye"></i> Hello {{ app.user ? app.user.firstName : 'Ruha' }}
            </h1>
            <p class="page-subtitle">Good day to learn</p>
        </div>

        <!-- Statistics Cards -->
        {% if pagination|length > 0 %}
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{ statsActiveCount }}</div>
                <div class="stat-label">Actifs</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ statsCompletedCount }}</div>
                <div class="stat-label">Termin√©s</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ statsPausedCount }}</div>
                <div class="stat-label">En pause</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">{{ statsFailedCount }}</div>
                <div class="stat-label">√âchou√©s</div>
            </div>
        </div>
        {% endif %}

        <!-- AI Suggestions Carousel -->
        {% if aiSuggestions is defined and aiSuggestions %}
        <div class="glass-card" style="margin-bottom: 2rem;">
            <h2 style="color: white; font-size: 1.5rem; margin-bottom: 1rem;">
                <i class="bi bi-stars"></i> Suggestions IA
            </h2>
            <div style="display: flex; gap: 1rem; overflow-x: auto; padding-bottom: 1rem;">
                {% for suggestion in aiSuggestions %}
                <div class="glass-card" style="min-width: 300px; cursor: pointer;" 
                     onclick="adoptSuggestion('{{ suggestion.title|e('js') }}', '{{ suggestion.description|e('js') }}', '{{ suggestion.priority }}', {{ suggestion.duration_days }})">
                    <span class="badge-glass">{{ suggestion.priority|upper }}</span>
                    <h3 style="color: white; font-size: 1.125rem; margin: 0.75rem 0;">{{ suggestion.title }}</h3>
                    <p style="color: rgba(255, 255, 255, 0.85); font-size: 0.875rem; margin-bottom: 1rem;">
                        {{ suggestion.description }}
                    </p>
                    <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: rgba(255, 255, 255, 0.9);">
                        <span><i class="bi bi-calendar-check"></i> {{ suggestion.duration_days }} jours</span>
                        <span><i class="bi bi-flag-fill"></i> {{ suggestion.priority }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Filters -->
        <div class="filters-container">
            <input type="text" 
                   id="searchInput" 
                   class="glass-search" 
                   placeholder="üîç Rechercher un objectif..."
                   value="{{ searchQuery }}"
                   style="flex: 1; min-width: 250px;">
            
            <select id="statusFilter" class="filter-select">
                <option value="all" {{ currentStatus == 'all' ? 'selected' : '' }}>Tous les statuts</option>
                <option value="draft" {{ currentStatus == 'draft' ? 'selected' : '' }}>Brouillon</option>
                <option value="active" {{ currentStatus == 'active' ? 'selected' : '' }}>Actif</option>
                <option value="paused" {{ currentStatus == 'paused' ? 'selected' : '' }}>En pause</option>
                <option value="completed" {{ currentStatus == 'completed' ? 'selected' : '' }}>Termin√©</option>
                <option value="failed" {{ currentStatus == 'failed' ? 'selected' : '' }}>√âchou√©</option>
            </select>
            
            <select id="sortSelect" class="filter-select">
                <option value="urgency-DESC">‚ö° Plus urgent</option>
                <option value="createdAt-DESC">Plus r√©cent</option>
                <option value="createdAt-ASC">Plus ancien</option>
                <option value="deadline-ASC">Deadline proche</option>
            </select>
        </div>

        <!-- Goals Grid -->
        {% if pagination|length > 0 %}
        <div class="goals-grid">
            {% for goal in pagination %}
            <div class="goal-card" onclick="window.location.href='{{ path('app_goal_show', {id: goal.id}) }}'">
                <div class="goal-icon">
                    <i class="bi bi-bullseye"></i>
                </div>
                
                <h3 class="goal-title">{{ goal.title }}</h3>
                
                {% if goal.description %}
                <p class="goal-description">
                    {{ goal.description|slice(0, 100) }}{% if goal.description|length > 100 %}...{% endif %}
                </p>
                {% endif %}
                
                <div style="margin-bottom: 1rem;">
                    <span class="badge-glass">{{ goal.status|upper }}</span>
                    {% if goal.getPriority() %}
                    <span class="badge-glass">{{ goal.getPriority()|upper }}</span>
                    {% endif %}
                </div>
                
                <div class="progress-bar-glass">
                    <div class="progress-fill" style="width: {{ goal.progressPercentage }}%;"></div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">
                    <span>{{ goal.progressPercentage }}% compl√©t√©</span>
                    <div>
                        <button class="icon-btn-glass" onclick="event.stopPropagation(); openGoalModal('edit', {{ goal.id }})">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="icon-btn-glass" onclick="event.stopPropagation(); deleteGoal({{ goal.id }}, '{{ goal.title }}', '{{ csrf_token('delete' ~ goal.id) }}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="glass-card" style="text-align: center; padding: 3rem;">
            <div style="font-size: 4rem; margin-bottom: 1rem;">üéØ</div>
            <h2 style="color: white; font-size: 2rem; margin-bottom: 1rem;">Commencez votre parcours</h2>
            <p style="color: rgba(255, 255, 255, 0.9); margin-bottom: 2rem;">
                Cr√©ez votre premier objectif pour suivre vos progr√®s
            </p>
            <button class="glass-btn glass-btn-gradient" onclick="openGoalModal('new')">
                <i class="bi bi-plus-circle"></i> Cr√©er mon premier objectif
            </button>
        </div>
        {% endif %}

        <!-- Pagination -->
        {% if pagination.pageCount > 1 %}
        <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 2rem;">
            {% if pagination.currentPageNumber > 1 %}
            <a href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({page: pagination.currentPageNumber - 1})) }}" 
               class="glass-btn">
                <i class="bi bi-chevron-left"></i> Pr√©c√©dent
            </a>
            {% endif %}
            
            <span class="glass-btn">Page {{ pagination.currentPageNumber }} / {{ pagination.pageCount }}</span>
            
            {% if pagination.currentPageNumber < pagination.pageCount %}
            <a href="{{ path(app.request.attributes.get('_route'), app.request.query.all|merge({page: pagination.currentPageNumber + 1})) }}" 
               class="glass-btn">
                Suivant <i class="bi bi-chevron-right"></i>
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script>
        function openGoalModal(action, goalId = null) {
            const url = action === 'new' 
                ? '{{ path('app_goal_new') }}'
                : '{{ path('app_goal_edit', {id: '__ID__'}) }}'.replace('__ID__', goalId);
            window.location.href = url;
        }
        
        async function deleteGoal(goalId, title, csrfToken) {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${title}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/goals/${goalId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `_token=${encodeURIComponent(csrfToken)}`
                });
                
                const data = await response.json();
                if (data.success) {
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        function adoptSuggestion(title, description, priority, durationDays) {
            const url = new URL('{{ path('app_goal_new_from_suggestion') }}', window.location.origin);
            url.searchParams.append('title', title);
            url.searchParams.append('description', description);
            url.searchParams.append('priority', priority);
            url.searchParams.append('duration_days', durationDays);
            window.location.href = url.toString();
        }
        
        // Filters
        const sortSelect = document.getElementById('sortSelect');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        
        if (sortSelect) sortSelect.addEventListener('change', applyFilters);
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(applyFilters, 500);
            });
        }
        
        function applyFilters() {
            const sortValue = sortSelect ? sortSelect.value : 'createdAt-DESC';
            const statusValue = statusFilter ? statusFilter.value : 'all';
            const searchValue = searchInput ? searchInput.value : '';
            
            const [sort, order] = sortValue.split('-');
            
            const url = new URL(window.location.href);
            url.searchParams.set('sort', sort);
            url.searchParams.set('order', order);
            url.searchParams.set('status', statusValue);
            
            if (searchValue) {
                url.searchParams.set('search', searchValue);
            } else {
                url.searchParams.delete('search');
            }
            
            window.location.href = url.toString();
        }
    </script>
{% endblock %}
