{% extends 'base.html.twig' %}

{% block title %}{{ goal.title }}{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
<style>
    :root {
        --ind: #6366f1;
        --ind-dark: #4338ca;
        --ind-light: #eef2ff;
    }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8f9fb;
    }
    /* ── Hero Banner ── */
    .goal-hero {
        background: linear-gradient(135deg, #1e1b4b 0%, #312e81 55%, #1e3a5f 100%);
        padding: 5.5rem 0 3rem;
        position: relative;
        overflow: hidden;
    }
    .goal-hero::before {
        content: '';
        position: absolute;
        top: -80px; right: -80px;
        width: 420px; height: 420px;
        background: radial-gradient(circle, rgba(99,102,241,0.22) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .goal-hero::after {
        content: '';
        position: absolute;
        bottom: -60px; left: 5%;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(167,139,250,0.15) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .hero-back-link {
        color: rgba(255,255,255,0.55);
        font-size: 0.85rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 1.5rem;
        transition: color 0.2s;
        position: relative; z-index: 1;
    }
    .hero-back-link:hover { color: white; }
    .hero-status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.3rem 0.85rem;
        border-radius: 50px;
        font-size: 0.72rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        margin-bottom: 0.85rem;
        position: relative; z-index: 1;
    }
    .badge-active    { background: rgba(96,211,148,0.15); color: #6ee7b7; border: 1px solid rgba(96,211,148,0.3); }
    .badge-completed { background: rgba(96,165,250,0.15); color: #93c5fd; border: 1px solid rgba(96,165,250,0.3); }
    .badge-paused    { background: rgba(251,191,36,0.15);  color: #fcd34d; border: 1px solid rgba(251,191,36,0.3); }
    .badge-draft     { background: rgba(255,255,255,0.08); color: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.15); }
    .badge-failed    { background: rgba(248,113,113,0.15); color: #fca5a5; border: 1px solid rgba(248,113,113,0.3); }
    .hero-title {
        font-size: clamp(1.75rem, 4vw, 2.5rem);
        font-weight: 900;
        color: white;
        letter-spacing: -0.03em;
        line-height: 1.15;
        margin-bottom: 0.6rem;
        position: relative; z-index: 1;
    }
    .hero-desc {
        font-size: 1rem;
        color: rgba(255,255,255,0.6);
        margin-bottom: 2rem;
        position: relative; z-index: 1;
    }
    /* Stat chips in hero */
    .hero-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 0.65rem;
        position: relative; z-index: 1;
        margin-bottom: 2rem;
    }
    .hero-chip {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 50px;
        padding: 0.35rem 0.9rem;
        font-size: 0.8rem;
        color: rgba(255,255,255,0.7);
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }
    .hero-chip i { font-size: 0.85rem; }
    /* Progress bar in hero */
    .hero-progress-wrap {
        position: relative; z-index: 1;
        max-width: 500px;
    }
    .hero-progress-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    .hero-progress-label span:first-child {
        font-size: 0.82rem;
        font-weight: 600;
        color: rgba(255,255,255,0.6);
    }
    .hero-progress-label span:last-child {
        font-size: 1.1rem;
        font-weight: 800;
        color: white;
    }
    .hero-progress-track {
        height: 8px;
        background: rgba(255,255,255,0.1);
        border-radius: 99px;
        overflow: hidden;
    }
    .hero-progress-fill {
        height: 100%;
        border-radius: 99px;
        background: linear-gradient(90deg, #818cf8, #a78bfa);
        transition: width 0.8s ease;
    }
    /* Hero action buttons */
    .hero-actions {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
        position: relative; z-index: 1;
        margin-top: 2rem;
    }
    .btn-hero-primary {
        padding: 0.65rem 1.4rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.2s;
        box-shadow: 0 4px 14px rgba(99,102,241,0.4);
    }
    .btn-hero-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(99,102,241,0.5); color: white; }
    .btn-hero-secondary {
        padding: 0.65rem 1.4rem;
        background: rgba(255,255,255,0.1);
        color: rgba(255,255,255,0.85);
        border: 1px solid rgba(255,255,255,0.2);
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        transition: all 0.2s;
    }
    .btn-hero-secondary:hover { background: rgba(255,255,255,0.18); color: white; }
    /* ── Main content ── */
    .goal-content {
        padding: 2.5rem 0 4rem;
    }
    /* Section headers */
    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f0f0f4;
    }
    .section-title {
        font-size: 1.1rem;
        font-weight: 800;
        color: #111827;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin: 0;
    }
    .section-title i { color: var(--ind); }
    /* Chart cards */
    .chart-card {
        background: white;
        border: 2px solid #eef0f4;
        border-radius: 1.25rem;
        overflow: hidden;
        box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: box-shadow 0.2s, border-color 0.2s;
    }
    .chart-card:hover {
        box-shadow: 0 8px 28px rgba(99,102,241,0.12);
        border-color: #c7d2fe;
    }
    .chart-card-header {
        background: linear-gradient(135deg, #eef2ff 0%, #f5f3ff 100%);
        padding: 0.875rem 1.25rem;
        border-bottom: 2px solid #e0e7ff;
        display: flex;
        align-items: center;
        gap: 0.65rem;
    }
    .ch-icon {
        width: 32px; height: 32px;
        background: linear-gradient(135deg, var(--ind), #8b5cf6);
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        color: white;
        font-size: 0.85rem;
        flex-shrink: 0;
        box-shadow: 0 4px 10px rgba(99,102,241,0.3);
    }
    .chart-card-header h3 { font-size: 0.88rem; font-weight: 700; color: #1e293b; margin: 0; }
    .chart-card-header p  { font-size: 0.73rem; color: #6b7280; margin: 0; line-height: 1.3; }
    .chart-card-body {
        padding: 1.25rem;
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .chart-card-body canvas { max-height: 260px !important; }
    /* Routine cards */
    .routine-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1.25rem; }
    .routine-card {
        background: white;
        border: 2px solid #eef0f4;
        border-radius: 1.25rem;
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    .routine-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0;
        width: 4px;
        height: 100%;
        background: linear-gradient(180deg, #818cf8, #c084fc);
        border-radius: 1.25rem 0 0 1.25rem;
    }
    .routine-card:hover {
        border-color: #c7d2fe;
        box-shadow: 0 8px 28px rgba(99,102,241,0.12);
        transform: translateY(-3px);
    }
    .routine-card-title { font-size: 1rem; font-weight: 700; color: #111827; margin: 0; }
    .routine-card-desc { font-size: 0.85rem; color: #6b7280; line-height: 1.5; flex: 1; }
    .routine-card-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding-top: 0.75rem;
        border-top: 1px solid #f0f0f4;
    }
    .routine-card-meta {
        font-size: 0.78rem;
        color: #9ca3af;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }
    .vis-badge {
        font-size: 0.68rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        padding: 0.2rem 0.6rem;
        border-radius: 50px;
    }
    .vis-public  { background: #d1fae5; color: #065f46; }
    .vis-private { background: #fef3c7; color: #92400e; }
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border: 2px dashed #e0e7ff;
        border-radius: 1.25rem;
    }
    .empty-icon {
        width: 80px; height: 80px;
        background: linear-gradient(135deg, #eef2ff, #f5f3ff);
        border-radius: 1.25rem;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.2rem;
        color: var(--ind);
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 24px rgba(99,102,241,0.15);
    }
</style>
{% endblock %}

{% block body %}

{# ── Hero ── #}
<div class="goal-hero">
    <div class="container">
        <a href="{{ path('app_goal_index') }}" class="hero-back-link">
            <i class="bi bi-arrow-left"></i> Mes objectifs
        </a>

        <div class="hero-status-badge badge-{{ goal.status|lower }}">
            <i class="bi bi-circle-fill" style="font-size:0.5rem;"></i>
            {{ goal.status|upper }}
        </div>

        <h1 class="hero-title">{{ goal.title }}</h1>
        {% if goal.description %}
            <p class="hero-desc">{{ goal.description }}</p>
        {% endif %}

        <div class="hero-chips">
            <div class="hero-chip">
                <i class="bi bi-calendar-event"></i>
                {{ goal.startDate|date('d/m/Y') }}
            </div>
            <div class="hero-chip">
                <i class="bi bi-calendar-check"></i>
                {{ goal.endDate|date('d/m/Y') }}
            </div>
            {% if goal.priority %}
            <div class="hero-chip">
                <i class="bi bi-flag-fill"></i>
                Priorité {{ goal.priority|capitalize }}
            </div>
            {% endif %}
            <div class="hero-chip">
                <i class="bi bi-arrow-repeat"></i>
                {{ goal.routines|length }} routine{{ goal.routines|length != 1 ? 's' : '' }}
            </div>
        </div>

        <div class="hero-progress-wrap">
            <div class="hero-progress-label">
                <span>Progression globale</span>
                <span>{{ goal.progressPercentage }}%</span>
            </div>
            <div class="hero-progress-track">
                <div class="hero-progress-fill" style="width: {{ goal.progressPercentage }}%;"></div>
            </div>
        </div>

        <div class="hero-actions">
            <a href="{{ path('app_routine_new', {goalId: goal.id}) }}" class="btn-hero-primary">
                <i class="bi bi-plus-circle"></i> Nouvelle routine
            </a>
            <a href="{{ path('app_goal_edit', {id: goal.id}) }}" class="btn-hero-secondary">
                <i class="bi bi-pencil"></i> Modifier
            </a>
        </div>
    </div>
</div>

{# ── Content ── #}
<div class="goal-content">
    <div class="container">

        {# Analytics #}
        <div class="section-header mb-4" style="margin-top:0;">
            <h2 class="section-title"><i class="bi bi-bar-chart-line-fill"></i> Analytique</h2>
        </div>
        <div class="row g-4 mb-5">
            <div class="col-md-6">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div class="ch-icon"><i class="bi bi-pie-chart-fill"></i></div>
                        <div>
                            <h3>Progression des routines</h3>
                            <p>Routines terminées vs en cours</p>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        {{ render_chart(progressChart) }}
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div class="ch-icon"><i class="bi bi-graph-down-arrow"></i></div>
                        <div>
                            <h3>Burn-down chart</h3>
                            <p>Progression réelle vs courbe idéale</p>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        {{ render_chart(burndownChart) }}
                    </div>
                </div>
            </div>
        </div>

        {# Routines #}
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-arrow-repeat"></i>
                Routines
                <span style="background:#eef2ff;color:var(--ind);border-radius:50px;padding:0.1rem 0.6rem;font-size:0.8rem;">{{ goal.routines|length }}</span>
            </h2>
        </div>

        {% if goal.routines|length > 0 %}
            <div class="routine-grid">
                {% for routine in goal.routines %}
                    <a href="{{ path('app_routine_show', {goalId: goal.id, id: routine.id}) }}" class="routine-card">
                        <div class="d-flex align-items-start justify-content-between">
                            <h3 class="routine-card-title">{{ routine.title }}</h3>
                            <span class="vis-badge vis-{{ routine.visibility }}">{{ routine.visibility|upper }}</span>
                        </div>
                        <p class="routine-card-desc">
                            {% if routine.description %}
                                {{ routine.description|slice(0, 90) }}{% if routine.description|length > 90 %}…{% endif %}
                            {% else %}
                                <em style="opacity:.5;">Aucune description</em>
                            {% endif %}
                        </p>
                        <div class="routine-card-footer">
                            <span class="routine-card-meta">
                                <i class="bi bi-list-task"></i>
                                {{ routine.activities|length }} activité{{ routine.activities|length != 1 ? 's' : '' }}
                            </span>
                            <i class="bi bi-chevron-right" style="color:#c7d2fe;font-size:0.85rem;"></i>
                        </div>
                    </a>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="bi bi-calendar-check"></i></div>
                <h3 style="font-weight:800;color:#111827;margin-bottom:0.5rem;">Aucune routine</h3>
                <p style="color:#6b7280;margin-bottom:1.5rem;">Créez votre première routine pour commencer à progresser.</p>
                <a href="{{ path('app_routine_new', {goalId: goal.id}) }}" class="btn-hero-primary" style="display:inline-flex;">
                    <i class="bi bi-plus-circle"></i> Créer une routine
                </a>
            </div>
        {% endif %}
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% endblock %}
