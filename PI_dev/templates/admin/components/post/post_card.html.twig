<!-- Post Card -->
<div class="card border shadow-sm mb-4">
    <!-- Post Header -->
    <div class="card-header bg-white border-0 pb-0">
        <div class="d-flex align-items-center">
            <!-- Avatar -->
            <div class="avatar avatar-md me-2">
                <img class="avatar-img rounded-circle" src="{{ asset('/adminDashboard/assets/images/avatar/01.jpg') }}" alt="avatar">
            </div>
            <!-- Info -->
            <div>
                <h6 class="mb-0">{{ post.createdBy.firstName }} {{ post.createdBy.lastName }}</h6>
                <small class="text-muted">{{ post.createdAt|date('d M Y, H:i') }}</small>
            </div>
        </div>
    </div>

    <!-- Post Body -->
    <div class="card-body">
        <h6 class="mb-2">{{ post.title }}</h6>
        <p class="mb-0">{{ post.content }}</p>
    </div>

    <!-- Post Stats -->
    <div class="card-footer bg-white border-0 pt-0">
        <!-- Likes and Comments Count -->
        <div class="d-flex align-items-center gap-3 mb-3">
            <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center" 
                    onclick="likePost({{ post.id }})"
                    id="likeBtn{{ post.id }}">
                <span class="me-1" id="likeIcon{{ post.id }}">{{ isLikedByCurrentUser ? '‚ù§Ô∏è' : 'ü§ç' }}</span>
                <span class="text-dark" id="likeCount{{ post.id }}">{{ post.postLikes|length }}</span>
            </button>
            <button class="btn btn-link text-decoration-none p-0 d-flex align-items-center" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#comments{{ post.id }}">
                <span class="me-1">üí¨</span>
                <span class="text-dark" id="commentCount{{ post.id }}">{{ post.comments|length }}</span>
                <span class="text-dark ms-1">Comments</span>
            </button>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex gap-3 mb-3 pb-3 border-bottom">
            <button class="btn btn-link text-secondary text-decoration-none p-0" 
                    onclick="likePost({{ post.id }})"
                    id="likeActionBtn{{ post.id }}">
                <i class="bi bi-hand-thumbs-up me-1"></i> {{ isLikedByCurrentUser ? 'Unlike' : 'Like' }}
            </button>
            <button class="btn btn-link text-secondary text-decoration-none p-0" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#comments{{ post.id }}">
                <i class="bi bi-chat me-1"></i> Comment
            </button>
        </div>

        <!-- Comment Input -->
        <div class="d-flex align-items-center mb-3">
            <div class="avatar avatar-sm me-2">
                <img class="avatar-img rounded-circle" src="{{ asset('/adminDashboard/assets/images/avatar/01.jpg') }}" alt="avatar">
            </div>
            <div class="flex-grow-1">
                <input type="text" class="form-control" placeholder="Write a comment..." id="commentInput{{ post.id }}">
            </div>
            <button class="btn btn-primary btn-sm ms-2" onclick="addComment({{ post.id }})">Comment</button>
        </div>

        <!-- Comments Section (Collapsible) -->
        <div class="collapse" id="comments{{ post.id }}">
            <div class="vstack gap-3 mt-3" id="commentsList{{ post.id }}">
                {% if post.comments|length > 0 %}
                    {% for comment in post.comments %}
                        <div class="d-flex" id="comment{{ comment.id }}">
                            <div class="avatar avatar-sm me-2">
                                <img class="avatar-img rounded-circle" src="{{ asset('/adminDashboard/assets/images/avatar/02.jpg') }}" alt="avatar">
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="mb-0 small">{{ comment.commenter.firstName }} {{ comment.commenter.lastName }}</h6>
                                    <small class="text-muted">{{ comment.createdAt|date('d M Y, H:i') }}</small>
                                </div>
                                <div class="bg-light rounded p-2">
                                    <p class="mb-0 small">{{ comment.content }}</p>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small">No comments yet. Be the first to comment!</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
async function likePost(postId) {
    {% if currentUser %}
    try {
        const response = await fetch('/posts/' + postId + '/like', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            // Update like count
            document.getElementById('likeCount' + postId).textContent = data.likeCount;
            
            // Update like icon
            const likeIcon = document.getElementById('likeIcon' + postId);
            likeIcon.textContent = data.liked ? '‚ù§Ô∏è' : 'ü§ç';
            
            // Update action button text
            const actionBtn = document.getElementById('likeActionBtn' + postId);
            actionBtn.innerHTML = '<i class="bi bi-hand-thumbs-up me-1"></i> ' + (data.liked ? 'Unlike' : 'Like');
        }
    } catch (error) {
        console.error('Error liking post:', error);
        alert('Failed to like post. Please try again.');
    }
    {% else %}
    alert('Please login to like posts');
    {% endif %}
}

async function addComment(postId) {
    {% if currentUser %}
    const input = document.getElementById('commentInput' + postId);
    const content = input.value.trim();
    
    if (!content) {
        alert('Please enter a comment');
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('content', content);
        
        const response = await fetch('/posts/' + postId + '/comment', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.success) {
                // Clear input
                input.value = '';
                
                // Get comments list container
                const commentsList = document.getElementById('commentsList' + postId);
                
                // Remove "no comments" message if it exists
                const noCommentsMsg = commentsList.querySelector('.text-muted');
                if (noCommentsMsg) {
                    noCommentsMsg.remove();
                }
                
                // Create new comment HTML
                const commentHTML = `
                    <div class="d-flex" id="comment${data.comment.id}">
                        <div class="avatar avatar-sm me-2">
                            <img class="avatar-img rounded-circle" src="{{ asset('/adminDashboard/assets/images/avatar/01.jpg') }}" alt="avatar">
                        </div>
                        <div class="flex-grow-1">
                            <div class="bg-light rounded p-2">
                                <h6 class="mb-1 small">${data.comment.commenter.firstName} ${data.comment.commenter.lastName}</h6>
                                <p class="mb-0 small">${data.comment.content}</p>
                            </div>
                            <small class="text-muted ms-2">${data.comment.createdAt}</small>
                        </div>
                    </div>
                `;
                
                // Add new comment to the list
                commentsList.insertAdjacentHTML('beforeend', commentHTML);
                
                // Update comment count
                const commentCountElement = document.getElementById('commentCount' + postId);
                const currentCount = parseInt(commentCountElement.textContent);
                commentCountElement.textContent = currentCount + 1;
                
                // Show comments section if hidden
                const commentsSection = document.getElementById('comments' + postId);
                if (!commentsSection.classList.contains('show')) {
                    const bsCollapse = new bootstrap.Collapse(commentsSection, {
                        toggle: true
                    });
                }
            }
        } else {
            const error = await response.json();
            alert(error.error || 'Failed to add comment');
        }
    } catch (error) {
        console.error('Error adding comment:', error);
        alert('Failed to add comment. Please try again.');
    }
    {% else %}
    alert('Please login to comment');
    {% endif %}
}
</script>
