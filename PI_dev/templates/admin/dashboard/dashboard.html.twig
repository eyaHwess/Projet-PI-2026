{% extends 'admin/base_admin.html.twig' %}

{% block title %}Dashboard Admin{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        .stat-card {
            border-radius: 1rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12) !important;
        }
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
        }
    </style>
{% endblock %}

{% block content %}
<div class="row g-4 pt-4">
    <!-- Titre -->
    <div class="col-12">
        <h1 class="h3 mb-2 mb-sm-0">Dashboard Administrateur</h1>
        <p class="text-muted mb-0">Vue d'ensemble de l'application Buildify</p>
    </div>

    <!-- Cartes statistiques principales -->
    <div class="row g-4 mb-4">
        <!-- Total Utilisateurs -->
        <div class="col-sm-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Total Utilisateurs</h6>
                            <h2 class="mb-0 fw-bold">{{ totalUsers }}</h2>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i> {{ totalCoaches }} coachs
                            </small>
                        </div>
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-people-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Demandes -->
        <div class="col-sm-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Demandes Coaching</h6>
                            <h2 class="mb-0 fw-bold">{{ totalRequests }}</h2>
                            <small class="text-warning">
                                <i class="bi bi-clock"></i> {{ pendingRequests }} en attente
                            </small>
                        </div>
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                            <i class="bi bi-inbox-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Sessions -->
        <div class="col-sm-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Total Sessions</h6>
                            <h2 class="mb-0 fw-bold">{{ totalSessions }}</h2>
                            <small class="text-success">
                                <i class="bi bi-check-circle"></i> {{ confirmedSessions }} confirmées
                            </small>
                        </div>
                        <div class="stat-icon bg-success bg-opacity-10 text-success">
                            <i class="bi bi-calendar-check-fill"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Total Objectifs -->
        <div class="col-sm-6 col-lg-3">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-2">Objectifs & Routines</h6>
                            <h2 class="mb-0 fw-bold">{{ totalGoals }}</h2>
                            <small class="text-info">
                                <i class="bi bi-list-check"></i> {{ totalRoutines }} routines
                            </small>
                        </div>
                        <div class="stat-icon bg-info bg-opacity-10 text-info">
                            <i class="bi bi-bullseye"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques et tableaux -->
    <div class="row g-4 mb-4">
        <!-- Graphique évolution (7 jours) -->
        <div class="col-12 col-xl-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>Évolution (7 derniers jours)
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="evolutionChart" height="100"></canvas>
                </div>
            </div>
        </div>

        <!-- Répartition demandes -->
        <div class="col-12 col-xl-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-pie-chart-fill me-2"></i>Demandes par statut
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="requestsChart"></canvas>
                    <div class="mt-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-warning me-2"></i>En attente</span>
                            <strong>{{ pendingRequests }}</strong>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span><i class="bi bi-circle-fill text-success me-2"></i>Acceptées</span>
                            <strong>{{ acceptedRequests }}</strong>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span><i class="bi bi-circle-fill text-danger me-2"></i>Refusées</span>
                            <strong>{{ declinedRequests }}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Répartition sessions et tableaux -->
    <div class="row g-4 mb-4">
        <!-- Répartition sessions -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-bar-chart-fill me-2"></i>Sessions par statut
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="sessionsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Utilisateurs récents -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-person-plus-fill me-2"></i>Utilisateurs récents
                    </h5>
                    <a href="{{ path('admin_user_list') }}" class="btn btn-sm btn-link p-0">Voir tout</a>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>Rôle</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in recentUsers %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm bg-primary bg-opacity-10 rounded-circle d-flex align-items-center justify-content-center me-2">
                                                <i class="bi bi-person-fill text-primary"></i>
                                            </div>
                                            <strong>{{ user.firstName }} {{ user.lastName }}</strong>
                                        </div>
                                    </td>
                                    <td><small class="text-muted">{{ user.email }}</small></td>
                                    <td>
                                        {% if 'ROLE_COACH' in user.roles %}
                                            <span class="badge bg-success">Coach</span>
                                        {% else %}
                                            <span class="badge bg-secondary">User</span>
                                        {% endif %}
                                    </td>
                                    <td><small class="text-muted">{{ user.createdAt|date('d/m/Y') }}</small></td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">Aucun utilisateur récent</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Demandes et sessions récentes -->
    <div class="row g-4">
        <!-- Demandes récentes -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3 d-flex justify-content-between align-items-center">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-inbox me-2"></i>Demandes récentes
                    </h5>
                    <a href="{{ path('admin_coach_requests') }}" class="btn btn-sm btn-link p-0">Voir tout</a>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for request in recentRequests %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">{{ request.user.firstName }} {{ request.user.lastName }}</h6>
                                    <p class="mb-1 small text-muted">{{ request.message|slice(0, 60) }}{% if request.message|length > 60 %}...{% endif %}</p>
                                    <small class="text-muted">{{ request.createdAt|date('d/m/Y à H:i') }}</small>
                                </div>
                                <span class="badge {% if request.status == 'pending' %}bg-warning{% elseif request.status == 'accepted' %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ request.status }}
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <div class="list-group-item text-center text-muted py-3">Aucune demande récente</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessions récentes -->
        <div class="col-12 col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom py-3">
                    <h5 class="card-header-title mb-0">
                        <i class="bi bi-calendar-event me-2"></i>Sessions récentes
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        {% for session in recentSessions %}
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        Session #{{ session.id }}
                                    </h6>
                                    <p class="mb-1 small text-muted">
                                        Coach: {{ session.coachingRequest.coach.firstName }} {{ session.coachingRequest.coach.lastName }}<br>
                                        Client: {{ session.coachingRequest.user.firstName }} {{ session.coachingRequest.user.lastName }}
                                    </p>
                                    <small class="text-muted">{{ session.createdAt|date('d/m/Y à H:i') }}</small>
                                </div>
                                <span class="badge {% if session.status == 'confirmed' %}bg-success{% elseif session.status == 'completed' %}bg-primary{% elseif session.status == 'cancelled' %}bg-danger{% else %}bg-warning{% endif %}">
                                    {{ session.status }}
                                </span>
                            </div>
                        </div>
                        {% else %}
                        <div class="list-group-item text-center text-muted py-3">Aucune session récente</div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Graphique évolution (7 jours)
        const ctxEvolution = document.getElementById('evolutionChart');
        if (ctxEvolution) {
            new Chart(ctxEvolution, {
                type: 'line',
                data: {
                    labels: {{ chartData.labels|json_encode|raw }},
                    datasets: [{
                        label: 'Utilisateurs',
                        data: {{ chartData.users|json_encode|raw }},
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Sessions',
                        data: {{ chartData.sessions|json_encode|raw }},
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Demandes',
                        data: {{ chartData.requests|json_encode|raw }},
                        borderColor: 'rgb(249, 115, 22)',
                        backgroundColor: 'rgba(249, 115, 22, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Graphique demandes par statut (camembert)
        const ctxRequests = document.getElementById('requestsChart');
        if (ctxRequests) {
            new Chart(ctxRequests, {
                type: 'doughnut',
                data: {
                    labels: ['En attente', 'Acceptées', 'Refusées'],
                    datasets: [{
                        data: [{{ pendingRequests }}, {{ acceptedRequests }}, {{ declinedRequests }}],
                        backgroundColor: [
                            'rgb(251, 191, 36)',
                            'rgb(34, 197, 94)',
                            'rgb(239, 68, 68)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Graphique sessions par statut (barres)
        const ctxSessions = document.getElementById('sessionsChart');
        if (ctxSessions) {
            new Chart(ctxSessions, {
                type: 'bar',
                data: {
                    labels: ['En planification', 'Confirmées', 'Terminées', 'Annulées'],
                    datasets: [{
                        label: 'Nombre de sessions',
                        data: [{{ schedulingSessions }}, {{ confirmedSessions }}, {{ completedSessions }}, {{ cancelledSessions }}],
                        backgroundColor: [
                            'rgba(251, 191, 36, 0.8)',
                            'rgba(34, 197, 94, 0.8)',
                            'rgba(59, 130, 246, 0.8)',
                            'rgba(239, 68, 68, 0.8)'
                        ],
                        borderColor: [
                            'rgb(251, 191, 36)',
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)',
                            'rgb(239, 68, 68)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
    </script>
{% endblock %}
