{% extends 'base.html.twig' %}

{% block title %}Routines — {{ goal.title }}{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
<style>
    :root {
        --pur: #9333ea;
        --pur-dark: #7e22ce;
        --pur-light: #f5f3ff;
    }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8f9fb;
    }
    /* ── Hero ── */
    .routine-hero {
        background: linear-gradient(135deg, #1e1b4b 0%, #4c1d95 55%, #1e3a5f 100%);
        padding: 5.5rem 0 3rem;
        position: relative;
        overflow: hidden;
    }
    .routine-hero::before {
        content: '';
        position: absolute;
        top: -80px; right: -80px;
        width: 420px; height: 420px;
        background: radial-gradient(circle, rgba(147,51,234,0.22) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .routine-hero::after {
        content: '';
        position: absolute;
        bottom: -60px; left: 5%;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(192,132,252,0.15) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .hero-back-link {
        color: rgba(255,255,255,0.5);
        font-size: 0.85rem;
        font-weight: 500;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        margin-bottom: 1.25rem;
        transition: color 0.2s;
        position: relative; z-index: 1;
    }
    .hero-back-link:hover { color: white; }
    .hero-eyebrow {
        font-size: 0.72rem;
        font-weight: 700;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        color: #c084fc;
        margin-bottom: 0.6rem;
        position: relative; z-index: 1;
    }
    .hero-title {
        font-size: clamp(1.75rem, 4vw, 2.5rem);
        font-weight: 900;
        color: white;
        letter-spacing: -0.03em;
        line-height: 1.15;
        margin-bottom: 0.6rem;
        position: relative; z-index: 1;
    }
    .hero-goal-name {
        font-size: 1rem;
        color: rgba(255,255,255,0.55);
        margin-bottom: 1.75rem;
        position: relative; z-index: 1;
    }
    .hero-goal-name strong { color: rgba(255,255,255,0.85); }
    .hero-chips {
        display: flex; flex-wrap: wrap; gap: 0.6rem;
        position: relative; z-index: 1; margin-bottom: 2rem;
    }
    .hero-chip {
        background: rgba(255,255,255,0.08);
        border: 1px solid rgba(255,255,255,0.12);
        border-radius: 50px;
        padding: 0.3rem 0.85rem;
        font-size: 0.79rem;
        color: rgba(255,255,255,0.65);
        display: flex; align-items: center; gap: 0.4rem;
    }
    .hero-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; position: relative; z-index: 1; }
    .btn-hero-primary {
        padding: 0.65rem 1.4rem;
        background: linear-gradient(135deg, #9333ea, #7c3aed);
        color: white; border: none; border-radius: 50px;
        font-size: 0.875rem; font-weight: 600; font-family: inherit;
        cursor: pointer; text-decoration: none;
        display: inline-flex; align-items: center; gap: 0.4rem;
        transition: all 0.2s;
        box-shadow: 0 4px 14px rgba(147,51,234,0.4);
    }
    .btn-hero-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(147,51,234,0.5); color: white; }
    /* ── Content ── */
    .routines-content { padding: 2.5rem 0 4rem; }
    /* Filter bar */
    .filter-bar {
        background: white;
        border: 2px solid #eef0f4;
        border-radius: 1rem;
        padding: 1rem 1.25rem;
        margin-bottom: 1.75rem;
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: center;
    }
    .filter-bar .input-wrap {
        position: relative;
        flex: 1;
        min-width: 200px;
    }
    .filter-bar .input-wrap i {
        position: absolute;
        left: 0.85rem;
        top: 50%; transform: translateY(-50%);
        color: #9ca3af; font-size: 0.9rem;
    }
    .filter-bar input {
        width: 100%;
        padding: 0.55rem 0.85rem 0.55rem 2.25rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.65rem;
        font-size: 0.875rem;
        font-family: inherit;
        color: #111827;
        background: #fafafa;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
        box-sizing: border-box;
    }
    .filter-bar input:focus { border-color: #a78bfa; box-shadow: 0 0 0 3px rgba(167,139,250,0.12); }
    .filter-bar select {
        padding: 0.55rem 0.85rem;
        border: 2px solid #e5e7eb;
        border-radius: 0.65rem;
        font-size: 0.875rem;
        font-family: inherit;
        color: #374151;
        background: #fafafa;
        outline: none;
        cursor: pointer;
        transition: border-color 0.2s;
    }
    .filter-bar select:focus { border-color: #a78bfa; }
    .layout-btn-group { display: flex; border: 2px solid #e5e7eb; border-radius: 0.65rem; overflow: hidden; }
    .layout-toggle {
        padding: 0.5rem 0.75rem;
        border: none;
        background: white;
        color: #9ca3af;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
    }
    .layout-toggle.active { background: #f5f3ff; color: #7c3aed; }
    .layout-toggle:hover:not(.active) { background: #fafafa; }
    /* Routine cards */
    .routine-card {
        background: white;
        border: 2px solid #eef0f4;
        border-radius: 1.25rem;
        padding: 1.5rem;
        text-decoration: none;
        color: inherit;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        height: 100%;
        transition: all 0.2s;
        position: relative;
        overflow: hidden;
    }
    .routine-card::before {
        content: '';
        position: absolute;
        top: 0; left: 0;
        width: 4px; height: 100%;
        background: linear-gradient(180deg, #a78bfa, #c084fc);
        border-radius: 1.25rem 0 0 1.25rem;
    }
    .routine-card:hover {
        border-color: #ddd6fe;
        box-shadow: 0 8px 28px rgba(124,58,237,0.12);
        transform: translateY(-3px);
        color: inherit;
        text-decoration: none;
    }
    .routine-card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.5rem; }
    .routine-card-title { font-size: 1rem; font-weight: 700; color: #111827; margin: 0; line-height: 1.3; }
    .routine-card-desc { font-size: 0.84rem; color: #6b7280; line-height: 1.5; flex: 1; }
    .routine-card-badges { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .vis-badge {
        font-size: 0.68rem; font-weight: 700;
        text-transform: uppercase; letter-spacing: 0.06em;
        padding: 0.2rem 0.6rem; border-radius: 50px;
    }
    .vis-public  { background: #d1fae5; color: #065f46; }
    .vis-private { background: #fef3c7; color: #92400e; }
    .prio-badge {
        font-size: 0.68rem; font-weight: 700;
        padding: 0.2rem 0.6rem; border-radius: 50px;
    }
    .prio-high   { background: #fee2e2; color: #b91c1c; }
    .prio-medium { background: #fef3c7; color: #92400e; }
    .prio-low    { background: #d1fae5; color: #065f46; }
    .deadline-badge { font-size: 0.68rem; font-weight: 700; padding: 0.2rem 0.6rem; border-radius: 50px; background: #fef3c7; color: #b45309; }
    .routine-card-footer {
        display: flex; align-items: center; justify-content: space-between;
        padding-top: 0.75rem; border-top: 1px solid #f0f0f4;
    }
    .routine-card-meta { font-size: 0.78rem; color: #9ca3af; display: flex; align-items: center; gap: 0.35rem; }
    .routine-card-actions { display: flex; gap: 0.4rem; }
    .act-btn {
        width: 30px; height: 30px;
        border-radius: 0.5rem;
        border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem;
        transition: all 0.2s;
    }
    .act-btn-edit  { background: #eef2ff; color: #4338ca; }
    .act-btn-edit:hover  { background: #e0e7ff; }
    .act-btn-dup   { background: #f0fdf4; color: #15803d; }
    .act-btn-dup:hover   { background: #dcfce7; }
    .act-btn-del   { background: #fef2f2; color: #b91c1c; }
    .act-btn-del:hover   { background: #fee2e2; }
    .act-btn:disabled { opacity: 0.35; cursor: not-allowed; }
    /* List view */
    .list-view .row { display: block; }
    .list-view .col-md-6, .list-view .col-lg-4 { width: 100%; max-width: 100%; }
    .list-view .routine-card {
        flex-direction: row; align-items: center;
        gap: 1.5rem; padding: 1.1rem 1.5rem;
        border-radius: 0.875rem; margin-bottom: 0.65rem;
        min-height: 80px;
    }
    .list-view .routine-card::before { border-radius: 0.875rem 0 0 0.875rem; }
    .list-view .routine-card-header { flex: 0 0 260px; flex-direction: column; gap: 0.3rem; }
    .list-view .routine-card-desc {
        flex: 1; display: -webkit-box;
        -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden;
        font-size: 0.82rem;
    }
    .list-view .routine-card-badges { flex: 0 0 auto; }
    .list-view .routine-card-footer { border: none; padding: 0; flex: 0 0 auto; gap: 0.75rem; }
    /* Empty */
    .empty-state {
        text-align: center; padding: 4rem 2rem;
        background: white; border: 2px dashed #e9d5ff; border-radius: 1.25rem;
    }
    .empty-icon {
        width: 80px; height: 80px;
        background: linear-gradient(135deg, #f5f3ff, #ede9fe);
        border-radius: 1.25rem;
        display: flex; align-items: center; justify-content: center;
        font-size: 2.2rem; color: var(--pur);
        margin: 0 auto 1.5rem;
        box-shadow: 0 8px 24px rgba(147,51,234,0.15);
    }
    /* Modal */
    .modal-content { border-radius: 1.25rem; border: none; overflow: hidden; }
    .modal-header {
        background: linear-gradient(135deg, #7c3aed, #6d28d9);
        color: white; border: none; padding: 1.25rem 1.5rem;
    }
    .modal-title { font-weight: 700; font-size: 1rem; }
    .btn-close-white { filter: brightness(0) invert(1); }
</style>
{% endblock %}

{% block body %}

{# ── Hero ── #}
<div class="routine-hero">
    <div class="container">
        <a href="{{ path('app_goal_show', {id: goal.id}) }}" class="hero-back-link">
            <i class="bi bi-arrow-left"></i> {{ goal.title }}
        </a>
        <p class="hero-eyebrow"><i class="bi bi-arrow-repeat me-1"></i>Routines</p>
        <h1 class="hero-title">Mes Routines</h1>
        <p class="hero-goal-name">Objectif : <strong>{{ goal.title }}</strong></p>
        <div class="hero-chips">
            <div class="hero-chip">
                <i class="bi bi-arrow-repeat"></i>
                {{ routines|length }} routine{{ routines|length != 1 ? 's' : '' }}
            </div>
            {% set completedCount = routines|filter(r => r.status == 'completed')|length %}
            {% if completedCount > 0 %}
            <div class="hero-chip">
                <i class="bi bi-check-circle"></i>
                {{ completedCount }} terminée{{ completedCount != 1 ? 's' : '' }}
            </div>
            {% endif %}
        </div>
        <div class="hero-actions">
            <button id="newRoutineBtn" class="btn-hero-primary">
                <i class="bi bi-plus-circle"></i> Nouvelle routine
            </button>
        </div>
    </div>
</div>

{# ── Content ── #}
<div class="routines-content">
    <div class="container">

        {# Filter bar #}
        <div class="filter-bar">
            <div class="input-wrap">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="Rechercher une routine…" value="{{ searchQuery }}">
            </div>
            <select id="sortSelect">
                <option value="createdAt-DESC" {{ currentSort == 'createdAt' and currentOrder == 'DESC' ? 'selected' : '' }}>Plus récent</option>
                <option value="createdAt-ASC"  {{ currentSort == 'createdAt' and currentOrder == 'ASC'  ? 'selected' : '' }}>Plus ancien</option>
                <option value="title-ASC"      {{ currentSort == 'title'     and currentOrder == 'ASC'  ? 'selected' : '' }}>Titre A-Z</option>
                <option value="title-DESC"     {{ currentSort == 'title'     and currentOrder == 'DESC' ? 'selected' : '' }}>Titre Z-A</option>
            </select>
            <select id="visibilityFilter">
                <option value="all"     {{ currentVisibility == 'all'     ? 'selected' : '' }}>Toutes</option>
                <option value="public"  {{ currentVisibility == 'public'  ? 'selected' : '' }}>Publiques</option>
                <option value="private" {{ currentVisibility == 'private' ? 'selected' : '' }}>Privées</option>
            </select>
            <div class="layout-btn-group">
                <button class="layout-toggle" data-layout="list" title="Vue liste"><i class="bi bi-list-ul"></i></button>
                <button class="layout-toggle active" data-layout="grid" title="Vue grille"><i class="bi bi-grid-3x3-gap"></i></button>
            </div>
        </div>

        {% if routines|length > 0 %}
            <div class="row g-3" id="routinesContainer">
                {% for routine in routines %}
                    <div class="col-md-6 col-lg-4">
                        <a href="{{ path('app_routine_show', {goalId: goal.id, id: routine.id}) }}" class="routine-card">
                            <div class="routine-card-header">
                                <h3 class="routine-card-title">{{ routine.title }}</h3>
                            </div>
                            <div class="routine-card-badges">
                                <span class="vis-badge vis-{{ routine.visibility }}">{{ routine.visibility|upper }}</span>
                                {% if routine.getPriority() %}
                                    <span class="prio-badge prio-{{ routine.getPriority() }}">
                                        {{ routine.getPriority() == 'high' ? 'Haute' : (routine.getPriority() == 'medium' ? 'Moyenne' : 'Basse') }}
                                    </span>
                                {% endif %}
                                {% if routine.isDeadlineNear() %}
                                    <span class="deadline-badge"><i class="bi bi-alarm me-1"></i>Deadline proche</span>
                                {% endif %}
                            </div>
                            <p class="routine-card-desc">
                                {% if routine.description %}
                                    {{ routine.description|slice(0, 90) }}{% if routine.description|length > 90 %}…{% endif %}
                                {% else %}
                                    <em style="opacity:.5;">Aucune description</em>
                                {% endif %}
                            </p>
                            <div class="routine-card-footer">
                                <span class="routine-card-meta">
                                    <i class="bi bi-list-task"></i>
                                    {{ routine.activities|length }} activité{{ routine.activities|length != 1 ? 's' : '' }}
                                    {% if routine.deadline %}
                                        &nbsp;·&nbsp;<i class="bi bi-calendar-event"></i> {{ routine.deadline|date('d/m/Y') }}
                                    {% endif %}
                                </span>
                                <div class="routine-card-actions" onclick="event.preventDefault(); event.stopPropagation();">
                                    <button class="act-btn act-btn-edit edit-routine-btn"
                                            data-routine-id="{{ routine.id }}" title="Modifier">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="act-btn act-btn-dup duplicate-routine-btn"
                                            data-routine-id="{{ routine.id }}"
                                            data-routine-title="{{ routine.title }}"
                                            data-csrf-token="{{ csrf_token('duplicate' ~ routine.id) }}"
                                            title="Dupliquer">
                                        <i class="bi bi-files"></i>
                                    </button>
                                    {% if goal.routines|length > 1 %}
                                        <button class="act-btn act-btn-del delete-routine-btn"
                                                data-routine-id="{{ routine.id }}"
                                                data-routine-title="{{ routine.title }}"
                                                data-csrf-token="{{ csrf_token('delete' ~ routine.id) }}"
                                                title="Supprimer">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% else %}
                                        <button class="act-btn act-btn-del" disabled title="Une routine minimum requise">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="bi bi-calendar-check"></i></div>
                <h3 style="font-weight:800;color:#111827;margin-bottom:0.5rem;">Aucune routine</h3>
                <p style="color:#6b7280;margin-bottom:1.5rem;">Créez votre première routine pour cet objectif.</p>
                <button id="newRoutineBtnEmpty" class="btn-hero-primary" style="display:inline-flex;">
                    <i class="bi bi-plus-circle"></i> Créer une routine
                </button>
            </div>
        {% endif %}
    </div>
</div>

{# ── Modals ── #}
<div class="modal fade" id="routineModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="routineModalTitle">Nouvelle Routine</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="routineModalContent"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Confirmer la suppression</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p style="color:#374151;margin-bottom:1rem;">Supprimer cette routine et toutes ses activités ?</p>
                <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:0.75rem;padding:0.875rem 1rem;font-size:0.875rem;">
                    <i class="bi bi-info-circle me-2" style="color:#d97706;"></i>
                    <strong id="deleteItemName" style="color:#92400e;"></strong>
                    <p class="mb-0 mt-1 small" style="color:#78350f;">Cette action est irréversible.</p>
                </div>
            </div>
            <div class="modal-footer" style="border-top:1px solid #e5e7eb;padding:1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        style="border-radius:0.65rem;font-weight:600;border:none;background:#6b7280;">
                    Annuler
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn"
                        style="border-radius:0.65rem;font-weight:600;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 12px rgba(239,68,68,.3);">
                    <i class="bi bi-trash me-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const routineModal = new bootstrap.Modal(document.getElementById('routineModal'));
        const modalContent = document.getElementById('routineModalContent');
        const modalTitle = document.getElementById('routineModalTitle');
        const newRoutineBtn = document.getElementById('newRoutineBtn');
        const newRoutineBtnEmpty = document.getElementById('newRoutineBtnEmpty');

        function openModal(title, url) {
            modalTitle.textContent = title;
            modalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border" role="status" style="color:#9333ea;"><span class="visually-hidden">Chargement…</span></div></div>';
            routineModal.show();
            fetch(url).then(r => r.text()).then(html => {
                modalContent.innerHTML = html;
                initForm();
            }).catch(err => {
                modalContent.innerHTML = '<div class="alert alert-danger m-3">Erreur lors du chargement. Veuillez réessayer.</div>';
            });
        }

        function closeModal() { routineModal.hide(); modalContent.innerHTML = ''; }

        function initForm() {
            const form = modalContent.querySelector('form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement…'; }
                try {
                    const response = await fetch(form.action, {
                        method: form.method || 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
                        body: formData
                    });
                    const ct = response.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) throw new Error('Réponse inattendue du serveur.');
                    const data = await response.json();
                    if (data.success) { closeModal(); setTimeout(() => location.reload(), 800); }
                    else { if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = originalText; } alert('Erreur: ' + (data.message || 'Validation échouée')); }
                } catch (err) {
                    if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = originalText; }
                    alert('Erreur: ' + err.message);
                }
            });
        }

        document.getElementById('routineModal').addEventListener('hidden.bs.modal', () => { document.body.style.overflow = ''; });
        if (newRoutineBtn) newRoutineBtn.addEventListener('click', () => openModal('Nouvelle Routine', '{{ path('app_routine_new', {goalId: goal.id}) }}'));
        if (newRoutineBtnEmpty) newRoutineBtnEmpty.addEventListener('click', () => openModal('Nouvelle Routine', '{{ path('app_routine_new', {goalId: goal.id}) }}'));

        // Filters
        const sortSelect = document.getElementById('sortSelect');
        const visibilityFilter = document.getElementById('visibilityFilter');
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        function applyFilters() {
            const sortValue = sortSelect ? sortSelect.value : 'createdAt-DESC';
            const visValue = visibilityFilter ? visibilityFilter.value : 'all';
            const searchValue = searchInput ? searchInput.value : '';
            const [sort, order] = sortValue.split('-');
            const url = new URL(window.location.href);
            url.searchParams.set('sort', sort); url.searchParams.set('order', order); url.searchParams.set('visibility', visValue);
            searchValue ? url.searchParams.set('search', searchValue) : url.searchParams.delete('search');
            window.location.href = url.toString();
        }
        if (sortSelect) sortSelect.addEventListener('change', applyFilters);
        if (visibilityFilter) visibilityFilter.addEventListener('change', applyFilters);
        if (searchInput) searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 500); });

        // Edit
        document.querySelectorAll('.edit-routine-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                openModal('Modifier la Routine', `/goals/{{ goal.id }}/routines/${btn.dataset.routineId}/edit`);
            });
        });

        // Duplicate
        document.querySelectorAll('.duplicate-routine-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                e.preventDefault();
                if (!confirm(`Dupliquer "${btn.dataset.routineTitle}" (avec ses activités) ?`)) return;
                btn.disabled = true; const orig = btn.innerHTML; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
                try {
                    const resp = await fetch(`/goals/{{ goal.id }}/routines/${btn.dataset.routineId}/duplicate`, {
                        method: 'POST',
                        headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `_token=${encodeURIComponent(btn.dataset.csrfToken)}`
                    });
                    const data = await resp.json();
                    if (data.success) { alert(data.message); setTimeout(() => location.reload(), 500); }
                    else { alert('Erreur: ' + (data.message || 'Impossible de dupliquer')); btn.disabled = false; btn.innerHTML = orig; }
                } catch (err) { alert('Erreur: ' + err.message); btn.disabled = false; btn.innerHTML = orig; }
            });
        });

        // Delete
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        let currentDeleteAction = null;
        document.querySelectorAll('.delete-routine-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                document.getElementById('deleteItemName').textContent = btn.dataset.routineTitle;
                currentDeleteAction = async () => {
                    confirmDeleteBtn.disabled = true; confirmDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Suppression…';
                    try {
                        const resp = await fetch(`/goals/{{ goal.id }}/routines/${btn.dataset.routineId}`, {
                            method: 'DELETE',
                            headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `_token=${encodeURIComponent(btn.dataset.csrfToken)}`
                        });
                        const data = await resp.json();
                        if (data.success) { deleteConfirmModal.hide(); setTimeout(() => location.reload(), 300); }
                        else { alert('Erreur: ' + (data.message || 'Impossible de supprimer')); confirmDeleteBtn.disabled = false; confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
                    } catch (err) { alert('Erreur: ' + err.message); confirmDeleteBtn.disabled = false; confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
                };
                deleteConfirmModal.show();
            });
        });
        confirmDeleteBtn.addEventListener('click', () => { if (currentDeleteAction) currentDeleteAction(); });
        document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', () => {
            confirmDeleteBtn.disabled = false; confirmDeleteBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; currentDeleteAction = null;
        });

        // Layout toggle
        const layoutToggles = document.querySelectorAll('.layout-toggle');
        const routinesContainer = document.getElementById('routinesContainer');
        const savedLayout = localStorage.getItem('routinesLayout') || 'grid';
        if (savedLayout === 'list' && routinesContainer) {
            routinesContainer.classList.add('list-view');
            layoutToggles.forEach(btn => { btn.classList.toggle('active', btn.dataset.layout === 'list'); });
        }
        layoutToggles.forEach(button => {
            button.addEventListener('click', function() {
                const layout = this.dataset.layout;
                layoutToggles.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                if (routinesContainer) routinesContainer.classList.toggle('list-view', layout === 'list');
                localStorage.setItem('routinesLayout', layout);
            });
        });
    });
</script>
{% endblock %}
