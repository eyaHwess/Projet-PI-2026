{% extends 'base.html.twig' %}

{% block title %}{{ routine.title }}{% endblock %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css">
<style>
    :root { --pur: #9333ea; --pur-dark: #7e22ce; }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: #f8f9fb;
    }
    /* ── Hero ── */
    .routine-hero {
        background: linear-gradient(135deg, #1e1b4b 0%, #4c1d95 55%, #1e3a5f 100%);
        padding: 5.5rem 0 3rem;
        position: relative; overflow: hidden;
    }
    .routine-hero::before {
        content: '';
        position: absolute; top: -80px; right: -80px;
        width: 420px; height: 420px;
        background: radial-gradient(circle, rgba(147,51,234,0.22) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .routine-hero::after {
        content: '';
        position: absolute; bottom: -60px; left: 5%;
        width: 300px; height: 300px;
        background: radial-gradient(circle, rgba(192,132,252,0.15) 0%, transparent 70%);
        border-radius: 50%; pointer-events: none;
    }
    .hero-back { color: rgba(255,255,255,0.5); font-size: .85rem; font-weight: 500; text-decoration: none; display: inline-flex; align-items: center; gap: .4rem; margin-bottom: 1.25rem; transition: color .2s; position: relative; z-index: 1; }
    .hero-back:hover { color: white; }
    .hero-eyebrow { font-size: .72rem; font-weight: 700; letter-spacing: .12em; text-transform: uppercase; color: #c084fc; margin-bottom: .6rem; position: relative; z-index: 1; }
    .hero-title { font-size: clamp(1.75rem, 4vw, 2.5rem); font-weight: 900; color: white; letter-spacing: -.03em; line-height: 1.15; margin-bottom: .6rem; position: relative; z-index: 1; }
    .hero-desc { font-size: 1rem; color: rgba(255,255,255,.6); margin-bottom: 1.75rem; position: relative; z-index: 1; }
    .hero-chips { display: flex; flex-wrap: wrap; gap: .6rem; position: relative; z-index: 1; margin-bottom: 2rem; }
    .hero-chip { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.12); border-radius: 50px; padding: .3rem .85rem; font-size: .79rem; color: rgba(255,255,255,.65); display: flex; align-items: center; gap: .4rem; }
    .hero-chip.warning { background: rgba(251,191,36,.1); border-color: rgba(251,191,36,.25); color: #fcd34d; }
    .hero-actions { display: flex; gap: .65rem; flex-wrap: wrap; position: relative; z-index: 1; }
    .btn-hero-primary { padding: .6rem 1.3rem; background: linear-gradient(135deg,#9333ea,#7c3aed); color: white; border: none; border-radius: 50px; font-size: .85rem; font-weight: 600; font-family: inherit; cursor: pointer; display: inline-flex; align-items: center; gap: .4rem; transition: all .2s; box-shadow: 0 4px 14px rgba(147,51,234,.4); }
    .btn-hero-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(147,51,234,.5); color: white; }
    .btn-hero-ghost { padding: .6rem 1.3rem; background: rgba(255,255,255,.09); color: rgba(255,255,255,.8); border: 1px solid rgba(255,255,255,.18); border-radius: 50px; font-size: .85rem; font-weight: 600; font-family: inherit; cursor: pointer; display: inline-flex; align-items: center; gap: .4rem; transition: all .2s; }
    .btn-hero-ghost:hover { background: rgba(255,255,255,.17); color: white; }
    .btn-hero-danger { padding: .6rem 1.3rem; background: rgba(239,68,68,.1); color: #fca5a5; border: 1px solid rgba(239,68,68,.25); border-radius: 50px; font-size: .85rem; font-weight: 600; font-family: inherit; cursor: pointer; display: inline-flex; align-items: center; gap: .4rem; transition: all .2s; }
    .btn-hero-danger:hover { background: rgba(239,68,68,.2); color: #fecaca; }
    /* ── Content area ── */
    .routine-content { padding: 2.5rem 0 4rem; }
    .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.25rem; padding-bottom: .75rem; border-bottom: 2px solid #f0f0f4; }
    .section-title { font-size: 1.1rem; font-weight: 800; color: #111827; display: flex; align-items: center; gap: .5rem; margin: 0; }
    .section-title i { color: var(--pur); }
    /* Chart cards */
    .chart-card { background: white; border: 2px solid #eef0f4; border-radius: 1.25rem; overflow: hidden; box-shadow: 0 2px 12px rgba(0,0,0,.04); height: 100%; display: flex; flex-direction: column; transition: box-shadow .2s, border-color .2s; }
    .chart-card:hover { box-shadow: 0 8px 28px rgba(147,51,234,.1); border-color: #ddd6fe; }
    .chart-card-header { background: linear-gradient(135deg,#f5f3ff,#ede9fe); padding: .875rem 1.25rem; border-bottom: 2px solid #e8e0fb; display: flex; align-items: center; gap: .65rem; }
    .ch-icon { width: 32px; height: 32px; background: linear-gradient(135deg,var(--pur),#7c3aed); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: .85rem; flex-shrink: 0; box-shadow: 0 4px 10px rgba(147,51,234,.3); }
    .chart-card-header h3 { font-size: .88rem; font-weight: 700; color: #1e293b; margin: 0; }
    .chart-card-header p  { font-size: .73rem; color: #6b7280; margin: 0; line-height: 1.3; }
    .chart-card-body { padding: 1.25rem; flex: 1; display: flex; align-items: center; justify-content: center; }
    .chart-card-body canvas { max-height: 280px !important; }
    /* Activity cards */
    .activity-card { background: white; border: 2px solid #eef0f4; border-radius: 1.25rem; padding: 1.5rem; height: 100%; transition: all .2s; position: relative; overflow: hidden; cursor: pointer; }
    .activity-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(180deg,#a78bfa,#c084fc); border-radius: 1.25rem 0 0 1.25rem; }
    .activity-card:hover { border-color: #ddd6fe; box-shadow: 0 8px 28px rgba(124,58,237,.12); transform: translateY(-3px); }
    .activity-header { margin-bottom: .75rem; }
    .activity-title { font-size: 1rem; font-weight: 700; color: #111827; margin: 0 0 .4rem 0; display: flex; align-items: flex-start; justify-content: space-between; gap: .5rem; }
    .activity-badges { display: flex; flex-wrap: wrap; gap: .35rem; margin-bottom: .75rem; }
    .a-badge { font-size: .68rem; font-weight: 700; padding: .2rem .6rem; border-radius: 50px; text-transform: uppercase; letter-spacing: .05em; }
    .ab-prio-high   { background: #fee2e2; color: #b91c1c; }
    .ab-prio-medium { background: #fef3c7; color: #92400e; }
    .ab-prio-low    { background: #d1fae5; color: #065f46; }
    .ab-deadline    { background: #fef3c7; color: #b45309; }
    .status-badge { font-size: .68rem; font-weight: 700; padding: .25rem .7rem; border-radius: 50px; text-transform: uppercase; letter-spacing: .06em; display: inline-block; margin-bottom: .5rem; }
    .status-pending     { background: #fef3c7; color: #92400e; }
    .status-in-progress { background: #dbeafe; color: #1e40af; }
    .status-completed   { background: #d1fae5; color: #065f46; }
    .status-cancelled   { background: #f3f4f6; color: #374151; }
    .status-skipped     { background: #f0f0f0; color: #6b7280; }
    .activity-times { margin-bottom: .75rem; }
    .time-row { display: flex; align-items: center; gap: .5rem; font-size: .8rem; color: #6b7280; margin-bottom: .3rem; }
    .time-row i { color: var(--pur); width: 14px; }
    .activity-actions-row { display: flex; gap: .4rem; padding-top: .75rem; border-top: 1px solid #f0f0f4; }
    .act-btn { height: 30px; border-radius: .5rem; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: .8rem; transition: all .2s; padding: 0 .65rem; gap: .3rem; font-weight: 600; font-size: .78rem; }
    .act-btn-edit   { background: #eef2ff; color: #4338ca; flex: 1; }
    .act-btn-edit:hover   { background: #e0e7ff; }
    .act-btn-del    { background: #fef2f2; color: #b91c1c; width: 30px; padding: 0; }
    .act-btn-del:hover    { background: #fee2e2; }
    /* Filter bar */
    .filter-bar { background: white; border: 2px solid #eef0f4; border-radius: 1rem; padding: 1rem 1.25rem; margin-bottom: 1.75rem; display: flex; flex-wrap: wrap; gap: .75rem; align-items: center; }
    .filter-bar .input-wrap { position: relative; flex: 1; min-width: 200px; }
    .filter-bar .input-wrap i { position: absolute; left: .85rem; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: .9rem; }
    .filter-bar input { width: 100%; padding: .55rem .85rem .55rem 2.25rem; border: 2px solid #e5e7eb; border-radius: .65rem; font-size: .875rem; font-family: inherit; color: #111827; background: #fafafa; outline: none; transition: border-color .2s; box-sizing: border-box; }
    .filter-bar input:focus { border-color: #a78bfa; box-shadow: 0 0 0 3px rgba(167,139,250,.12); }
    .filter-bar select { padding: .55rem .85rem; border: 2px solid #e5e7eb; border-radius: .65rem; font-size: .875rem; font-family: inherit; color: #374151; background: #fafafa; outline: none; cursor: pointer; transition: border-color .2s; }
    .filter-bar select:focus { border-color: #a78bfa; }
    .layout-btn-group { display: flex; border: 2px solid #e5e7eb; border-radius: .65rem; overflow: hidden; }
    .layout-toggle { padding: .5rem .75rem; border: none; background: white; color: #9ca3af; cursor: pointer; font-size: .9rem; transition: all .2s; }
    .layout-toggle.active { background: #f5f3ff; color: #7c3aed; }
    .layout-toggle:hover:not(.active) { background: #fafafa; }
    /* List view */
    .list-view .activity-card { border-radius: .875rem; padding: 1rem 1.5rem; margin-bottom: .65rem; display: flex; flex-direction: row; align-items: center; gap: 1.5rem; min-height: 80px; height: auto; }
    .list-view .activity-card::before { border-radius: .875rem 0 0 .875rem; }
    .list-view .row { display: block; }
    .list-view .col-md-6, .list-view .col-lg-4 { width: 100%; max-width: 100%; }
    .list-view .activity-header { flex: 0 0 260px; margin-bottom: 0; }
    .list-view .activity-badges { flex: 0 0 auto; margin-bottom: 0; }
    .list-view .activity-times  { flex: 1; margin-bottom: 0; display: flex; gap: 1.5rem; flex-wrap: wrap; }
    .list-view .activity-actions-row { flex: 0 0 auto; border: none; padding: 0; }
    /* Empty */
    .empty-state { text-align: center; padding: 4rem 2rem; background: white; border: 2px dashed #e9d5ff; border-radius: 1.25rem; }
    .empty-icon { width: 80px; height: 80px; background: linear-gradient(135deg,#f5f3ff,#ede9fe); border-radius: 1.25rem; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; color: var(--pur); margin: 0 auto 1.5rem; box-shadow: 0 8px 24px rgba(147,51,234,.15); }
    /* Toast */
    .toast-container { position: fixed; top: 100px; right: 20px; z-index: 9999; }
    .toast-custom { border-radius: 1rem; box-shadow: 0 10px 40px rgba(0,0,0,.15); min-width: 300px; }
    /* Modal */
    .modal-content { border-radius: 1.25rem; border: none; overflow: hidden; }
    .modal-header { background: linear-gradient(135deg,#7c3aed,#6d28d9); color: white; border: none; padding: 1.25rem 1.5rem; }
    .modal-title { font-weight: 700; font-size: 1rem; }
    .btn-close-white { filter: brightness(0) invert(1); }
</style>
{% endblock %}

{% block body %}

{# ── Hero ── #}
<div class="routine-hero">
    <div class="container">
        <a href="{{ path('app_routine_index', {goalId: routine.goal.id}) }}" class="hero-back">
            <i class="bi bi-arrow-left"></i> {{ routine.goal.title }}
        </a>
        <p class="hero-eyebrow"><i class="bi bi-arrow-repeat me-1"></i>Routine</p>
        <h1 class="hero-title">{{ routine.title }}</h1>
        {% if routine.description %}
            <p class="hero-desc">{{ routine.description }}</p>
        {% endif %}
        <div class="hero-chips">
            <div class="hero-chip">
                <i class="bi bi-list-task"></i>
                {{ activities|length }} activité{{ activities|length != 1 ? 's' : '' }}
            </div>
            {% set completedAct = activities|filter(a => a.status == 'completed')|length %}
            {% if completedAct > 0 %}
            <div class="hero-chip">
                <i class="bi bi-check-circle"></i>
                {{ completedAct }} terminée{{ completedAct != 1 ? 's' : '' }}
            </div>
            {% endif %}
            <div class="hero-chip">
                <i class="bi bi-eye{{ routine.visibility == 'private' ? '-slash' : '' }}"></i>
                {{ routine.visibility|upper }}
            </div>
            {% if routine.getPriority() %}
            <div class="hero-chip">
                <i class="bi bi-flag"></i>
                Priorité {{ routine.getPriority() == 'high' ? 'haute' : (routine.getPriority() == 'medium' ? 'moyenne' : 'basse') }}
            </div>
            {% endif %}
            {% if routine.deadline %}
            <div class="hero-chip">
                <i class="bi bi-calendar-event"></i>
                {{ routine.deadline|date('d/m/Y') }}
            </div>
            {% endif %}
            {% if routine.isDeadlineNear() %}
            <div class="hero-chip warning">
                <i class="bi bi-alarm"></i> Deadline proche !
            </div>
            {% endif %}
        </div>
        <div class="hero-actions">
            <button id="newActivityBtn" class="btn-hero-primary">
                <i class="bi bi-plus-circle"></i> Nouvelle activité
            </button>
            <button id="editRoutineBtn" class="btn-hero-ghost">
                <i class="bi bi-pencil"></i> Modifier
            </button>
            <button id="duplicateRoutineBtn" class="btn-hero-ghost"
                    data-csrf-token="{{ csrf_token('duplicate' ~ routine.id) }}">
                <i class="bi bi-files"></i> Dupliquer
            </button>
            <button id="deleteRoutineBtn" class="btn-hero-danger">
                <i class="bi bi-trash"></i> Supprimer
            </button>
        </div>
    </div>
</div>

{# ── Content ── #}
<div class="routine-content">
    <div class="container">

        {# Analytics #}
        <div class="section-header mb-4">
            <h2 class="section-title"><i class="bi bi-bar-chart-line-fill"></i> Analytique</h2>
        </div>
        <div class="row g-4 mb-5">
            <div class="col-md-7">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div class="ch-icon"><i class="bi bi-bar-chart-fill"></i></div>
                        <div>
                            <h3>Activités hebdomadaires</h3>
                            <p>Planifiées vs terminées par jour de la semaine</p>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        {{ render_chart(weeklyChart) }}
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="chart-card">
                    <div class="chart-card-header">
                        <div class="ch-icon"><i class="bi bi-hourglass-split"></i></div>
                        <div>
                            <h3>Investissement en temps</h3>
                            <p>Temps planifié vs temps réellement passé</p>
                        </div>
                    </div>
                    <div class="chart-card-body">
                        {{ render_chart(timeChart) }}
                    </div>
                </div>
            </div>
        </div>

        {# Activities header #}
        <div class="section-header">
            <h2 class="section-title">
                <i class="bi bi-list-check"></i>
                Activités
                <span style="background:#f5f3ff;color:var(--pur);border-radius:50px;padding:.1rem .6rem;font-size:.8rem;">{{ activities|length }}</span>
            </h2>
        </div>

        {# Filter bar #}
        <div class="filter-bar">
            <div class="input-wrap">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="Rechercher une activité…" value="{{ searchQuery }}">
            </div>
            <select id="sortSelect">
                <option value="startTime-ASC"  {{ currentSort == 'startTime' and currentOrder == 'ASC'  ? 'selected' : '' }}>Date début (ancien)</option>
                <option value="startTime-DESC" {{ currentSort == 'startTime' and currentOrder == 'DESC' ? 'selected' : '' }}>Date début (récent)</option>
                <option value="title-ASC"      {{ currentSort == 'title'     and currentOrder == 'ASC'  ? 'selected' : '' }}>Titre A-Z</option>
                <option value="title-DESC"     {{ currentSort == 'title'     and currentOrder == 'DESC' ? 'selected' : '' }}>Titre Z-A</option>
                <option value="duration-ASC"   {{ currentSort == 'duration'  and currentOrder == 'ASC'  ? 'selected' : '' }}>Durée courte</option>
                <option value="duration-DESC"  {{ currentSort == 'duration'  and currentOrder == 'DESC' ? 'selected' : '' }}>Durée longue</option>
            </select>
            <select id="statusFilter">
                <option value="all"         {{ currentStatus == 'all'         ? 'selected' : '' }}>Tous les statuts</option>
                <option value="pending"     {{ currentStatus == 'pending'     ? 'selected' : '' }}>En attente</option>
                <option value="in_progress" {{ currentStatus == 'in_progress' ? 'selected' : '' }}>En cours</option>
                <option value="completed"   {{ currentStatus == 'completed'   ? 'selected' : '' }}>Terminé</option>
                <option value="skipped"     {{ currentStatus == 'skipped'     ? 'selected' : '' }}>Ignoré</option>
                <option value="cancelled"   {{ currentStatus == 'cancelled'   ? 'selected' : '' }}>Annulé</option>
            </select>
            <div class="layout-btn-group">
                <button class="layout-toggle" data-layout="list" title="Vue liste"><i class="bi bi-list-ul"></i></button>
                <button class="layout-toggle active" data-layout="grid" title="Vue grille"><i class="bi bi-grid-3x3-gap"></i></button>
            </div>
        </div>

        {% if activities|length > 0 %}
            <div class="row g-3" id="activitiesContainer">
                {% for activity in activities %}
                    <div class="col-md-6 col-lg-4">
                        <div class="activity-card clickable-activity-card" data-activity-id="{{ activity.id }}">
                            <div class="activity-header">
                                <div class="activity-title">
                                    <span>{{ activity.title }}</span>
                                    {% if activity.hasReminder %}
                                        <i class="bi bi-bell-fill text-warning" style="font-size:.9rem;flex-shrink:0;"></i>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="activity-badges">
                                {% if activity.getPriority() %}
                                    <span class="a-badge ab-prio-{{ activity.getPriority() }}">
                                        {{ activity.getPriority() == 'high' ? 'Haute' : (activity.getPriority() == 'medium' ? 'Moyenne' : 'Basse') }}
                                    </span>
                                {% endif %}
                                {% if activity.isDeadlineNear() %}
                                    <span class="a-badge ab-deadline"><i class="bi bi-alarm me-1"></i>Deadline proche</span>
                                {% endif %}
                            </div>
                            <div class="activity-times">
                                <div class="time-row">
                                    <i class="bi bi-clock"></i>
                                    Début : {{ activity.startTime|date('d/m/Y H:i') }}
                                </div>
                                <div class="time-row">
                                    <i class="bi bi-hourglass-split"></i>
                                    Durée : {{ activity.duration|date('H:i') }}
                                </div>
                                {% if activity.deadline %}
                                    <div class="time-row">
                                        <i class="bi bi-calendar-event"></i>
                                        Deadline : {{ activity.deadline|date('d/m/Y H:i') }}
                                    </div>
                                {% endif %}
                            </div>
                            <span class="status-badge status-{{ activity.status|lower|replace({'_': '-'}) }}">{{ activity.status|upper }}</span>
                            <div class="activity-actions-row" onclick="event.stopPropagation();">
                                <button class="act-btn act-btn-edit edit-activity-btn" data-activity-id="{{ activity.id }}">
                                    <i class="bi bi-pencil"></i> Modifier
                                </button>
                                <button class="act-btn act-btn-del delete-activity-btn"
                                        data-activity-id="{{ activity.id }}"
                                        data-activity-title="{{ activity.title }}">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <input type="hidden" name="csrf_token_activity_{{ activity.id }}" value="{{ csrf_token('delete' ~ activity.id) }}">
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-icon"><i class="bi bi-list-check"></i></div>
                <h3 style="font-weight:800;color:#111827;margin-bottom:.5rem;">Aucune activité</h3>
                <p style="color:#6b7280;margin-bottom:1.5rem;">Créez votre première activité pour cette routine.</p>
                <button id="newActivityBtnEmpty" class="btn-hero-primary" style="display:inline-flex;">
                    <i class="bi bi-plus-circle"></i> Créer une activité
                </button>
            </div>
        {% endif %}
    </div>
</div>

{# ── Toast ── #}
<div class="toast-container">
    <div id="toast" class="toast toast-custom" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header d-flex align-items-center">
            <div id="toastIcon" class="rounded me-2" style="width:20px;height:20px;"></div>
            <strong class="me-auto">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

{# ── Modals ── #}
<div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="activityModalTitle">Nouvelle Activité</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="activityModalContent"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="routineModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="routineModalTitle">Modifier la Routine</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="routineModalContent"></div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteActivityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Supprimer l'activité</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p style="color:#374151;margin-bottom:1rem;">Supprimer cette activité définitivement ?</p>
                <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:.75rem;padding:.875rem 1rem;font-size:.875rem;">
                    <i class="bi bi-info-circle me-2" style="color:#d97706;"></i>
                    <strong id="deleteActivityName" style="color:#92400e;"></strong>
                    <p class="mb-0 mt-1 small" style="color:#78350f;">Cette action est irréversible.</p>
                </div>
            </div>
            <div class="modal-footer" style="border-top:1px solid #e5e7eb;padding:1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius:.65rem;font-weight:600;border:none;background:#6b7280;">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteActivityBtn" style="border-radius:.65rem;font-weight:600;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 12px rgba(239,68,68,.3);">
                    <i class="bi bi-trash me-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="deleteRoutineModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Supprimer la routine</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p style="color:#374151;margin-bottom:1rem;">Supprimer cette routine et toutes ses activités ?</p>
                <div style="background:#fef3c7;border:1px solid #fde68a;border-radius:.75rem;padding:.875rem 1rem;font-size:.875rem;">
                    <i class="bi bi-info-circle me-2" style="color:#d97706;"></i>
                    <strong id="deleteRoutineName" style="color:#92400e;"></strong>
                    <p class="mb-0 mt-1 small" style="color:#78350f;">Cette action est irréversible.</p>
                </div>
            </div>
            <div class="modal-footer" style="border-top:1px solid #e5e7eb;padding:1rem 1.5rem;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius:.65rem;font-weight:600;border:none;background:#6b7280;">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteRoutineBtn" style="border-radius:.65rem;font-weight:600;border:none;background:linear-gradient(135deg,#ef4444,#dc2626);box-shadow:0 4px 12px rgba(239,68,68,.3);">
                    <i class="bi bi-trash me-1"></i>Supprimer
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const activityModal = new bootstrap.Modal(document.getElementById('activityModal'));
        const modalContent = document.getElementById('activityModalContent');
        const modalTitle = document.getElementById('activityModalTitle');
        const newActivityBtn = document.getElementById('newActivityBtn');
        const newActivityBtnEmpty = document.getElementById('newActivityBtnEmpty');

        function openModal(title, url) {
            modalTitle.textContent = title;
            modalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border" role="status" style="color:#9333ea;"><span class="visually-hidden">Chargement…</span></div></div>';
            activityModal.show();
            document.body.style.overflow = 'hidden';
            fetch(url).then(r => r.text()).then(html => { modalContent.innerHTML = html; initForm(); })
                .catch(() => { modalContent.innerHTML = '<div class="alert alert-danger m-3">Erreur lors du chargement.</div>'; });
        }
        function closeModal() { activityModal.hide(); modalContent.innerHTML = ''; document.body.style.overflow = ''; }
        function initForm() {
            const form = modalContent.querySelector('form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault(); e.stopPropagation();
                const formData = new FormData(form);
                const csrfToken = formData.get('activity[_token]') || form.querySelector('input[name*="_token"]')?.value;
                if (!csrfToken) { showToast('Erreur: Token CSRF manquant.', 'error'); return; }
                const submitBtn = form.querySelector('button[type="submit"]');
                const originalText = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement…'; }
                try {
                    const formAction = form.action || '{{ path('app_activity_new', {routineId: routine.id}) }}';
                    const formMethod = form.method || 'POST';
                    const response = await fetch(formAction, { method: formMethod, headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }, body: formData });
                    const ct = response.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) throw new Error('Réponse inattendue du serveur.');
                    const data = await response.json();
                    if (data.success) { showToast(data.message, 'success'); closeModal(); setTimeout(() => location.reload(), 1000); }
                    else { if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = originalText; } showToast(data.message || 'Erreur de validation', 'error'); if (data.errors) displayFormErrors(form, data.errors); }
                } catch (err) { if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = originalText; } showToast('Erreur: ' + err.message, 'error'); }
            });
        }
        function displayFormErrors(form, errors) {
            form.querySelectorAll('.invalid-feedback').forEach(el => el.remove());
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            form.querySelectorAll('.alert-danger').forEach(el => el.remove());
            if (!errors || !errors.length) return;
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.innerHTML = '<strong>Erreurs:</strong><ul class="mb-0 mt-2"><li>' + errors.join('</li><li>') + '</li></ul>';
            form.insertBefore(alertDiv, form.firstChild);
        }
        function showToast(message, type = 'success') {
            const toastMsg = document.getElementById('toastMessage');
            const toastIcon = document.getElementById('toastIcon');
            const toastEl = document.getElementById('toast');
            const toast = new bootstrap.Toast(toastEl);
            toastMsg.textContent = message;
            if (type === 'success') { toastIcon.innerHTML = '<i class="bi bi-check-circle-fill text-success"></i>'; toastIcon.className = 'rounded me-2 bg-success'; }
            else { toastIcon.innerHTML = '<i class="bi bi-x-circle-fill text-danger"></i>'; toastIcon.className = 'rounded me-2 bg-danger'; }
            toast.show();
        }
        document.getElementById('activityModal').addEventListener('hidden.bs.modal', () => { document.body.style.overflow = ''; });
        if (newActivityBtn) newActivityBtn.addEventListener('click', () => openModal('Nouvelle Activité', '{{ path('app_activity_new', {routineId: routine.id}) }}'));
        if (newActivityBtnEmpty) newActivityBtnEmpty.addEventListener('click', () => openModal('Nouvelle Activité', '{{ path('app_activity_new', {routineId: routine.id}) }}'));

        // Filters
        const sortSelect = document.getElementById('sortSelect');
        const statusFilter = document.getElementById('statusFilter');
        const searchInput = document.getElementById('searchInput');
        let searchTimeout;
        function applyFilters() {
            const sortValue = sortSelect ? sortSelect.value : 'startTime-ASC';
            const statusValue = statusFilter ? statusFilter.value : 'all';
            const searchValue = searchInput ? searchInput.value : '';
            const [sort, order] = sortValue.split('-');
            const url = new URL(window.location.href);
            url.searchParams.set('sort', sort); url.searchParams.set('order', order); url.searchParams.set('status', statusValue);
            searchValue ? url.searchParams.set('search', searchValue) : url.searchParams.delete('search');
            window.location.href = url.toString();
        }
        if (sortSelect) sortSelect.addEventListener('change', applyFilters);
        if (statusFilter) statusFilter.addEventListener('change', applyFilters);
        if (searchInput) searchInput.addEventListener('input', () => { clearTimeout(searchTimeout); searchTimeout = setTimeout(applyFilters, 500); });

        // Clickable cards
        document.querySelectorAll('.clickable-activity-card').forEach(card => {
            card.addEventListener('click', () => openModal('Modifier l\'Activité', `/routines/{{ routine.id }}/activities/${card.dataset.activityId}/edit`));
        });
        document.querySelectorAll('.edit-activity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); openModal('Modifier l\'Activité', `/routines/{{ routine.id }}/activities/${btn.dataset.activityId}/edit`); });
        });

        // Delete activity
        const deleteActivityModal = new bootstrap.Modal(document.getElementById('deleteActivityModal'));
        const confirmDeleteActivityBtn = document.getElementById('confirmDeleteActivityBtn');
        let currentDeleteActivityAction = null;
        document.querySelectorAll('.delete-activity-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault(); e.stopPropagation();
                const activityId = btn.dataset.activityId;
                const csrfEl = document.querySelector(`input[name="csrf_token_activity_${activityId}"]`);
                const csrfToken = csrfEl ? csrfEl.value : '';
                document.getElementById('deleteActivityName').textContent = btn.dataset.activityTitle;
                currentDeleteActivityAction = async () => {
                    confirmDeleteActivityBtn.disabled = true; confirmDeleteActivityBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Suppression…';
                    try {
                        const resp = await fetch(`/routines/{{ routine.id }}/activities/${activityId}`, { method: 'DELETE', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }, body: `_token=${encodeURIComponent(csrfToken)}` });
                        const data = await resp.json();
                        if (data.success) { showToast(data.message, 'success'); deleteActivityModal.hide(); setTimeout(() => location.reload(), 1000); }
                        else { showToast('Erreur: ' + (data.message || 'Impossible de supprimer'), 'error'); confirmDeleteActivityBtn.disabled = false; confirmDeleteActivityBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
                    } catch (err) { showToast('Erreur: ' + err.message, 'error'); confirmDeleteActivityBtn.disabled = false; confirmDeleteActivityBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
                };
                deleteActivityModal.show();
            });
        });
        confirmDeleteActivityBtn.addEventListener('click', () => { if (currentDeleteActivityAction) currentDeleteActivityAction(); });
        document.getElementById('deleteActivityModal').addEventListener('hidden.bs.modal', () => { confirmDeleteActivityBtn.disabled = false; confirmDeleteActivityBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; currentDeleteActivityAction = null; });

        // Routine modal
        const routineModal = new bootstrap.Modal(document.getElementById('routineModal'));
        const routineModalContent = document.getElementById('routineModalContent');
        const routineModalTitle = document.getElementById('routineModalTitle');
        function openRoutineModal(title, url) {
            routineModalTitle.textContent = title;
            routineModalContent.innerHTML = '<div class="text-center py-5"><div class="spinner-border" style="color:#9333ea;" role="status"></div></div>';
            routineModal.show();
            fetch(url).then(r => r.text()).then(html => { routineModalContent.innerHTML = html; initRoutineForm(); })
                .catch(() => { routineModalContent.innerHTML = '<div class="alert alert-danger m-3">Erreur de chargement.</div>'; });
        }
        function closeRoutineModal() { routineModal.hide(); routineModalContent.innerHTML = ''; document.body.style.overflow = ''; }
        function initRoutineForm() {
            const form = routineModalContent.querySelector('form');
            if (!form) return;
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                const submitBtn = form.querySelector('button[type="submit"]');
                const origText = submitBtn ? submitBtn.innerHTML : '';
                if (submitBtn) { submitBtn.disabled = true; submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enregistrement…'; }
                try {
                    const resp = await fetch(form.action, { method: form.method || 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' }, body: formData });
                    const ct = resp.headers.get('content-type') || '';
                    if (!ct.includes('application/json')) throw new Error('Réponse inattendue.');
                    const data = await resp.json();
                    if (data.success) { showToast(data.message, 'success'); closeRoutineModal(); setTimeout(() => location.reload(), 1000); }
                    else { if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = origText; } showToast('Erreur: ' + (data.message || 'Validation échouée'), 'error'); }
                } catch (err) { if (submitBtn) { submitBtn.disabled = false; submitBtn.innerHTML = origText; } showToast('Erreur: ' + err.message, 'error'); }
            });
        }
        document.getElementById('routineModal').addEventListener('hidden.bs.modal', () => { document.body.style.overflow = ''; });
        const editRoutineBtn = document.getElementById('editRoutineBtn');
        if (editRoutineBtn) editRoutineBtn.addEventListener('click', () => openRoutineModal('Modifier la Routine', '{{ path('app_routine_edit', {goalId: routine.goal.id, id: routine.id}) }}'));

        // Duplicate routine
        const duplicateRoutineBtn = document.getElementById('duplicateRoutineBtn');
        if (duplicateRoutineBtn) {
            duplicateRoutineBtn.addEventListener('click', async () => {
                if (!confirm('Dupliquer cette routine (avec toutes ses activités) ?')) return;
                duplicateRoutineBtn.disabled = true; const origHtml = duplicateRoutineBtn.innerHTML; duplicateRoutineBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Duplication…';
                try {
                    const resp = await fetch('{{ path('app_routine_duplicate', {goalId: routine.goal.id, id: routine.id}) }}', { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }, body: '_token=' + encodeURIComponent(duplicateRoutineBtn.dataset.csrfToken) });
                    const data = await resp.json();
                    if (data.success) { showToast(data.message, 'success'); setTimeout(() => { window.location.href = '{{ path('app_routine_index', {goalId: routine.goal.id}) }}'; }, 1000); }
                    else { showToast('Erreur: ' + (data.message || 'Impossible de dupliquer'), 'error'); duplicateRoutineBtn.disabled = false; duplicateRoutineBtn.innerHTML = origHtml; }
                } catch (err) { showToast('Erreur: ' + err.message, 'error'); duplicateRoutineBtn.disabled = false; duplicateRoutineBtn.innerHTML = origHtml; }
            });
        }

        // Delete routine
        const deleteRoutineModal = new bootstrap.Modal(document.getElementById('deleteRoutineModal'));
        const confirmDeleteRoutineBtn = document.getElementById('confirmDeleteRoutineBtn');
        const deleteRoutineBtn = document.getElementById('deleteRoutineBtn');
        if (deleteRoutineBtn) {
            deleteRoutineBtn.addEventListener('click', () => { document.getElementById('deleteRoutineName').textContent = '{{ routine.title }}'; deleteRoutineModal.show(); });
        }
        if (confirmDeleteRoutineBtn) {
            confirmDeleteRoutineBtn.addEventListener('click', async () => {
                confirmDeleteRoutineBtn.disabled = true; confirmDeleteRoutineBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Suppression…';
                try {
                    const resp = await fetch('{{ path('app_routine_delete', {goalId: routine.goal.id, id: routine.id}) }}', { method: 'DELETE', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json', 'Content-Type': 'application/x-www-form-urlencoded' }, body: '_token=' + encodeURIComponent('{{ csrf_token('delete' ~ routine.id) }}') });
                    const data = await resp.json();
                    if (data.success) { showToast(data.message, 'success'); deleteRoutineModal.hide(); setTimeout(() => { window.location.href = '{{ path('app_routine_index', {goalId: routine.goal.id}) }}'; }, 1000); }
                    else { showToast('Erreur: ' + (data.message || 'Impossible de supprimer'), 'error'); confirmDeleteRoutineBtn.disabled = false; confirmDeleteRoutineBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
                } catch (err) { showToast('Erreur: ' + err.message, 'error'); confirmDeleteRoutineBtn.disabled = false; confirmDeleteRoutineBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; }
            });
        }
        document.getElementById('deleteRoutineModal').addEventListener('hidden.bs.modal', () => { confirmDeleteRoutineBtn.disabled = false; confirmDeleteRoutineBtn.innerHTML = '<i class="bi bi-trash me-1"></i>Supprimer'; });

        // Layout toggle
        const layoutToggles = document.querySelectorAll('.layout-toggle');
        const activitiesContainer = document.getElementById('activitiesContainer');
        const savedLayout = localStorage.getItem('activitiesLayout') || 'grid';
        if (savedLayout === 'list' && activitiesContainer) {
            activitiesContainer.classList.add('list-view');
            layoutToggles.forEach(btn => btn.classList.toggle('active', btn.dataset.layout === 'list'));
        }
        layoutToggles.forEach(button => {
            button.addEventListener('click', function() {
                const layout = this.dataset.layout;
                layoutToggles.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                if (activitiesContainer) activitiesContainer.classList.toggle('list-view', layout === 'list');
                localStorage.setItem('activitiesLayout', layout);
            });
        });
    });
</script>
{% endblock %}
